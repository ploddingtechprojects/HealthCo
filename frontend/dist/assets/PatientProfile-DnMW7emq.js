import{aG as e,j as r,m as t,r as i,am as a,p as l,T as n,aR as s,a3 as o,aI as d,bv as c,aP as u,bE as h,au as f,bF as p,P as x,ak as m,bG as b,bH as g,bI as y,bJ as j,c as v,f as C,g as N,a8 as S,aM as w,F as I,A as k,bK as P,aq as R,B as z,y as D,ac as A,k as H,bL as O,bM as T,ay as M,az as B,aA as W,af as V,ag as E,ah as L,ai as F,bx as G,ae as U,bN as q,al as $,S as Y,aD as _}from"./index-DyR0ftVW.js";import{V as J,D as K,g as Q,a as X,b as Z,C as ee,G as re}from"./DocumentPreviewDialog-Ck4145Mc.js";import{D as te}from"./DeleteConfirmationDialog-DKqJK7p7.js";import{M as ie}from"./ManagementHeader-ym6m9w7H.js";import{u as ae}from"./useClinicSync-pPWROp7F.js";import{f as le}from"./displayDate-BRGhvOnj.js";import{T as ne}from"./Tooltip-Cof9Jr1h.js";import{G as se,v as oe,h as de,a as ce,S as ue,b as he,D as fe,c as pe}from"./DateOfBirthField-8J2568o0.js";import{u as xe}from"./useProvinces-BxWqgMCH.js";import"./InputAdornment-BBfdgTpM.js";import"./Autocomplete-7SfYvhTE.js";import"./WarningOutlined-Pm6jC2mV.js";import"./AntdIcon-2OxomVw-.js";import"./DialogActions-BmwBtQrJ.js";import"./ListItem-BPokTJtf.js";const me=e(r.jsx("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM19 4h-3.5l-1-1h-5l-1 1H5v2h14z"})),be="https://healthco.clinic/api/fhir/Patient",ge=e=>{if(e.response){const r=e.response.data;throw(null==r?void 0:r.detail)?new Error(r.detail):(null==r?void 0:r.message)?new Error(r.message):e.response.statusText?new Error(e.response.statusText):new Error("An error occurred")}throw e.request?new Error("No response received from server"):e},ye=async(e,r={})=>{try{const{page:i=1,pageSize:a=25,sortBy:l="createdOn",sortOrder:n="desc",search:s=null,filterFullName:o=null,filterEmail:d=null,filterPhone:c=null,filterGender:u=null,filterHealthCardProvinceName:h=null,filterHealthCardProvinceId:f=null,filterIsHealthCardVerified:p=null,filterInsuranceProvider:x=null,filterHealthCardNumber:m=null,filterDateOfBirthFrom:b=null,filterDateOfBirthTo:g=null,filterCreatedOnFrom:y=null,filterCreatedOnTo:j=null}=r,v={clinicId:e,page:i,pageSize:a,sortBy:l,sortOrder:n};s&&(v.search=s),o&&(v.filterFullName=o),d&&(v.filterEmail=d),c&&(v.filterPhone=c),null!=u&&(v.filterGender=u),m&&(v.filterHealthCardNumber=m),h&&(v.filterHealthCardProvinceName=h),f&&(v.filterHealthCardProvinceId=f),null!=p&&(v.filterIsHealthCardVerified=p),x&&(v.filterInsuranceProvider=x),b&&(v.filterDateOfBirthFrom=b),g&&(v.filterDateOfBirthTo=g),y&&(v.filterCreatedOnFrom=y),j&&(v.filterCreatedOnTo=j);return(await t.get(`${be}`,{params:v})).data}catch(i){return ge(i)}},je=async e=>{try{return(await t.post(`${be}`,e)).data}catch(r){return ge(r)}},ve=async e=>{try{return(await t.get(`${be}/${e}`)).data}catch(r){return ge(r)}},Ce=async(e,r)=>{try{return(await t.put(`${be}/${e}`,r)).data}catch(i){return ge(i)}},Ne=async e=>{try{return(await t.delete(`${be}/${e}`)).data}catch(r){return ge(r)}},Se=async e=>{try{return(await t.get(`${be}/getAppointments/${e}`)).data}catch(r){return ge(r)}},we=async(e,r={})=>{try{const{dateFrom:i=null,dateTo:a=null,activityType:l=null,appointmentId:n=null,page:s=1,pageSize:o=50}=r,d={page:s,pageSize:o};i&&(d.dateFrom=i),a&&(d.dateTo=a),null!=l&&(d.activityType=l),null!=n&&(d.appointmentId=n);return(await t.get(`${be}/${e}/activity-logs`,{params:d})).data}catch(i){return ge(i)}},Ie=({open:e,onClose:t,activityLogs:x,patientName:m})=>{const[b,g]=i.useState(null),y=(null==x?void 0:x.find(e=>e.activityLogId===b))||(null==x?void 0:x[0]),j=e=>{if(!e)return"N/A";return new Date(e).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"})},v=e=>{if(!e)return null;return new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})};return r.jsx(a,{open:e,onClose:t,title:`Activity Log - ${m}`,maxWidth:"lg",showActions:!1,customWidth:"min(1200px, 95vw)",children:r.jsx(l,{sx:{display:"flex",height:"600px",mt:1},children:x&&0!==x.length?r.jsxs(r.Fragment,{children:[r.jsx(l,{sx:{width:"380px",borderRight:"1px solid #e5e7eb",overflowY:"auto",pr:2,"&::-webkit-scrollbar":{width:"6px"},"&::-webkit-scrollbar-track":{background:"#f1f5f9"},"&::-webkit-scrollbar-thumb":{background:"#cbd5e1",borderRadius:"3px"}},children:r.jsxs(l,{sx:{position:"relative"},children:[r.jsx(l,{sx:{position:"absolute",left:"23px",top:"24px",bottom:"0",width:"2px",backgroundColor:"#e5e7eb"}}),x.map((e,t)=>{const i=(a=e.activityTypeDisplay,{ProfileCreated:s,ProfileUpdated:s,General:h,AppointmentBooked:p,AppointmentCancelled:h,AppointmentCompleted:p,AppointmentRescheduled:d,DocumentUploaded:f,DocumentDeleted:f,MedicalHistoryUpdated:f,InsuranceUpdated:f,HealthCardVerified:p,Other:h}[a]||h);var a;const o=(e=>({ProfileCreated:"#10b981",ProfileUpdated:"#3b82f6",General:"#6b7280",AppointmentBooked:"#10b981",AppointmentCancelled:"#ef4444",AppointmentCompleted:"#8b5cf6",AppointmentRescheduled:"#f59e0b",DocumentUploaded:"#3b82f6",DocumentDeleted:"#ef4444",MedicalHistoryUpdated:"#3b82f6",InsuranceUpdated:"#3b82f6",HealthCardVerified:"#10b981",Other:"#6b7280"}[e]||"#6b7280"))(e.activityTypeDisplay),c=(null==y?void 0:y.activityLogId)===e.activityLogId,u=(m=e,!(b=x[t-1])||v(m.timestamp)!==v(b.timestamp));var m,b;return r.jsxs(l,{children:[u&&r.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1.5,mb:2,mt:0===t?0:2},children:[r.jsx(l,{sx:{flex:1,height:"1px",backgroundColor:"#d1d5db"}}),r.jsx(n,{variant:"caption",sx:{color:"#6b7280",fontWeight:600,fontSize:"0.75rem",textTransform:"uppercase",letterSpacing:"0.05em",whiteSpace:"nowrap"},children:v(e.timestamp)}),r.jsx(l,{sx:{flex:1,height:"1px",backgroundColor:"#d1d5db"}})]}),r.jsxs(l,{onClick:()=>g(e.activityLogId),sx:{position:"relative",mb:2,cursor:"pointer",pl:6,transition:"all 0.2s ease"},children:[r.jsx(l,{sx:{position:"absolute",left:0,top:0,width:"46px",height:"46px",borderRadius:"50%",backgroundColor:c?o:"#ffffff",border:`2px solid ${o}`,display:"flex",alignItems:"center",justifyContent:"center",zIndex:1,transition:"all 0.2s ease"},children:r.jsx(i,{size:20,color:c?"#ffffff":o})}),r.jsxs(l,{sx:{backgroundColor:c?"#f0f9ff":"#ffffff",border:"1px solid",borderColor:c?"#3b82f6":"#e5e7eb",borderRadius:"12px",p:1.5,transition:"all 0.2s ease","&:hover":{borderColor:"#3b82f6",backgroundColor:"#f8fafc"}},children:[r.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[r.jsx(n,{variant:"body2",sx:{fontWeight:600,fontSize:"0.875rem"},children:j(e.timestamp)}),r.jsx(n,{variant:"body2",sx:{color:"#6b7280",fontSize:"0.875rem"},children:e.activityTypeDisplay})]}),r.jsx(n,{variant:"body2",sx:{color:"#374151",fontSize:"0.875rem",lineHeight:1.4,mb:.5},children:e.action||"N/A"}),r.jsxs(n,{variant:"caption",sx:{color:"#9ca3af",fontSize:"0.75rem",display:"flex",alignItems:"center",gap:.5},children:[r.jsx(s,{size:12}),e.performedBy||"System"]})]})]})]},e.activityLogId)})]})}),r.jsx(l,{sx:{flex:1,pl:3,overflowY:"auto","&::-webkit-scrollbar":{width:"6px"},"&::-webkit-scrollbar-track":{background:"#f1f5f9"},"&::-webkit-scrollbar-thumb":{background:"#cbd5e1",borderRadius:"3px"}},children:y?r.jsxs(l,{children:[r.jsxs(l,{sx:{mb:3},children:[r.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:2,mb:2},children:[r.jsx(o,{label:y.activityTypeDisplay,color:(C=y.activityTypeDisplay,{ProfileCreated:"success",ProfileUpdated:"info",General:"info",AppointmentBooked:"primary",AppointmentCancelled:"error",AppointmentCompleted:"success",AppointmentRescheduled:"warning",DocumentUploaded:"info",DocumentDeleted:"error",MedicalHistoryUpdated:"info",InsuranceUpdated:"info",HealthCardVerified:"success",Other:"default"}[C]||"default")}),r.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1},children:[r.jsx(d,{size:16,color:"#6b7280"}),r.jsx(n,{variant:"body2",color:"text.secondary",children:(e=>{if(!e)return"N/A";return new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})})(y.timestamp)}),r.jsx(n,{variant:"body2",color:"text.secondary",sx:{mx:1},children:"â€¢"}),r.jsx(c,{size:16,color:"#6b7280"}),r.jsx(n,{variant:"body2",color:"text.secondary",children:j(y.timestamp)})]})]}),r.jsx(n,{variant:"h6",sx:{fontWeight:600,color:"#111827"},children:y.action||"Activity Details"})]}),r.jsx(u,{sx:{mb:3}}),r.jsxs(l,{sx:{display:"flex",flexDirection:"column",gap:3},children:[r.jsxs(l,{children:[r.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1,mb:1.5},children:[r.jsx(l,{sx:{width:"32px",height:"32px",borderRadius:"50%",backgroundColor:"#eff6ff",display:"flex",alignItems:"center",justifyContent:"center"},children:r.jsx(s,{size:16,color:"#3b82f6"})}),r.jsx(n,{variant:"body1",sx:{fontWeight:600,color:"#374151"},children:"Performed By"})]}),r.jsx(l,{sx:{backgroundColor:"#f9fafb",p:2,borderRadius:"8px",border:"1px solid #e5e7eb"},children:r.jsx(n,{variant:"body1",sx:{color:"#111827"},children:y.performedBy||"System"})})]}),r.jsxs(l,{children:[r.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1,mb:1.5},children:[r.jsx(l,{sx:{width:"32px",height:"32px",borderRadius:"50%",backgroundColor:"#eff6ff",display:"flex",alignItems:"center",justifyContent:"center"},children:r.jsx(h,{size:16,color:"#3b82f6"})}),r.jsx(n,{variant:"body1",sx:{fontWeight:600,color:"#374151"},children:"Action Details"})]}),r.jsx(l,{sx:{backgroundColor:"#f9fafb",p:2,borderRadius:"8px",border:"1px solid #e5e7eb"},children:r.jsx(n,{variant:"body1",sx:{color:"#111827"},children:y.action||"N/A"})})]}),y.description&&r.jsxs(l,{children:[r.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1,mb:1.5},children:[r.jsx(l,{sx:{width:"32px",height:"32px",borderRadius:"50%",backgroundColor:"#eff6ff",display:"flex",alignItems:"center",justifyContent:"center"},children:r.jsx(f,{size:16,color:"#3b82f6"})}),r.jsx(n,{variant:"body1",sx:{fontWeight:600,color:"#374151"},children:"Description"})]}),r.jsx(l,{sx:{backgroundColor:"#f9fafb",p:2,borderRadius:"8px",border:"1px solid #e5e7eb"},children:r.jsx(n,{variant:"body1",sx:{color:"#111827",whiteSpace:"pre-wrap",lineHeight:1.6},children:y.description})})]})]})]}):r.jsx(l,{sx:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%"},children:r.jsx(n,{variant:"body1",color:"text.secondary",children:"Select an activity to view details"})})})]}):r.jsx(l,{sx:{py:4,textAlign:"center",width:"100%"},children:r.jsx(n,{variant:"body1",color:"text.secondary",children:"No activity logs found."})})})});var C};Ie.propTypes={open:x.bool.isRequired,onClose:x.func.isRequired,activityLogs:x.array,patientName:x.string};const ke=({open:e,onClose:t,appointments:u,patientName:p})=>{const[x,v]=i.useState(null),[C,N]=i.useState({open:!1,patientDocumentId:null}),S=e=>{if(!e)return"N/A";return new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})},w=e=>{if(!e)return"N/A";const[r,t]=e.split(":"),i=parseInt(r,10);return`${i%12||12}:${t} ${i>=12?"PM":"AM"}`};return r.jsxs(a,{open:e,onClose:t,title:`Appointment History - ${p}`,maxWidth:"md",showActions:!1,customWidth:"min(900px, 95vw)",children:[r.jsx(l,{sx:{mt:1},children:u&&0!==u.length?r.jsx(l,{sx:{display:"flex",flexDirection:"column",gap:1.5},children:u.map(e=>{return r.jsxs(l,{sx:{border:"1px solid",borderColor:x===e.appointmentId?"#3b82f6":"#e5e7eb",borderRadius:"8px",overflow:"hidden",transition:"all 0.2s ease","&:hover":{borderColor:"#3b82f6",boxShadow:"0 2px 8px rgba(59, 130, 246, 0.1)"}},children:[r.jsxs(l,{onClick:()=>{return r=e.appointmentId,void v(x===r?null:r);var r},sx:{display:"flex",alignItems:"center",justifyContent:"space-between",p:2,cursor:"pointer",backgroundColor:x===e.appointmentId?"#f8fafc":"#ffffff",transition:"background-color 0.2s ease","&:hover":{backgroundColor:"#f8fafc"}},children:[r.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:2,flexWrap:"wrap",flex:1},children:[r.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:.5},children:[r.jsx(d,{size:16,color:"#6b7280"}),r.jsx(n,{variant:"body2",sx:{fontSize:"0.875rem"},children:S(e.appointmentDate)})]}),r.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:.5},children:[r.jsx(s,{size:16,color:"#6b7280"}),r.jsx(n,{variant:"body2",sx:{fontSize:"0.875rem"},children:e.technicianName})]}),r.jsx(o,{label:e.status,color:(t=e.status,{Booked:"primary",Completed:"success",Cancelled:"error","No Show":"warning",Rescheduled:"info"}[t]||"default"),size:"small"})]}),r.jsx(m,{size:"small",sx:{color:"#6b7280"},children:x===e.appointmentId?r.jsx(b,{size:20}):r.jsx(g,{size:20})})]}),r.jsx(y,{in:x===e.appointmentId,children:r.jsxs(l,{sx:{p:2,pt:0,backgroundColor:"#f8fafc"},children:[r.jsxs(l,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",sm:"repeat(2, 1fr)"},gap:2,mb:2},children:[r.jsxs(l,{sx:{backgroundColor:"#ffffff",p:1.5,borderRadius:"6px",border:"1px solid #e5e7eb"},children:[r.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:.5,mb:1},children:[r.jsx(j,{size:16,color:"#3b82f6"}),r.jsx(n,{variant:"body2",color:"text.secondary",sx:{fontWeight:600},children:"Clinic"})]}),r.jsx(n,{variant:"body2",children:e.clinicName})]}),r.jsxs(l,{sx:{backgroundColor:"#ffffff",p:1.5,borderRadius:"6px",border:"1px solid #e5e7eb"},children:[r.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:.5,mb:1},children:[r.jsx(c,{size:16,color:"#3b82f6"}),r.jsx(n,{variant:"body2",color:"text.secondary",sx:{fontWeight:600},children:"Time"})]}),r.jsxs(n,{variant:"body2",children:[w(e.startTime)," - ",w(e.endTime)]})]})]}),e.scans&&e.scans.length>0&&r.jsxs(l,{sx:{backgroundColor:"#ffffff",p:1.5,borderRadius:"6px",border:"1px solid #e5e7eb",mb:2},children:[r.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:.5,mb:1},children:[r.jsx(h,{size:16,color:"#3b82f6"}),r.jsxs(n,{variant:"body2",color:"text.secondary",sx:{fontWeight:600},children:["Scans (",e.scans.length,")"]})]}),r.jsx(l,{sx:{display:"flex",flexDirection:"column",gap:1},children:e.scans.map((e,t)=>r.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",p:1,backgroundColor:"#f9fafb",borderRadius:"4px"},children:[r.jsxs(l,{children:[r.jsx(n,{variant:"body2",sx:{fontWeight:500},children:e.scanTypeName}),r.jsx(n,{variant:"caption",color:"text.secondary",children:e.serviceName})]}),r.jsx(o,{label:`${e.durationMinutes} min`,size:"small",variant:"outlined"})]},t))})]}),e.scanResponses&&e.scanResponses.length>0&&r.jsxs(l,{sx:{backgroundColor:"#ffffff",p:1.5,borderRadius:"6px",border:"1px solid #e5e7eb",mb:2},children:[r.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:.5,mb:1},children:[r.jsx(f,{size:16,color:"#3b82f6"}),r.jsxs(n,{variant:"body2",color:"text.secondary",sx:{fontWeight:600},children:["Scan Questionnaire (",e.scanResponses.length,")"]})]}),r.jsx(l,{sx:{display:"flex",flexDirection:"column",gap:1},children:e.scanResponses.map((e,t)=>r.jsxs(l,{sx:{p:1.5,backgroundColor:"#f9fafb",borderRadius:"4px",borderLeft:"3px solid #3b82f6"},children:[r.jsx(n,{variant:"caption",color:"text.secondary",sx:{fontWeight:600,display:"block",mb:.5},children:e.scanTypeName}),r.jsx(n,{variant:"body2",sx:{fontWeight:500,mb:.5},children:e.question}),r.jsx(n,{variant:"body2",sx:{color:"#059669",fontWeight:500},children:e.response})]},t))})]}),(e.notes||e.reasonForVisit)&&r.jsxs(l,{sx:{backgroundColor:"#ffffff",p:1.5,borderRadius:"6px",border:"1px solid #e5e7eb",mb:2},children:[r.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:.5,mb:1},children:[r.jsx(f,{size:16,color:"#3b82f6"}),r.jsx(n,{variant:"body2",color:"text.secondary",sx:{fontWeight:600},children:"Notes & Reason"})]}),e.reasonForVisit&&r.jsxs(l,{sx:{mb:1},children:[r.jsx(n,{variant:"caption",color:"text.secondary",sx:{fontWeight:600},children:"Reason for Visit:"}),r.jsx(n,{variant:"body2",children:e.reasonForVisit})]}),e.notes&&r.jsxs(l,{children:[r.jsx(n,{variant:"caption",color:"text.secondary",sx:{fontWeight:600},children:"Notes:"}),r.jsx(n,{variant:"body2",children:e.notes})]})]}),e.cancellationReason&&r.jsxs(l,{sx:{backgroundColor:"#fef2f2",p:1.5,borderRadius:"6px",border:"1px solid #fecaca",mb:2},children:[r.jsx(n,{variant:"caption",color:"error",sx:{fontWeight:600},children:"Cancellation Reason:"}),r.jsx(n,{variant:"body2",color:"error",children:e.cancellationReason})]}),e.documents&&e.documents.length>0&&r.jsxs(l,{sx:{backgroundColor:"#ffffff",p:1.5,borderRadius:"6px",border:"1px solid #e5e7eb"},children:[r.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1},children:[r.jsxs(n,{variant:"body2",color:"text.secondary",sx:{fontWeight:600},children:["Documents (",e.documents.length,")"]}),r.jsx(ne,{title:"Preview Requisition Sheet",children:r.jsx(m,{size:"small",sx:{color:"#3b82f6"},onClick:()=>(e=>{if(!e.documents||0===e.documents.length)return;const r=e.documents[0];N({open:!0,patientDocumentId:r.patientDocumentId})})(e),children:r.jsx(J,{fontSize:"small"})})})]}),r.jsx(l,{sx:{display:"flex",flexDirection:"column",gap:.5},children:e.documents.map(e=>r.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",p:1,backgroundColor:"#f9fafb",borderRadius:"4px"},children:[r.jsx(n,{variant:"body2",children:e.description||e.fileName}),r.jsx(n,{variant:"caption",color:"text.secondary",children:e.fileType})]},e.patientDocumentId))})]}),e.isRescheduled&&e.previousAppointmentId&&r.jsx(l,{sx:{mt:2,p:1,backgroundColor:"#eff6ff",borderRadius:"4px"},children:r.jsxs(n,{variant:"caption",color:"primary",children:["This appointment was rescheduled from appointment #",e.previousAppointmentId]})})]})})]},e.appointmentId);var t})}):r.jsx(l,{sx:{py:4,textAlign:"center"},children:r.jsx(n,{variant:"body1",color:"text.secondary",children:"No appointment history found."})})}),r.jsx(K,{open:C.open,onClose:()=>{N({open:!1,patientDocumentId:null})},patientDocumentId:C.patientDocumentId,patientName:p,title:"Requisition Sheet"})]})};ke.propTypes={open:x.bool.isRequired,onClose:x.func.isRequired,appointments:x.array,patientName:x.string};const Pe=i.forwardRef(({open:e,onClose:t,onSubmit:o,editingPatient:d},c)=>{const[u,h]=i.useState(0),[p,x]=i.useState(!1),[b,g]=i.useState(""),[y,j]=i.useState(1),[$,Y]=i.useState(null),[_,J]=i.useState(!1),{provinces:K,isLoading:Q}=xe(1),X=[{id:"basic",title:"Basic Information",subtitle:"Personal and contact details",icon:s},{id:"medical",title:"Medical Information",subtitle:"Health history and notes",icon:P},{id:"insurance",title:"Insurance Information",subtitle:"Coverage and policy details",icon:R}],[Z,ee]=i.useState({patientId:null,fullName:"",dob:"",gender:se.MALE_ONLY,phone:"",email:"",healthCardNumber:"",healthCardProvince:"",isHealthCardVerified:!1,identifiedAs:0,allergies:"",medicalNotes:"",medicalHistory:[],insuranceProvider:"",policyNumber:"",groupNumber:""});i.useEffect(()=>{var r;if(e){if(d){const e=(null==(r=d.medicalHistory)?void 0:r.map(e=>void 0!==e.entry?{date:e.dateRecorded?e.dateRecorded.split("T")[0]:(new Date).toISOString().split("T")[0],entry:e.entry}:{date:(new Date).toISOString().split("T")[0],entry:e}))||[];ee({patientId:d.patientId||null,fullName:d.fullName||"",dob:d.dateOfBirth?d.dateOfBirth.split("T")[0]:"",gender:void 0!==d.gender&&null!==d.gender&&""!==d.gender?d.gender:se.MALE_ONLY,phone:d.phone||"",email:d.email||"",healthCardNumber:d.healthCardNumber||"",healthCardProvince:d.healthCardProvinceId||"",isHealthCardVerified:(d.healthCardNumber||"").toString().trim().length>0&&!!d.isHealthCardVerified,identifiedAs:d.identifiedAs??0,allergies:d.allergies||"",medicalNotes:d.medicalNotes||"",medicalHistory:e,insuranceProvider:d.insuranceProvider||"",policyNumber:d.policyNumber||"",groupNumber:d.groupNumber||""})}else re();h(0),Y(null)}},[e,d]);const re=()=>{ee({patientId:null,fullName:"",dob:"",gender:se.MALE_ONLY,phone:"",email:"",healthCardNumber:"",healthCardProvince:"",isHealthCardVerified:!1,identifiedAs:0,allergies:"",medicalNotes:"",medicalHistory:[],insuranceProvider:"",policyNumber:"",groupNumber:""}),h(0),g(""),j(1),Y(null)};i.useImperativeHandle(c,()=>({resetForm:re})),i.useEffect(()=>{const r=setTimeout(async()=>{if(!e)return;const r=(Z.healthCardNumber||"").trim(),t=(Z.fullName||"").trim(),i=(Z.phone||"").trim(),a=Z.dob;if(r.length>=10){J(!0);try{const e=await oe({healthCardNumber:r,fullName:t,phone:i,dob:a,email:Z.email,gender:Z.gender,patientId:Z.patientId});e.isValid?Y(null):Y(e.message)}catch(l){}finally{J(!1)}}else if(t.length>=2&&i.length>=10&&a){J(!0);try{const e=await oe({fullName:t,phone:i,dob:a,email:Z.email,gender:Z.gender,healthCardNumber:r,patientId:Z.patientId});e.isValid?Y(null):Y(e.message)}catch(l){}finally{J(!1)}}else Y(null)},800);return()=>clearTimeout(r)},[Z.healthCardNumber,Z.fullName,Z.phone,Z.dob,Z.email,Z.gender,Z.patientId,e]);const te=v({fullName:C().trim().required("Full name is required").min(2,"Name must be at least 2 characters"),dob:ce(),gender:C().required("Gender is required"),phone:S({requiredMessage:"Phone number is required"}),email:N({requiredMessage:"Email is required"}),healthCardNumber:de(),healthCardProvince:C().notRequired()}),ie=v({allergies:C().trim(),medicalNotes:C().trim(),medicalHistory:w()}),ae=v({insuranceProvider:C().trim(),policyNumber:C().trim(),groupNumber:C().trim()}),le=()=>{switch(u){case 0:return te;case 1:return ie;case 2:return ae;default:return null}},me=()=>{u>0&&h(e=>e-1)},be=e=>{if(b.trim()){const r={date:(new Date).toISOString().split("T")[0],entry:b.trim()},t=[...e.values.medicalHistory,r];e.setFieldValue("medicalHistory",t),g("")}else D.error("Please enter a medical history entry")},ge=e=>r.jsxs(l,{sx:{border:"1px solid #e5e7eb",borderRadius:2,p:{xs:2,md:3},background:"linear-gradient(180deg,#ffffff,#f9fafb)"},children:[r.jsx(he,{icon:s,title:"Patient Information",subtitle:"Enter basic information, contact details, and health card information"}),r.jsx(n,{variant:"h6",sx:{mb:2,mt:0,color:"#374151",fontWeight:600,fontSize:"0.95rem"},children:"Basic Information"}),r.jsxs(l,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",md:"repeat(3, 1fr)"},columnGap:{xs:1,md:3},rowGap:{xs:1.5,md:2}},children:[r.jsx(l,{children:r.jsx(A,{label:"Full Name",required:!0,error:e.touched.fullName&&e.errors.fullName,helperText:e.touched.fullName&&e.errors.fullName,children:r.jsx(H,{fullWidth:!0,size:"small",name:"fullName",placeholder:"Enter full name",value:e.values.fullName,onChange:e.handleChange,onBlur:e.handleBlur,sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px"}}})})}),r.jsx(l,{children:r.jsx(A,{label:"Date of Birth",required:!0,error:e.touched.dob&&e.errors.dob,helperText:e.touched.dob&&e.errors.dob,children:r.jsx(fe,{name:"dob",value:e.values.dob||"",onChange:r=>e.setFieldValue("dob",r.target.value),onBlur:e.handleBlur,sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px"}}})})}),r.jsx(l,{children:r.jsx(A,{label:"Gender",required:!0,error:e.touched.gender&&e.errors.gender,helperText:e.touched.gender&&e.errors.gender,children:r.jsxs(H,{select:!0,fullWidth:!0,size:"small",name:"gender",value:e.values.gender,onChange:e.handleChange,onBlur:e.handleBlur,placeholder:"Select gender",sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px"}},children:[r.jsx(U,{value:se.MALE_ONLY,children:pe[se.MALE_ONLY]}),r.jsx(U,{value:se.FEMALE_ONLY,children:pe[se.FEMALE_ONLY]}),r.jsx(U,{value:se.OTHER,children:pe[se.OTHER]})]})})})]}),r.jsx(n,{variant:"h6",sx:{mb:2,mt:3,color:"#374151",fontWeight:600,fontSize:"0.95rem"},children:"Contact Information"}),r.jsxs(l,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",md:"repeat(2, 1fr)"},columnGap:{xs:1,md:3},rowGap:{xs:1.5,md:2}},children:[r.jsx(l,{children:r.jsx(A,{label:"Phone Number",required:!0,error:e.touched.phone&&e.errors.phone,helperText:e.touched.phone&&e.errors.phone,children:r.jsx(H,{fullWidth:!0,size:"small",name:"phone",placeholder:"(123) 456-7890",value:e.values.phone,onChange:e.handleChange,onBlur:e.handleBlur,sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px"}}})})}),r.jsx(l,{children:r.jsx(A,{label:"Email ID",required:!0,error:e.touched.email&&e.errors.email,helperText:e.touched.email&&e.errors.email,children:r.jsx(H,{fullWidth:!0,size:"small",name:"email",type:"email",placeholder:"email@example.com",value:e.values.email,onChange:e.handleChange,onBlur:e.handleBlur,sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px"}}})})})]}),r.jsx(n,{variant:"h6",sx:{mb:2,mt:3,color:"#374151",fontWeight:600,fontSize:"0.95rem"},children:"Health Card Information"}),r.jsxs(l,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",md:"repeat(3, 1fr)"},columnGap:{xs:1,md:3},rowGap:{xs:1.5,md:2}},children:[r.jsx(l,{children:r.jsx(A,{label:"Health Card Number",error:e.touched.healthCardNumber&&e.errors.healthCardNumber,helperText:e.touched.healthCardNumber&&e.errors.healthCardNumber,children:r.jsx(H,{fullWidth:!0,size:"small",name:"healthCardNumber",placeholder:"1234567890AB",value:e.values.healthCardNumber,onChange:r=>{e.handleChange(r);0===(r.target.value||"").toString().trim().length&&e.values.isHealthCardVerified&&e.setFieldValue("isHealthCardVerified",!1)},onBlur:e.handleBlur,sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px"}}})})}),r.jsx(l,{children:r.jsx(A,{label:"Issuing Province",error:e.touched.healthCardProvince&&e.errors.healthCardProvince,helperText:e.touched.healthCardProvince&&e.errors.healthCardProvince,children:r.jsx(H,{select:!0,fullWidth:!0,size:"small",name:"healthCardProvince",value:e.values.healthCardProvince,onChange:e.handleChange,onBlur:e.handleBlur,disabled:Q,sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px"}},children:Q?r.jsx(U,{disabled:!0,children:"Loading provinces..."}):null==K?void 0:K.map(e=>r.jsx(U,{value:e.provinceId,children:e.provinceName},e.provinceId))})})}),r.jsx(l,{children:r.jsx(A,{label:"Verification Status",children:r.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1,height:"40px"},children:[r.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:.5,px:1.5,py:.75,borderRadius:"6px",backgroundColor:e.values.isHealthCardVerified?"#dcfce7":"#fef3c7",border:e.values.isHealthCardVerified?"1px solid #86efac":"1px solid #fde047",flex:1},children:[e.values.isHealthCardVerified?r.jsx(q,{size:16,color:"#16a34a"}):r.jsx(l,{component:"span",sx:{width:16,height:16,borderRadius:"50%",border:"2px solid #f59e0b",display:"flex",alignItems:"center",justifyContent:"center"},children:r.jsx(l,{component:"span",sx:{fontSize:"12px",fontWeight:"bold",color:"#f59e0b",lineHeight:1},children:"!"})}),r.jsx(n,{variant:"body2",sx:{fontWeight:600,color:e.values.isHealthCardVerified?"#16a34a":"#f59e0b",fontSize:"0.875rem"},children:e.values.isHealthCardVerified?"Verified":"Unverified"})]}),r.jsx(z,{variant:"outlined",onClick:()=>(e=>{const r=e.values.isHealthCardVerified;if(!(r||(e.values.healthCardNumber||"").toString().trim().length>0))return void D.error("Please enter a health card number before verifying");e.setFieldValue("isHealthCardVerified",!r),D.success("Health card marked as "+(r?"unverified":"verified"))})(e),disabled:!e.values.isHealthCardVerified&&!(e.values.healthCardNumber||"").trim(),sx:{textTransform:"none",borderRadius:"6px",px:2,height:"40px",minWidth:"auto",whiteSpace:"nowrap",borderColor:"#3b82f6",color:"#3b82f6","&:hover":{borderColor:"#2563eb",backgroundColor:"rgba(59, 130, 246, 0.04)"}},children:e.values.isHealthCardVerified?"Mark Unverified":"Mark Verified"})]})})})]})]}),ye=e=>{switch(u){case 0:return ge(e);case 1:return(e=>{const t=e.values.medicalHistory.length,i=Math.ceil(t/5),a=5*(y-1),s=a+5,o=e.values.medicalHistory.slice(a,s);return r.jsxs(l,{sx:{border:"1px solid #e5e7eb",borderRadius:2,p:{xs:2,md:3},background:"linear-gradient(180deg,#ffffff,#f9fafb)",overflow:"hidden"},children:[r.jsx(he,{icon:P,title:"Medical Information",subtitle:"Enter medical details and history"}),r.jsxs(l,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",md:"repeat(2, 1fr)"},gap:2,overflow:"hidden"},children:[r.jsx(l,{sx:{minWidth:0},children:r.jsxs(l,{sx:{border:"1px solid #e5e7eb",borderRadius:"12px",p:{xs:1.5,sm:2.5},backgroundColor:"#ffffff",height:"100%",display:"flex",flexDirection:"column"},children:[r.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1,mb:1.5},children:[r.jsx(l,{sx:{width:32,height:32,borderRadius:"8px",backgroundColor:"#fef3c7",display:"flex",alignItems:"center",justifyContent:"center"},children:r.jsx(O,{size:18,color:"#f59e0b"})}),r.jsx(n,{variant:"h6",sx:{fontWeight:600,fontSize:"1rem",color:"#111827"},children:"Allergies (optional)"})]}),r.jsx(H,{fullWidth:!0,multiline:!0,rows:4,name:"allergies",placeholder:"List any known allergies (e.g., Penicillin, Shellfish, Latex)",value:e.values.allergies,onChange:e.handleChange,onBlur:e.handleBlur,sx:{"& .MuiOutlinedInput-root":{borderRadius:"8px",backgroundColor:"#f9fafb","& fieldset":{borderColor:"#e5e7eb"},"&:hover fieldset":{borderColor:"#d1d5db"},"&.Mui-focused fieldset":{borderColor:"#3b82f6"}},"& .MuiOutlinedInput-input":{fontSize:"0.875rem",color:"#374151","&::placeholder":{color:"#9ca3af",opacity:1}}}})]})}),r.jsx(l,{sx:{minWidth:0},children:r.jsxs(l,{sx:{border:"1px solid #e5e7eb",borderRadius:"12px",p:{xs:1.5,sm:2.5},backgroundColor:"#ffffff",height:"100%",display:"flex",flexDirection:"column"},children:[r.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1,mb:1.5},children:[r.jsx(l,{sx:{width:32,height:32,borderRadius:"8px",backgroundColor:"#dbeafe",display:"flex",alignItems:"center",justifyContent:"center"},children:r.jsx(f,{size:18,color:"#2563eb"})}),r.jsx(n,{variant:"h6",sx:{fontWeight:600,fontSize:"1rem",color:"#111827"},children:"Medical Notes (optional)"})]}),r.jsx(H,{fullWidth:!0,multiline:!0,rows:4,name:"medicalNotes",placeholder:"Additional medical notes from doctors",value:e.values.medicalNotes,onChange:e.handleChange,onBlur:e.handleBlur,sx:{"& .MuiOutlinedInput-root":{borderRadius:"8px",backgroundColor:"#f9fafb","& fieldset":{borderColor:"#e5e7eb"},"&:hover fieldset":{borderColor:"#d1d5db"},"&.Mui-focused fieldset":{borderColor:"#3b82f6"}},"& .MuiOutlinedInput-input":{fontSize:"0.875rem",color:"#374151","&::placeholder":{color:"#9ca3af",opacity:1}}}})]})}),r.jsx(l,{sx:{gridColumn:"1 / -1",minWidth:0},children:r.jsxs(l,{sx:{border:"1px solid #e5e7eb",borderRadius:"12px",p:{xs:1.5,sm:2.5},backgroundColor:"#ffffff"},children:[r.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1,mb:2},children:[r.jsx(l,{sx:{width:32,height:32,borderRadius:"8px",backgroundColor:"#dbeafe",display:"flex",alignItems:"center",justifyContent:"center"},children:r.jsx(f,{size:18,color:"#2563eb"})}),r.jsx(n,{variant:"h6",sx:{fontWeight:600,fontSize:"1rem",color:"#111827"},children:"Medical History (optional)"})]}),r.jsxs(l,{sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},gap:1.5,mb:2},children:[r.jsx(H,{fullWidth:!0,size:"small",placeholder:"Add medical history entry (e.g., CT Scan - Lower back, 2024)",value:b,onChange:e=>g(e.target.value),onKeyPress:r=>{"Enter"===r.key&&(r.preventDefault(),be(e))},sx:{"& .MuiOutlinedInput-root":{borderRadius:"8px",backgroundColor:"#f9fafb","& fieldset":{borderColor:"#e5e7eb"},"&:hover fieldset":{borderColor:"#d1d5db"},"&.Mui-focused fieldset":{borderColor:"#3b82f6"}},"& .MuiOutlinedInput-input":{fontSize:"0.875rem",padding:"10px 14px",color:"#374151","&::placeholder":{color:"#9ca3af",opacity:1}}}}),r.jsx(z,{variant:"contained",onClick:()=>be(e),startIcon:r.jsx(T,{size:16}),sx:{textTransform:"none",borderRadius:"8px",px:{xs:2,sm:3},whiteSpace:"nowrap",backgroundColor:"#3b82f6",fontWeight:500,fontSize:"0.875rem",boxShadow:"none",minWidth:{xs:"100%",sm:"auto"},"&:hover":{backgroundColor:"#2563eb",boxShadow:"none"}},children:"Add"})]}),e.values.medicalHistory.length>0?r.jsxs(r.Fragment,{children:[r.jsx(l,{sx:{overflowX:"auto",mb:2,mx:-.5},children:r.jsx(M,{component:B,sx:{boxShadow:"none",border:"1px solid #e5e7eb",borderRadius:"8px"},children:r.jsxs(W,{size:"small",sx:{minWidth:{xs:500,sm:"auto"}},children:[r.jsx(V,{children:r.jsxs(E,{sx:{backgroundColor:"#f9fafb"},children:[r.jsx(L,{sx:{fontWeight:600,color:"#374151",fontSize:{xs:"0.75rem",sm:"0.875rem"},width:{xs:100,sm:150}},children:"Date"}),r.jsx(L,{sx:{fontWeight:600,color:"#374151",fontSize:{xs:"0.75rem",sm:"0.875rem"}},children:"Entry"}),r.jsx(L,{sx:{fontWeight:600,color:"#374151",fontSize:{xs:"0.75rem",sm:"0.875rem"},width:{xs:70,sm:80}},align:"center",children:"Actions"})]})}),r.jsx(F,{children:o.map((t,i)=>{const l=a+i;return r.jsxs(E,{sx:{"&:hover":{backgroundColor:"#f9fafb"}},children:[r.jsx(L,{sx:{color:"#6b7280",fontSize:{xs:"0.75rem",sm:"0.875rem"}},children:t.date}),r.jsx(L,{sx:{color:"#374151",fontSize:{xs:"0.75rem",sm:"0.875rem"},wordBreak:"break-word"},children:t.entry}),r.jsx(L,{align:"center",children:r.jsx(ne,{title:"Delete entry",children:r.jsx(m,{size:"small",onClick:()=>((e,r)=>{const t=e.values.medicalHistory.filter((e,t)=>t!==r);e.setFieldValue("medicalHistory",t)})(e,l),sx:{color:"#ef4444","&:hover":{backgroundColor:"rgba(239, 68, 68, 0.1)"}},children:r.jsx(G,{size:16})})})})]},l)})})]})})}),i>1&&r.jsxs(l,{sx:{display:"flex",justifyContent:"center",alignItems:"center",gap:2,flexWrap:"wrap"},children:[r.jsx(z,{size:"small",disabled:1===y,onClick:()=>j(e=>e-1),sx:{textTransform:"none",fontSize:{xs:"0.75rem",sm:"0.875rem"}},children:"Previous"}),r.jsxs(n,{variant:"body2",sx:{color:"#6b7280",fontSize:{xs:"0.75rem",sm:"0.875rem"}},children:["Page ",y," of ",i]}),r.jsx(z,{size:"small",disabled:y===i,onClick:()=>j(e=>e+1),sx:{textTransform:"none",fontSize:{xs:"0.75rem",sm:"0.875rem"}},children:"Next"})]})]}):r.jsx(l,{sx:{p:4,textAlign:"center",backgroundColor:"#f9fafb",borderRadius:"8px",border:"1px solid #e5e7eb"},children:r.jsx(n,{variant:"body2",sx:{color:"#6b7280",fontSize:"0.875rem"},children:"No medical history entries yet. Add one above."})})]})})]})]})})(e);case 2:return(e=>r.jsxs(l,{sx:{border:"1px solid #e5e7eb",borderRadius:2,p:{xs:2,md:3},background:"linear-gradient(180deg,#ffffff,#f9fafb)"},children:[r.jsx(he,{icon:R,title:"Insurance Information",subtitle:"Enter insurance provider details"}),r.jsxs(l,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",md:"repeat(2, 1fr)"},columnGap:{xs:1,md:3},rowGap:{xs:1.5,md:2}},children:[r.jsx(l,{children:r.jsx(A,{label:"Insurance Provider",children:r.jsx(H,{fullWidth:!0,size:"small",name:"insuranceProvider",placeholder:"e.g., Blue Cross, Aetna",value:e.values.insuranceProvider,onChange:e.handleChange,onBlur:e.handleBlur,sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px"}}})})}),r.jsx(l,{children:r.jsx(A,{label:"Policy Number",children:r.jsx(H,{fullWidth:!0,size:"small",name:"policyNumber",placeholder:"Enter policy number",value:e.values.policyNumber,onChange:e.handleChange,onBlur:e.handleBlur,sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px"}}})})}),r.jsx(l,{children:r.jsx(A,{label:"Group Number",children:r.jsx(H,{fullWidth:!0,size:"small",name:"groupNumber",placeholder:"Enter group number",value:e.values.groupNumber,onChange:e.handleChange,onBlur:e.handleBlur,sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px"}}})})})]}),r.jsxs(l,{sx:{mt:4,p:2,backgroundColor:"#f0f9ff",borderRadius:"8px",border:"1px solid #bfdbfe",display:"flex",alignItems:"center",gap:1},children:[r.jsx(l,{sx:{width:36,height:36,borderRadius:"6px",backgroundColor:"#e0f2fe",display:"flex",alignItems:"center",justifyContent:"center"},children:r.jsx(R,{size:18,color:"#0369a1"})}),r.jsx(n,{variant:"body2",sx:{color:"#1e40af",fontWeight:500},children:"Note : Insurance information is optional but helpful for appointment processing."})]})]}))(e);default:return null}},je=e=>r.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",width:"100%",mt:1,pt:3,gap:2},children:[r.jsx(z,{onClick:0===u?t:me,sx:{textTransform:"none",color:"#6b7280",borderRadius:"8px",px:{xs:2,sm:4},py:1.5,fontSize:{xs:"0.875rem",sm:"0.95rem"},fontWeight:500,"&:hover":{backgroundColor:"rgba(59, 130, 246, 0.1)",color:"#2563eb"}},children:0===u?"Cancel":"Previous"}),r.jsx(z,{variant:"contained",disabled:p,onClick:()=>{u===X.length-1?(async e=>{const r=le();if(r)try{if(await r.validate(e.values,{abortEarly:!1}),$)return void D.error("Please resolve the duplicate patient issue before saving");x(!0);const i={...Z,...e.values},a={...i,gender:void 0!==i.gender&&null!==i.gender&&""!==i.gender?i.gender:se.MALE_ONLY,isHealthCardVerified:(i.healthCardNumber||"").toString().trim().length>0&&i.isHealthCardVerified};o&&await o(a),D.success(d?"Patient updated successfully!":"Patient added successfully!"),t(),re()}catch(i){if(i.inner){const r={},t={};i.inner.forEach(e=>{e.path&&(r[e.path]=e.message,t[e.path]=!0)}),e.setErrors(r),e.setTouched(t),D.error("Please fix the validation errors before saving")}else D.error(i.message||"Failed to save patient. Please try again.")}finally{x(!1)}})(e):(e=>{const r=le();r&&r.validate(e.values,{abortEarly:!1}).then(()=>{ee(r=>({...r,...e.values})),u<X.length-1&&h(e=>e+1)}).catch(r=>{var t;const i={},a={};null==(t=r.inner)||t.forEach(e=>{e.path&&(i[e.path]=e.message,a[e.path]=!0)}),e.setErrors(i),e.setTouched(a)})})(e)},sx:{textTransform:"none",borderRadius:"8px",px:{xs:2,sm:4},py:1.5,fontSize:{xs:"0.875rem",sm:"0.95rem"},fontWeight:500,backgroundColor:p?"#9ca3af":"#3b82f6","&:hover":{backgroundColor:p?"#9ca3af":"#2563eb"}},children:p?"Saving...":u===X.length-1?"Save Patient":"Next"})]});return r.jsx(a,{open:e,onClose:t,title:d?"Edit Patient":"Add Patient",maxWidth:"md",showActions:!1,customWidth:"min(820px, 95vw)",children:r.jsx(l,{sx:{pt:1,px:{xs:1,sm:2,md:2}},children:r.jsx(I,{initialValues:Z,validationSchema:le(),enableReinitialize:!0,onSubmit:()=>{},children:e=>r.jsxs(r.Fragment,{children:[_&&r.jsx(k,{severity:"info",sx:{mb:2,borderRadius:"8px","& .MuiAlert-message":{fontSize:"0.875rem"}},children:"Checking for duplicate patient records..."}),$&&!_&&r.jsx(k,{severity:"error",onClose:()=>Y(null),sx:{mb:2,borderRadius:"8px","& .MuiAlert-message":{fontSize:"0.875rem"}},children:$}),r.jsx(ue,{steps:X,currentStep:u,onStepClick:r=>((e,r)=>{ee(e=>({...e,...r.values})),h(e)})(r,e)}),r.jsx(l,{sx:{minHeight:{xs:"auto",sm:450}},children:ye(e)}),je(e)]})})})})});Pe.displayName="PatientProfileForm",Pe.propTypes={open:x.bool.isRequired,onClose:x.func.isRequired,onSubmit:x.func,editingPatient:x.object};const Re="patientList_columnVisibility",ze={patientId:!1,fullName:!0,dateOfBirth:!0,phone:!0,email:!0,gender:!0,healthCardNumber:!0,isHealthCardVerified:!0,healthCardProvinceName:!0,insuranceInfo:!0,medicalHistory:!0,appointmentHistory:!0,activityLog:!0,actions:!0},De=[{field:"createdOn",sort:"desc"}],Ae={items:[]},He=()=>{var e,t;const{selectedClinicId:s,clinicList:d,loadingClinics:c,clinicError:u}=ae(),[h,f]=i.useState(0),[p,x]=i.useState(25),[m,b]=i.useState(De),[g,y]=i.useState(""),[j,v]=i.useState(""),[C,N]=i.useState(Ae),[S,w]=i.useState(()=>{const e=localStorage.getItem(Re);return e?JSON.parse(e):ze}),[I,k]=i.useState(!1),[P,R]=i.useState(null),[A,H]=i.useState(!1),[O,T]=i.useState(!1),[M,B]=i.useState(null),[W,V]=i.useState(!1),[E,L]=i.useState(null),[F,G]=i.useState(!1),[U,q]=i.useState(!1),[J,K]=i.useState(null),[se,oe]=i.useState(""),[de,ce]=i.useState(null),[ue,he]=i.useState(!1),[fe,pe]=i.useState(null),[xe,be]=i.useState(null);i.useEffect(()=>{localStorage.setItem(Re,JSON.stringify(S))},[S]);const ge=(null==(e=m[0])?void 0:e.field)||"createdOn",He=(null==(t=m[0])?void 0:t.sort)||"desc",Oe=i.useMemo(()=>Q().filter(e=>["contains"].includes(e.value)),[]),Te=i.useMemo(()=>X().filter(e=>["is","after","before","onOrAfter","onOrBefore"].includes(e.value)),[]),Me=i.useMemo(()=>Z().filter(e=>["is"].includes(e.value)),[]),Be=i.useMemo(()=>{var e;const r={};if(null==(e=null==C?void 0:C.items)?void 0:e.length){const e=new Map;for(const r of C.items)(null==r?void 0:r.field)&&null!=(null==r?void 0:r.value)&&""!==(null==r?void 0:r.value)&&e.set(r.field,r);e.forEach((e,t)=>{const i=e.value;switch(t){case"fullName":r.filterFullName=String(i);break;case"email":r.filterEmail=String(i);break;case"phone":r.filterPhone=String(i);break;case"gender":{const e=Number(i);Number.isNaN(e)||(r.filterGender=e);break}case"isHealthCardVerified":!0===i||!1===i?r.filterIsHealthCardVerified=i:"true"!==i&&"false"!==i||(r.filterIsHealthCardVerified="true"===i);break;case"healthCardProvinceName":r.filterHealthCardProvinceName=String(i);break;case"healthCardNumber":r.filterHealthCardNumber=String(i);break;case"dateOfBirth":if("isAfter"===e.operator||"after"===e.operator||"onOrAfter"===e.operator)r.filterDateOfBirthFrom=new Date(i).toISOString();else if("isBefore"===e.operator||"before"===e.operator||"onOrBefore"===e.operator)r.filterDateOfBirthTo=new Date(i).toISOString();else{const e=new Date(i),t=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),0,0,0)),a=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),23,59,59));r.filterDateOfBirthFrom=t.toISOString(),r.filterDateOfBirthTo=a.toISOString()}}})}return{page:h+1,pageSize:p,sortBy:ge,sortOrder:He,search:g||null,filterGender:r.filterGender??null,filterIsHealthCardVerified:r.filterIsHealthCardVerified??null,filterFullName:r.filterFullName??null,filterEmail:r.filterEmail??null,filterPhone:r.filterPhone??null,filterHealthCardNumber:r.filterHealthCardNumber??null,filterHealthCardProvinceName:r.filterHealthCardProvinceName??null,filterDateOfBirthFrom:r.filterDateOfBirthFrom??null,filterDateOfBirthTo:r.filterDateOfBirthTo??null}},[h,p,ge,He,g,C]),{patients:We,pagination:Ve,isLoading:Ee,refetch:Le}=((e=null,r={})=>{const[t,a]=i.useState([]),[l,n]=i.useState(null),[s,o]=i.useState({}),[d,c]=i.useState(!1),[u,h]=i.useState(null),f=i.useCallback(async()=>{if(!e)return a([]),n(null),o({}),c(!1),void h(null);c(!0),h(null);try{const t=await ye(e,r);t.data&&t.pagination?(a(t.data),n(t.pagination),o(t.appliedFilters||{})):(a(t),n(null),o({}))}catch(t){h(t.message),a([]),n(null),o({})}finally{c(!1)}},[e,JSON.stringify(r)]);return i.useEffect(()=>{f()},[f]),{patients:t,pagination:l,appliedFilters:s,isLoading:d,error:u,refetch:f}})(s,Be),{deletePatient:Fe}=(()=>{const[e,r]=i.useState(!1),[t,a]=i.useState(null);return{deletePatient:i.useCallback(async e=>{r(!0),a(null);try{return await Ne(e)}catch(t){throw a(t.message),t}finally{r(!1)}},[]),isLoading:e,error:t}})(),{createPatient:Ge}=(()=>{const[e,r]=i.useState(!1),[t,a]=i.useState(null);return{createPatient:i.useCallback(async e=>{r(!0),a(null);try{return await je(e)}catch(t){throw a(t.message),t}finally{r(!1)}},[]),isLoading:e,error:t}})(),{updatePatient:Ue}=(()=>{const[e,r]=i.useState(!1),[t,a]=i.useState(null);return{updatePatient:i.useCallback(async(e,t)=>{r(!0),a(null);try{return await Ce(e,t)}catch(i){throw a(i.message),i}finally{r(!1)}},[]),isLoading:e,error:t}})(),qe=async e=>{try{H(!0);const r=await ve(e.patientId);R(r),k(!0)}catch(r){D.error("Failed to load patient data. Please try again.")}finally{H(!1)}},$e=[{field:"patientId",headerName:"Patient ID",width:100,sortable:!0,filterable:!1,hide:!0,hideable:!1},{field:"fullName",headerName:"Full Name",width:200,sortable:!0,filterable:!0,filterOperators:Oe},{field:"dateOfBirth",headerName:"Date of Birth",width:130,sortable:!0,type:"date",filterOperators:Te,valueFormatter:e=>le(e)},{field:"phone",headerName:"Phone",width:150,sortable:!0,filterable:!0,filterOperators:Oe,valueGetter:e=>e||"N/A"},{field:"email",headerName:"Email",width:200,sortable:!0,filterable:!0,filterOperators:Oe,valueGetter:e=>e||"N/A"},{field:"gender",headerName:"Gender",width:100,sortable:!0,filterable:!0,type:"singleSelect",filterOperators:Me,valueOptions:[{value:1,label:"Male"},{value:2,label:"Female"},{value:3,label:"Other"}],valueFormatter:e=>({1:"Male",2:"Female",3:"Other"}[e]||"N/A")},{field:"healthCardNumber",headerName:"Health Card",width:180,sortable:!0,filterable:!0,filterOperators:Oe,valueGetter:e=>e||"N/A"},{field:"isHealthCardVerified",headerName:"Health Card Status",width:160,sortable:!1,filterable:!0,type:"singleSelect",filterOperators:Me,valueOptions:[{value:!0,label:"Verified"},{value:!1,label:"Unverified"}],renderCell:e=>r.jsx(Y,{sx:{height:"100%",justifyContent:"center"},children:e.value?r.jsx(o,{label:"Verified",color:"success",size:"small"}):r.jsx(o,{label:"Unverified",size:"small",color:"warning"})})},{field:"healthCardProvinceName",headerName:"Province",width:120,sortable:!0,filterable:!0,filterOperators:Oe,valueGetter:e=>e||"N/A"},{field:"insuranceInfo",headerName:"Insurance",width:200,sortable:!1,filterable:!1,renderCell:e=>{const{insuranceProvider:t,policyNumber:i}=e.row;return t&&i?r.jsxs("span",{children:[t," - ",i]}):"N/A"}},{field:"medicalHistory",headerName:"Medical History",width:150,sortable:!1,filterable:!1,renderCell:e=>e.row.medicalHistoryCount>0?r.jsx(z,{size:"small",variant:"outlined",onClick:r=>{var t;r.stopPropagation(),t=e.row.medicalHistory,B(t),T(!0)},sx:{textTransform:"none"},children:"View"}):"N/A"},{field:"appointmentHistory",headerName:"Appointments",width:130,sortable:!1,filterable:!1,renderCell:e=>r.jsx(z,{size:"small",variant:"outlined",onClick:r=>{r.stopPropagation(),(async e=>{try{ce(e.patientId);const r=await Se(e.patientId);K(r),oe(e.fullName),q(!0)}catch(r){D.error(r.message||"Failed to load appointment history. Please try again.")}finally{ce(null)}})(e.row)},disabled:de===e.row.patientId,sx:{textTransform:"none"},children:de===e.row.patientId?"Loading...":"View"})},{field:"activityLog",headerName:"Activity Log",width:120,sortable:!1,filterable:!1,renderCell:e=>r.jsx(z,{size:"small",variant:"outlined",onClick:r=>{r.stopPropagation(),(async e=>{try{be(e.patientId);const r=await we(e.patientId);pe(r.logs||[]),oe(e.fullName),he(!0)}catch(r){D.error(r.message||"Failed to load activity logs. Please try again.")}finally{be(null)}})(e.row)},disabled:xe===e.row.patientId,sx:{textTransform:"none"},children:xe===e.row.patientId?"Loading...":"View"})},{field:"actions",type:"actions",headerName:"Actions",width:120,filterable:!1,getActions:e=>[r.jsx(re,{icon:r.jsx(ne,{title:"Edit",children:r.jsx(_,{})}),label:"Edit",onClick:()=>qe(e.row),color:"primary"}),r.jsx(re,{icon:r.jsx(ne,{title:"Delete",children:r.jsx(me,{})}),label:"Delete",onClick:()=>(async e=>{L(e),V(!0)})(e.row),color:"error"})]}];return r.jsxs(l,{children:[r.jsx(ie,{icon:$.PatientProfile,title:"Patients",description:"View and manage patient profiles and information",clinics:d,selectedClinicId:s,addButtonLabel:"Add Patient",onAdd:()=>{R(null),k(!0)},addButtonDisabled:!s,loadingClinics:c,clinicError:u}),r.jsx(ee,{rows:We,columns:$e,getRowId:e=>e.patientId,loading:Ee,filterModel:C,onFilterModelChange:e=>{N(e),f(0)},paginationModel:{page:h,pageSize:p},onPaginationModelChange:e=>{e.pageSize!==p?(x(e.pageSize),f(0)):e.page!==h&&f(e.page)},rowCount:(null==Ve?void 0:Ve.totalRecords)||0,pageSizeOptions:[10,25,50,100],sortModel:m,onSortModelChange:e=>{b(e),f(0)},columnVisibilityModel:S,onColumnVisibilityModelChange:e=>w(e),onRowClick:e=>qe(e.row),searchInput:j,onSearchInputChange:e=>{v(e.target.value)},onSearchSubmit:()=>{y(j),f(0)},onClearSearch:()=>{v(""),y(""),f(0)},onResetAll:()=>{N(Ae),b(De),f(0),x(25),v(""),y(""),"function"==typeof Le&&Le()},searchPlaceholder:"Search by name, email, phone, health card...",height:600}),r.jsx(Pe,{open:I,onClose:()=>{k(!1),R(null)},onSubmit:async e=>{var r;try{const t=s?Number(s):null;if(!e.patientId&&!t)return D.error("No clinic selected. Please select a clinic before creating a patient."),!1;const i={fullName:e.fullName,dateOfBirth:e.dob?new Date(e.dob).toISOString():null,gender:e.gender,identifiedAs:e.identifiedAs??0,healthCardNumber:e.healthCardNumber||null,isHealthCardVerified:e.isHealthCardVerified||!1,healthCardProvinceId:e.healthCardProvince||null,email:e.email||null,phone:e.phone||null,allergies:e.allergies||null,medicalNotes:e.medicalNotes||null,medicalHistory:(null==(r=e.medicalHistory)?void 0:r.map(e=>e.entry))||[],insuranceProvider:e.insuranceProvider||null,policyNumber:e.policyNumber||null,groupNumber:e.groupNumber||null,...e.patientId?{}:{clinicId:t}};if(e.patientId){const r={patientId:e.patientId,...i};await Ue(e.patientId,r)}else await Ge(i);return Le(),!0}catch(t){throw t}},editingPatient:P}),r.jsx(te,{open:W,onClose:()=>{V(!1),L(null)},onConfirm:async()=>{if(E)try{G(!0),await Fe(E.patientId),D.success("Patient deleted successfully"),Le(),V(!1),L(null)}catch(e){D.error(e.message||"Failed to delete patient. Please try again.")}finally{G(!1)}},title:"Delete Patient",message:`All information related to this patient will be deleted. To confirm, type "${null==E?void 0:E.fullName}" below.`,loading:F,confirmationText:(null==E?void 0:E.fullName)&&String(E.fullName)||[null==E?void 0:E.firstName,null==E?void 0:E.lastName].filter(Boolean).join(" "),inputLabel:"Type PATIENT'S NAME to confirm",caseSensitive:!0}),r.jsx(a,{open:O,onClose:()=>{T(!1),B(null)},title:"Medical History "+(M&&M.length>0?`(${M.length})`:""),maxWidth:"md",showActions:!1,children:M&&M.length>0?r.jsx(l,{sx:{display:"flex",flexDirection:"column",gap:1,mt:1},children:M.map(e=>r.jsxs(l,{sx:{backgroundColor:"#f8fafc",p:2,borderRadius:1,border:"1px solid",borderColor:"#e2e8f0",display:"grid",gridTemplateColumns:"auto 1fr",gap:2},children:[r.jsxs(l,{children:[r.jsx(n,{variant:"body2",color:"text.secondary",children:"Date Recorded"}),r.jsx(n,{variant:"body1",fontWeight:500,children:le(e.dateRecorded)})]}),r.jsxs(l,{sx:{minWidth:0,overflow:"hidden"},children:[r.jsx(n,{variant:"body2",color:"text.secondary",children:"Entry"}),r.jsx(n,{variant:"body1",sx:{wordBreak:"break-word",overflowWrap:"break-word"},children:e.entry||"Not provided"})]})]},e.id))}):r.jsx(l,{sx:{py:3,textAlign:"center"},children:r.jsx(n,{variant:"body1",color:"text.secondary",children:"No medical history records found."})})}),r.jsx(ke,{open:U,onClose:()=>{q(!1),K(null),oe("")},appointments:J,patientName:se}),r.jsx(Ie,{open:ue,onClose:()=>{he(!1),pe(null),oe("")},activityLogs:fe,patientName:se})]})};export{He as default};
