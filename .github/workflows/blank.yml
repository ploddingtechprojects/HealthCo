name: Auto Deploy HealthCo

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      # 1️⃣ Checkout the repo
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2️⃣ Deploy Frontend
      - name: Deploy Frontend
        run: |
          echo "Deploying frontend..."
          cd frontend

          # Remove old frontend files
          sudo rm -rf /var/www/html/*

          # Install unrar safely
          if ! command -v unrar &> /dev/null; then
            echo "Installing unrar..."
            # Enable non-free and contrib repositories
            sudo sed -i 's/main/main contrib non-free/' /etc/apt/sources.list
            sudo apt-get update
            sudo apt-get install -y unrar || sudo apt-get install -y unrar-free
          fi

          # Extract dist.rar to NGINX folder
          if [ -f dist.rar ]; then
            echo "Extracting frontend files..."
            sudo unrar x dist.rar /var/www/html/ || sudo unrar-free x dist.rar /var/www/html/
          else
            echo "dist.rar not found, skipping extraction"
          fi

          # Reload NGINX to serve new frontend
          sudo systemctl reload nginx

          echo "Frontend deployed successfully!"

      # 3️⃣ Deploy Backend
      - name: Deploy Backend
        run: |
          echo "Deploying backend..."
          cd backend
          if [ -f package.json ]; then
            npm install
            pm2 stop healthco-backend || true
            pm2 start server.js --name healthco-backend
          else
            pm2 stop healthco-backend || true
            pm2 start BookAppointmentPublish08122026.js --name healthco-backend
          fi

      # 4️⃣ Health Check
      - name: Health Check
        run: |
          echo "Checking application health..."
          curl -f http://localhost || exit 1
