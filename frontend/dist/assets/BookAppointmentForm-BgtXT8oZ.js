import{r as e,m as t,cF as a,y as n,j as i,p as s,bv as r,T as l,e as o,B as d,ak as c,by as u,bz as p,cG as h,aP as m,cH as f,bN as y,bL as x,P as b,aJ as g,d as v,aK as T,k as S,ae as j,A as I,az as C,aR as N,aq as k,C as w,ac as D,S as q,a as A,an as R,ao as P,aI as E,cI as F,bI as W,o as $,aS as B,bg as M,V,X as O,F as H,am as _,cJ as G,aO as z,aN as Q,c as L,f as Y,a9 as U,a8 as J,g as K}from"./index-DyR0ftVW.js";import{b as Z,G as X,I as ee,D as te,C as ae,S as ne,h as ie,a as se,e as re,f as le}from"./DateOfBirthField-8J2568o0.js";import{c as oe}from"./calendarService-uG1S5kl9.js";import{R as de,c as ce,a as ue}from"./bookingRules-DFQhlYAe.js";import{getCurrentClinicTime as pe,splitAppointments as he,validateAppointmentSplitting as me,getAppointmentDependencies as fe,formatDateISO as ye,validateSequentialSlotSelection as xe,validateSeparateDaySelection as be}from"./appointmentLogic-ihgp36Gl.js";import{fetchCalendarRules as ge,getEnabledRule as ve}from"./calendarRulesService-tdjIi356.js";import{T as Te}from"./Tooltip-Cof9Jr1h.js";import{C as Se}from"./CommonCheckbox-aJ2wZ0C8.js";import{u as je}from"./useProvinces-BxWqgMCH.js";import{T as Ie,S as Ce,C as Ne}from"./TruncateTooltip-BVddiBa5.js";const ke=0,we=1,De=2,qe={[ke]:"None",[we]:"Health Card",[De]:"IFHP"},Ae=()=>{const t="booking_session_id",a=e.useRef(null),n=e.useCallback(()=>{if(a.current)return a.current;let e=sessionStorage.getItem(t);return e||(e=`booking_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,sessionStorage.setItem(t,e)),a.current=e,e},[]),i=e.useCallback(()=>{sessionStorage.removeItem(t),a.current=null},[]),s=e.useCallback(()=>(i(),n()),[i,n]);return{getSessionId:n,clearSessionId:i,regenerateSessionId:s}},Re=e=>{if(!e||"string"!=typeof e)return null;let t=e.replace("#","").trim();if(3===t.length&&(t=t.split("").map(e=>e+e).join("")),6!==t.length)return null;const a=parseInt(t,16);return{r:a>>16&255,g:a>>8&255,b:255&a}},Pe=({r:e,g:t,b:a})=>`#${[e,t,a].map(e=>{return(t=e,Math.max(0,Math.min(255,t))).toString(16).padStart(2,"0");var t}).join("")}`,Ee=(e,t=.12)=>{const a=Re(e);return a?Pe({r:Math.round(a.r*(1-t)),g:Math.round(a.g*(1-t)),b:Math.round(a.b*(1-t))}):e||"#3b82f6"},Fe=(e,t=1)=>{const a=Re(e);return a?`rgba(${a.r}, ${a.g}, ${a.b}, ${t})`:`rgba(59, 130, 246, ${t})`},We=(a,n=!0)=>{const[i,s]=e.useState(null),[r,l]=e.useState(!1),[o,d]=e.useState(null),c=e.useRef(null);e.useEffect(()=>{if(!n||!a)return;l(!0),d(null);const e=new AbortController;return c.current=e,t.get(`https://healthco.clinic/api/fhir/Organization/branding/${a}`,{signal:e.signal}).then(e=>{const t=(null==e?void 0:e.data)||{};s({clinicId:t.clinicId??a,clinicName:t.clinicName??"",primaryColor:t.primaryColor||"#3b82f6",secondaryColor:t.secondaryColor||"#10b981",logoBase64:t.logoBase64||null})}).catch(e=>{t.isCancel(e)||"CanceledError"===(null==e?void 0:e.name)||"AbortError"===(null==e?void 0:e.name)||(d(e),s({clinicId:a,clinicName:"",primaryColor:"#3b82f6",secondaryColor:"#10b981",logoBase64:null}))}).finally(()=>l(!1)),()=>e.abort()},[a,n]);const u=e.useMemo(()=>{const e=(null==i?void 0:i.primaryColor)||"#3b82f6",t=(null==i?void 0:i.secondaryColor)||"#10b981";return{primary:e,primaryHover:Ee(e,.14),secondary:t,secondaryHover:Ee(t,.14)}},[i]);return{branding:i,colors:u,loading:r,error:o}},$e=(e,t)=>{const a=new Date(e);return a.setDate(a.getDate()+t),a},Be=e=>{if(!e)return null;if(e instanceof Date)return e;if("string"==typeof e){const t=e.length>10?e:`${e}T00:00:00`,a=new Date(t);return isNaN(a)?null:a}return null},Me=(e,t)=>{const a=Be(e);return a?a.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"}):e??""},Ve=e=>{if(!e||!Array.isArray(e))return null;for(const t of e){const e=(null==t?void 0:t.bookingRules)||(null==t?void 0:t.BookingRules);if(e&&Array.isArray(e)){const t=e.find(e=>e.ruleType===ue.OB_HIGH_RISK&&e.isEnabled);if(t)return t}}return null},Oe=e=>{if(!e||!Array.isArray(e))return null;for(const t of e){const e=(null==t?void 0:t.bookingRules)||(null==t?void 0:t.BookingRules);if(e&&Array.isArray(e)){const t=e.find(e=>e.ruleType===ue.NT_SCAN&&e.isEnabled);if(t)return t}}return null},He=(e,t)=>{var a;if(!t||!t.canBookSlots)return!1;if((null==(a=t.dateCriteria)?void 0:a.strictQualification)&&"too_late"===t.patientStatus)return!1;const n=new Date(e).getTime(),i=t.earliestValidDate.getTime(),s=t.latestValidDate.getTime();return n>=i&&n<=s},_e=e=>{if(null==e||""===e)return null;if("number"==typeof e)return e;if("string"==typeof e){const t=new Date(e);if(!isNaN(t.getTime())){const e=new Date;let a=280-(t.getTime()-e.getTime())/864e5;if(!isNaN(a))return a=Math.floor(a),a<0&&(a=0),a>350&&(a=350),a}const a=parseInt(e);if(!isNaN(a))return a}return null},Ge=(e,t,a)=>{if(!e||!t)return null;const n=new Date;n.setHours(0,0,0,0);const i=e/7,s=t.minGestationalDays||77,r=t.maxGestationalDays||98,l=t.earlyGestationalDaysStart||49,o=t.earlyGestationalDaysEnd||56,d=t.urgentGestationalDaysStart||91,c=t.urgentGestationalDaysEnd||98,u=s-e,p=r-e,h=u>0?$e(n,u):n,m=p>0?$e(n,p):n;let f="normal",y="normal",x=t.requiredTimeframe,b=t.maxAdvanceBookingDays;e>=l&&e<=o?(f="early",y="advance",b=t.earlyMaxAdvanceBookingDays||b):e>=d&&e<=c&&(f="urgent",y="urgent",x=t.urgentRequiredTimeframe||x);return{currentGestationalDays:e,currentGestationalWeeks:i,minGestationalDays:s,maxGestationalDays:r,earliestValidDate:h,latestValidDate:m,patientCategory:f,bookingType:y,requiredTimeframe:x,maxAdvanceBookingDays:b,ntRule:t}},ze=(e,t)=>{if(!t)return!0;if(!t.earliestValidDate||!t.latestValidDate)return!0;const a=new Date(e);a.setHours(0,0,0,0);const n=a.getTime(),i=t.earliestValidDate.getTime();if("early"===t.patientCategory&&t.maxAdvanceBookingDays){const e=new Date;e.setHours(0,0,0,0);const a=$e(e,t.maxAdvanceBookingDays),i=Math.floor((n-e.getTime())/864e5),s=t.currentGestationalDays+i,r=s>=t.minGestationalDays&&s<=t.maxGestationalDays,l=n<=a.getTime(),o=n>=e.getTime();return l&&r&&o}let s=t.latestValidDate.getTime();return n>=i&&n<=s},Qe=e=>{if(!e||!Array.isArray(e))return null;const t=e.filter(e=>"PSB"===e.ruleCode&&e.isEnabled);for(const n of t)try{const e=JSON.parse(n.configJson||"{}");if(e.enabled&&!1===e.isException)return e}catch(a){}return null},Le=(e,t,a)=>{const n=t[e];if(!n)return!1;if(n.isPSBException)return!0;if("separate-day-combination"===n.splitReason)return!0;if(a&&Array.isArray(a)){const e=a.filter(e=>"PSB"===e.ruleCode&&e.isEnabled);for(const t of e)try{const e=JSON.parse(t.configJson||"{}");if(!0===e.isException&&!1!==e.enabled&&e.subServiceIds&&Array.isArray(e.subServiceIds)){if(n.scanTypeIds.some(t=>e.subServiceIds.includes(t)))return!0}}catch(i){}}return!1},Ye=(e,t,a,n,i)=>{const s=(e=>{if(!e||!Array.isArray(e))return[];const t=e.filter(e=>"SDCC"===e.ruleCode&&e.isEnabled);if(!t||0===t.length)return[];const a=[];for(const i of t)try{const e=JSON.parse(i.configJson||"{}");e.enabled&&a.push(e)}catch(n){}return a})(i);if(!s||0===s.length)return!0;const r=a[t];if(!r||!r.scanTypeIds)return!0;const l=new Date(e);l.setHours(0,0,0,0);for(let o=0;o<t;o++){const e=a[o],t=n[o];if(!e||!t||!e.scanTypeIds)continue;const i=new Date(t.date);if(i.setHours(0,0,0,0),l.getTime()===i.getTime())for(const a of s){const t=a.leftScanId,n=a.rightScanId;if(!t||!n)continue;const i=r.scanTypeIds.includes(t),s=r.scanTypeIds.includes(n),l=e.scanTypeIds.includes(t),o=e.scanTypeIds.includes(n);if(i&&o||s&&l)return!1}}return!0},Ue=({formikProps:t,clinicId:b,editState:g,onProgressChange:v})=>{var T,S,j,I,C,N,k,w,D,q,A,R,P,E;const{getSessionId:F}=Ae(),W=a(),$=(null==W?void 0:W.isPublic)&&(null==W?void 0:W.primary)?W.primary:null,B=(null==W?void 0:W.isPublic)&&(null==W?void 0:W.secondary)?W.secondary:null,[M]=e.useState(()=>{const e=new Date;return e.setHours(0,0,0,0),e}),[V,O]=e.useState(0),[H,_]=e.useState(!1),[G,z]=e.useState([]),[Q,L]=e.useState([]),[Y,U]=e.useState(0),[J,K]=e.useState(null),[X,ee]=e.useState(30),[te,ae]=e.useState(null),[ne,ie]=e.useState(null),[se,re]=e.useState(null),[le,Se]=e.useState(null),[je,Ie]=e.useState(null),[Ce,Ne]=e.useState(null),[ke,we]=e.useState(0),[De,qe]=e.useState(()=>pe()),Re=e.useMemo(()=>$e(M,V),[M,V]),Pe=e.useMemo(()=>{var e,a,n;return b??(null==(e=t.values)?void 0:e.clinicId)??(null==(a=t.values)?void 0:a.selectedClinicId)??(null==(n=t.values)?void 0:n.ClinicId)??null},[b,t.values]),Ee=e.useMemo(()=>{const e=t.values.selectedScansWithServices||[];return e.length>0&&Pe?he(e,Pe):Promise.resolve([])},[t.values.selectedScansWithServices,Pe]),[We,Ue]=e.useState([]),[Je,Ke]=e.useState(null),[Ze,Xe]=e.useState(null),[et,tt]=e.useState(null);e.useEffect(()=>{const e=setInterval(()=>{qe(pe())},1e3);return()=>clearInterval(e)},[]),e.useEffect(()=>{Je&&Array.isArray(Je.warnings)&&Je.warnings.length},[Je]),e.useEffect(()=>{if(Ce){const e=new Date;e.setHours(0,0,0,0);const t=new Date(Ce);if(t.setHours(0,0,0,0),t>=e){const e=new Date;e.setHours(0,0,0,0);const a=Math.floor((t.getTime()-e.getTime())/864e5);a>=0&&a!==V&&O(a)}else Ne(null)}},[Y,Ce,M,V]),e.useEffect(()=>{if(Xe(null),Ee instanceof Promise)Ee.then(e=>{Ue(e),t.setFieldValue("totalResolvedAppointments",e.length),t.setFieldValue("resolvedAppointments",e),t.setFieldValue("selectedSlots",[]),t.values.selectedSlot&&t.setFieldValue("selectedSlot",null),U(0);const a=me(e);Ke(a),a.errors.length>0&&Xe(a.errors.join("; ")),a.warnings.length}).catch(e=>{Xe("Failed to process appointment splitting. Please try again."),Ue([]),t.setFieldValue("totalResolvedAppointments",0),t.setFieldValue("resolvedAppointments",[]),t.setFieldValue("selectedSlots",[]),t.values.selectedSlot&&t.setFieldValue("selectedSlot",null),U(0)});else{const e=Ee||[];Ue(e),t.setFieldValue("totalResolvedAppointments",e.length),t.setFieldValue("resolvedAppointments",e),t.setFieldValue("selectedSlots",[]),t.values.selectedSlot&&t.setFieldValue("selectedSlot",null),U(0)}},[Ee]);const at=We[Y]||null,nt=(null==at?void 0:at.scanTypeIds)||[];e.useEffect(()=>{},[Y,at]),e.useEffect(()=>{try{const e=fe(at,We);e&&e.length}catch(e){}},[at,We]),e.useEffect(()=>{const e=nt,a=t.values.detailedScanTypes||[];if(!e.length)return z([]),void _(!1);const n=e.map(e=>{const t=a.find(t=>t.scanTypeId===e);return t||null});if(!n.some(e=>null===e))return z(n),void _(!1);_(!0);(async()=>{try{const t=e.map(async e=>{const t=a.find(t=>t.scanTypeId===e);if(t)return t;const n=await fetch(`https://healthco.clinic/api/api/scantypes/${e}`,{headers:{Accept:"application/json"}});if(!n.ok)throw new Error(`Failed to fetch scan type ${e}: ${n.status} ${n.statusText}`);const i=await n.json();if(i.isError)throw new Error(`API error for scan type ${e}`);return i.value||i.data||i}),n=await Promise.all(t);z(n)}catch(t){z([])}finally{_(!1)}})()},[nt,t.values.detailedScanTypes]),e.useEffect(()=>{Ve(G)||ae(null)},[G]),e.useEffect(()=>{const e=Oe(G);ie(e);const a=t.values.ntScanData;if(a&&a.gestationalAge&&e){Se(a.gestationalAge);const t=Ge(a.gestationalAge,e);re(t),Ie({currentGestationalDays:a.gestationalAge,canBookSlots:!0,patientStatus:"valid",message:`Based on your due date, you are ${Math.floor(a.gestationalAge/7)} weeks pregnant (${a.gestationalAge} days)`,earliestValidDate:t.earliestValidDate,latestValidDate:t.latestValidDate})}else{const a=((e,t)=>{var a;if(!e||!t||0===t.length||0===e.length)return null;for(const n of t){const t=n.questions||n.preQualifyingQuestions||[];for(const i of t)if(5===i.type){const t=i.scanTypeQuestionId||i.id,s=e.find(e=>e.scanTypeId===n.scanTypeId&&e.scanTypeQuestionId===t);if(s&&s.response){const e=_e(s.response),t=null==(a=i.options)?void 0:a[0];if(t&&!isNaN(e))return{currentGestationalDays:e,dateCriteria:{condition:1===t.conditionType?"range":2===t.conditionType?"less than":3===t.conditionType?"more than":"range",from:t.minDays,to:t.maxDays,value:2===t.conditionType?t.maxDays:t.minDays,strictQualification:t.strictQualification||!1},questionText:i.questionText||i.question}}}}return null})(t.values.scanResponses,G);if(a&&a.currentGestationalDays){if(Se(a.currentGestationalDays),a.dateCriteria&&a.dateCriteria.strictQualification)Ie(null);else{const e=(e=>{if(!e||!e.currentGestationalDays||!e.dateCriteria)return null;const{currentGestationalDays:t,dateCriteria:a,questionText:n}=e,i=new Date,{condition:s,from:r,to:l,value:o,strictQualification:d}=a;let c,u,p="unknown",h="",m=!0;"range"===s?(c=parseInt(r)||0,u=parseInt(l)||0,t<c?(p="too_early",h=`You are currently at ${t} days gestational age. This scan requires ${c}-${u} days. You can book appointments starting ${c-t} days from now.`,m=!0):t>u?(p="too_late",h=`You are currently at ${t} days gestational age, which is beyond the recommended range of ${c}-${u} days for this scan. Please contact the clinic for guidance.`,m=!d):(p="within_range",h=`You are currently at ${t} days gestational age, which is within the optimal range of ${c}-${u} days for this scan.`,m=!0)):"less than"===s?(u=parseInt(o)||0,t>=u?(p="too_late",h=`You are currently at ${t} days gestational age, which exceeds the maximum of ${u} days for this scan. Please contact the clinic for guidance.`,m=!d):(p="within_range",h=`You are currently at ${t} days gestational age, which is within the required timeframe (less than ${u} days) for this scan.`,m=!0)):"more than"===s&&(c=parseInt(o)||0,t<=c?(p="too_early",h=`You are currently at ${t} days gestational age. This scan requires more than ${c} days. You can book appointments starting ${c-t+1} days from now.`,m=!0):(p="within_range",h=`You are currently at ${t} days gestational age, which meets the requirement (more than ${c} days) for this scan.`,m=!0));let f=i,y=$e(i,365);if("too_early"===p&&c)f=$e(i,c-t),u&&(y=$e(i,u-t));else if("within_range"===p&&u){const e=u-t;y=e>0?$e(i,e):i}else"too_late"!==p||d||(f=i,y=$e(i,30));return{currentGestationalDays:t,minRequiredDays:c,maxRequiredDays:u,patientStatus:p,message:h,canBookSlots:m,earliestValidDate:f,latestValidDate:y,questionText:n,dateCriteria:a}})(a);Ie(e)}if(e){const t=Ge(a.currentGestationalDays,e);re(t)}else re(null)}else Se(null),Ie(null),e||re(null)}e||(ie(null),re(null))},[G,t.values.scanResponses,t.values.ntScanData,Re,X]),e.useEffect(()=>{let e=!1;ne&&se&&!ze(Re,se)&&(e=!0);const t=ne&&se&&"early"===se.patientCategory;if(e||!je||t||He(Re,je)||(e=!0),e){const e=new Date,a=t&&se.maxAdvanceBookingDays?Math.min(se.maxAdvanceBookingDays,60):30;for(let n=0;n<a;n++){const a=$e(e,n);let i=!0;if(ne&&se&&(i=i&&ze(a,se)),je&&!t&&(i=i&&He(a,je)),i){const e=Math.floor((a.getTime()-M.getTime())/864e5);if(e>=0){O(e);break}}}}},[ne,se,je,Re,M]),e.useEffect(()=>{let e=!1;if(!Pe)return K(null),void ee(30);return(async()=>{try{const t=await ge(Pe);if(e)return;K(t);const a=ve(t,"SDR");if(a)if(a.config.enabled){const e=a.config.days||30;ee(e)}else ee(30);else ee(30)}catch(t){if(e)return;K(null),ee(30)}})(),()=>{e=!0}},[Pe]),e.useEffect(()=>{var e,a,i;let s=!1;const r=nt;if(!r.length)return void L([]);const l={fullName:null==(e=t.values.fullName)?void 0:e.trim(),dateOfBirth:t.values.dob,phone:null==(a=t.values.phone)?void 0:a.trim(),healthCardNumber:(null==(i=t.values.healthCardNumber)?void 0:i.trim())||null};if(!l.fullName||!l.dateOfBirth||!l.phone)return void L([]);const o=(t.values.selectedSlots||[]).map((e,t)=>e?{...e,appointmentIndex:e.appointmentIndex??t}:null).filter(Boolean).map(e=>{const t="string"==typeof e.date?e.date.split("T")[0]:e.date,a=`${t}T${e.startTime}:00.000Z`,n=`${t}T${e.endTime}:00.000Z`;return{technicianId:e.technicianId,start:a,end:n,appointmentIndex:e.appointmentIndex}});return function(){_(!0);(async()=>{var e,a;try{let n=0;if((null==g?void 0:g.isEdit)&&null!=(null==(e=null==g?void 0:g.appointmentData)?void 0:e.patientId))n=parseInt(g.appointmentData.patientId,10),(isNaN(n)||n<0)&&(n=0);else{const e=await fetch("https://healthco.clinic/api/fhir/Appointment/check-patient",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({fullName:l.fullName,dateOfBirth:ye(new Date(l.dateOfBirth)),phone:l.phone,healthCardNumber:l.healthCardNumber})});if(!e.ok)throw new Error(`Failed to check patient: ${e.status} ${e.statusText}`);const t=await e.json();if(s)return;(null==t?void 0:t.exists)&&null!=(null==t?void 0:t.patientId)&&(n=parseInt(t.patientId,10)),(isNaN(n)||n<0)&&(n=0)}let d=null;if(Y>0){const e=We[Y-1];e&&e.scanTypeIds&&(d=e.scanTypeIds)}const c=F(),u=await fetch("https://healthco.clinic/api/fhir/Appointment/slots",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({patientId:n,sessionId:c,scanTypeIds:r,appointmentDate:ye(Re),previousAppointmentScanTypeIds:d,appointmentIndex:Y,fullName:l.fullName,gender:t.values.gender??null,dateOfBirth:ye(new Date(l.dateOfBirth)),phone:l.phone,healthCardNumber:l.healthCardNumber,selectedSlots:o,appointmentId:(null==g?void 0:g.isEdit)&&(null==g?void 0:g.appointmentId)?g.appointmentId:void 0})});if(!u.ok){let e=`Failed to fetch slots: ${u.status} ${u.statusText}`;try{const t=await u.json();t&&t.detail&&(e=t.detail)}catch(i){}const t=new Error(e);throw t.status=u.status,t.response=u,t}const p=await u.json();if(s)return;let h=p||[];const m=Ve(G);if(m){h.reduce((e,t)=>{var a;return e+((null==(a=t.slots)?void 0:a.length)||0)},0);h=((e,t,a)=>{if(!t||t===de.ANY_TIME)return e;const n=new Date;let i;switch(t){case de.WITHIN_24_HOURS:i=new Date(n.getTime()+864e5);break;case de.WITHIN_48_HOURS:i=new Date(n.getTime()+1728e5);break;default:return e}return e.map(e=>({...e,slots:e.slots?e.slots.filter(e=>{const[t,n]=e.start.split(":").map(Number),s=new Date(a);return s.setHours(t,n,0,0),s<=i}):[]})).filter(e=>e.slots&&e.slots.length>0)})(h,m.requiredTimeframe,Re);h.reduce((e,t)=>{var a;return e+((null==(a=t.slots)?void 0:a.length)||0)},0);ae(m)}else ae(null);if(Oe(G)&&se){h.reduce((e,t)=>{var a;return e+((null==(a=t.slots)?void 0:a.length)||0)},0);h=((e,t,a)=>t?ze(a,t)?e:[]:e)(h,se,Re);h.reduce((e,t)=>{var a;return e+((null==(a=t.slots)?void 0:a.length)||0)},0)}if(je&&((null==(a=je.dateCriteria)?void 0:a.strictQualification)?je.canBookSlots&&"too_late"!==je.patientStatus&&He(Re,je)||(h=[]):He(Re,je)||(h=[])),h.length>0){t.values.selectedSlots,h.reduce((e,t)=>{var a;return e+((null==(a=t.slots)?void 0:a.length)||0)},0);h=(e=>e)(h);h.reduce((e,t)=>{var a;return e+((null==(a=t.slots)?void 0:a.length)||0)},0)}if(h.length>0){h.reduce((e,t)=>{var a;return e+((null==(a=t.slots)?void 0:a.length)||0)},0);const e=h.map(e=>{var t;const a=(e.slots||[]).filter(e=>!e.status||"Available"===e.status);null==(t=e.slots)||t.length,a.length;return{...e,slots:a}}).filter(e=>e.slots&&e.slots.length>0);e.reduce((e,t)=>{var a;return e+((null==(a=t.slots)?void 0:a.length)||0)},0);h=e}L(h)}catch(d){if(s)return;409===d.status?n.error(d.message||"No technicians available â€” all daily complex scan limits reached."):d.status?n.error(`Failed to load appointment slots (${d.status}). Please try again.`):n.error("Failed to load available appointment slots. Please try again."),L([])}finally{s||_(!1)}})()}(),()=>{s=!0}},[nt,Re,t.values.fullName,t.values.dob,t.values.phone,t.values.healthCardNumber,t.values.gender,G,se,je,Y,We,ke]),e.useEffect(()=>{t.values.selectedSlots||t.setFieldValue("selectedSlots",[])},[t]);const it=t.values.selectedSlots||[],st=it[Y]||null,rt=it.filter(Boolean),lt=rt.length,ot=e.useCallback(async(e,a,i)=>{const s={date:ye(Re),startTime:e.start,endTime:e.end,totalDurationMinutes:e.durationMinutes,technicianId:a,technicianName:i,appointmentIndex:Y,serviceId:null==at?void 0:at.serviceId,serviceName:null==at?void 0:at.serviceName,scanTypeIds:nt},r=xe(s,Y,We,it);if(!r.isValid)return tt(r.error),void setTimeout(()=>tt(null),5e3);const l=be(We,ye(Re),Y,J);if(!l.isValid)return tt(l.error),void setTimeout(()=>tt(null),5e3);try{const n=F(),i=t.values.patientId||0,s=t.values.userId||0,r={technicianId:a,clinicId:Pe,slotDate:ye(new Date(Re)),startTime:e.start,endTime:e.end,patientId:i>0?i:null,sessionId:n,appointmentIndex:Y,createdBy:s,holdMinutes:15,releaseExistingHoldForIndex:!0};await oe.reserveSlot(r)}catch(d){n.error("This slot is on hold, please choose another slot.")}const o=[...it];o[Y]=s,t.setFieldValue("selectedSlots",o),0===Y&&t.setFieldValue("selectedSlot",s),Ne(Re),t.errors.selectedSlots&&t.setFieldError("selectedSlots",void 0),t.errors.selectedSlot&&t.setFieldError("selectedSlot",void 0)},[t,Re,G,Y,at,nt,it,We.length,We,Pe,J]),dt=e.useCallback(()=>{Y<We.length-1&&U(e=>e+1)},[Y,We.length]),ct=e.useCallback(()=>{if(Y>0){const e=Y-1,a=(t.values.selectedSlots||[])[e];if(a&&a.date){const e=Be(a.date);if(e){const t=Math.floor((e.getTime()-M.getTime())/864e5);O(t),Ne(e)}}U(e)}},[Y,t.values.selectedSlots,M]),ut=e.useMemo(()=>{let e;e=ne&&se&&"urgent"===se.patientCategory&&se.requiredTimeframe?se.requiredTimeframe===de.WITHIN_24_HOURS?1:se.requiredTimeframe===de.WITHIN_48_HOURS?2:1:ne&&se&&"early"===se.patientCategory&&se.maxAdvanceBookingDays?se.maxAdvanceBookingDays:te&&te.requiredTimeframe?te.requiredTimeframe===de.WITHIN_24_HOURS?1:te.requiredTimeframe===de.WITHIN_48_HOURS?2:1:X;const a=Array.from({length:e},(e,t)=>$e(M,t));ne&&se&&se.patientCategory,te&&te.requiredTimeframe;const n=ne&&se&&"early"===se.patientCategory,i=null!==Qe(J);let s=null;if(i&&Y>0){const e=(t.values.selectedSlots||[])[0];e&&e.date&&(s=new Date(e.date),s.setHours(0,0,0,0))}const r=a.filter(e=>{let a=!0;if(i&&Y>0&&s){if(!Le(Y,We,J)){const t=new Date(e);if(t.setHours(0,0,0,0),t.getTime()!==s.getTime())return!1}}if(ne&&se&&(a=a&&ze(e,se)),je&&!n&&(a=a&&He(e,je)),a&&We.length>0&&!n){const n=t.values.selectedSlots||[];a=a&&((e,t,a,n)=>{const i=a[t];if(!i||!Array.isArray(i.requiresAfter)||0===i.requiresAfter.length)return!0;let s=null;for(const l of i.requiresAfter){const e=a.findIndex(e=>e.appointmentId===l);if(-1===e)continue;const t=n[e];if(!t||!t.date)continue;const i=new Date("string"==typeof t.date?t.date.split("T")[0]:t.date);i.setHours(0,0,0,0),(!s||i>s)&&(s=i)}if(!s)return!0;const r=new Date(e);return r.setHours(0,0,0,0),r>=s})(e,Y,We,n)}if(a&&J&&We.length>0){const n=t.values.selectedSlots||[];a=a&&Ye(e,Y,We,n,J)}if(n&&a){const t=new Date;t.setHours(0,0,0,0);const n=new Date(e);n.setHours(0,0,0,0),a=n>=t}return a});return ne&&se&&se.patientCategory,te&&te.requiredTimeframe,r},[M,X,ne,se,te,je,Y,We,t.values.selectedSlots,G,J]);e.useEffect(()=>{if(ut.length>0){$e(M,V);if(!ut.some(e=>Math.floor((e.getTime()-M.getTime())/864e5)===V)){const e=ut[0],t=Math.floor((e.getTime()-M.getTime())/864e5);O(t),Ne(e)}}},[ut,V,M]);return We.length?i.jsxs(s,{children:[i.jsx(Z,{icon:r,title:We.length>1?`Date & Time - Appointment ${Y+1} of ${We.length}`:"Date & Time",subtitle:Ee.length>1?`Schedule your ${null==at?void 0:at.serviceName} appointment`:"Choose a date and select an available time slot"}),i.jsxs(s,{sx:{mb:3,p:2,backgroundColor:"#f8fafc",borderRadius:2},children:[i.jsxs(s,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[i.jsx(l,{variant:"subtitle2",sx:{fontWeight:600},children:Ee.length>1?"Scheduling Multiple Appointments":"Scheduling Appointment"}),Ee.length>1&&i.jsxs(s,{sx:{display:"flex",gap:1},children:[i.jsx(d,{size:"small",disabled:0===Y,onClick:ct,sx:{textTransform:"none"},children:"â† Previous"}),i.jsx(d,{size:"small",disabled:Y===We.length-1||!st,onClick:dt,sx:{textTransform:"none"},children:"Next â†’"})]})]}),i.jsxs(s,{sx:{mb:2},children:[i.jsxs(l,{variant:"body2",sx:{fontWeight:600,color:$||"#1976d2"},children:[We.length>1?"Current: ":"Service: ",null==at?void 0:at.serviceName,st&&i.jsxs("span",{style:{color:"#059669",marginLeft:8},children:["âœ“ Scheduled for ",Me(st.date)," at ",st.startTime]})]}),i.jsxs(l,{variant:"body2",sx:{color:"#6b7280"},children:["Scan(s) : ",null==at?void 0:at.scans.map(e=>e.scanTypeName).join(", ")]})]}),We.length>1&&i.jsx(s,{sx:{display:"flex",gap:1,mb:2},children:We.map((e,t)=>i.jsx(s,{sx:{flex:1,height:4,backgroundColor:t<=Y?$||"#2563eb":"#e5e7eb",borderRadius:2,transition:"background-color 0.3s"}},t))}),Je&&Je.errors.length>0&&i.jsxs(s,{sx:{mb:2,p:2,backgroundColor:"#fef2f2",borderRadius:2,border:"1px solid #f87171"},children:[i.jsx(l,{variant:"caption",sx:{fontWeight:600,color:"#dc2626"},children:"Scheduling Errors:"}),Je.errors.map((e,t)=>i.jsxs(l,{variant:"caption",sx:{display:"block",color:"#dc2626"},children:["â€¢ ",e]},t))]}),rt.length>0&&i.jsxs(s,{children:[i.jsx(l,{variant:"caption",sx:{fontWeight:600,color:"#374151"},children:We.length>1?"Scheduled Appointments:":"Scheduled Appointment:"}),rt.map((e,t)=>{const a="number"==typeof e.appointmentIndex?e.appointmentIndex+1:t+1;return i.jsxs(l,{variant:"caption",sx:{display:"block",color:"#6b7280"},children:[We.length>1?`${a}. `:"",e.serviceName," - ",Me(e.date)," at ",e.startTime," with ",e.technicianName," (",e.totalDurationMinutes," min)"]},`${e.serviceId}-${e.startTime}-${t}`)})]})]}),i.jsx(s,{sx:{mb:2},children:i.jsx(s,{sx:{display:"flex",gap:1,overflowX:"auto",pb:1},children:ut.map((e,t)=>{const a=Math.floor((e.getTime()-M.getTime())/864e5),n=a===V,r=0===e.getDay()||6===e.getDay();return i.jsx(d,{size:"small",variant:n?"contained":"outlined",onClick:()=>{O(a),Ne(e)},sx:{flexShrink:0,minWidth:100,borderRadius:2,fontSize:"0.75rem",backgroundColor:n?$||"#2563eb":"white",borderColor:n?$||"#2563eb":"#d1d5db",color:n?"#fff":r?"#ef4444":"#111827","&:hover":{backgroundColor:n?$||"#1d4ed8":B||"#f1f5f9",borderColor:n?$||"#1d4ed8":B?"#fff":"#d1d5db",color:n||B?"#fff":r?"#ef4444":"#111827"}},children:i.jsxs(s,{sx:{display:"flex",flexDirection:"column",lineHeight:1},children:[i.jsx("span",{children:e.toLocaleDateString(void 0,{weekday:"short"})}),i.jsx("span",{style:{fontWeight:700},children:e.getDate()}),i.jsx("span",{children:e.toLocaleDateString(void 0,{month:"short"})})]})},t)})})}),i.jsxs(s,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:1},children:[i.jsx(l,{variant:"subtitle2",sx:{fontWeight:600},children:Re.toLocaleDateString(void 0,{weekday:"long",month:"long",day:"numeric"})}),i.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:1},children:[i.jsx(Te,{title:"Previous Day",children:i.jsx("span",{children:i.jsx(c,{size:"small",disabled:ut.findIndex(e=>Math.floor((e.getTime()-M.getTime())/864e5)===V)<=0,onClick:()=>{const e=ut.findIndex(e=>Math.floor((e.getTime()-M.getTime())/864e5)===V);if(e>0){const t=ut[e-1],a=Math.floor((t.getTime()-M.getTime())/864e5);O(a),Ne(t)}},children:i.jsx(u,{size:18})})})}),i.jsx(Te,{title:"Next Day",children:i.jsx(c,{size:"small",disabled:(()=>{const e=ut.findIndex(e=>Math.floor((e.getTime()-M.getTime())/864e5)===V);return e>=ut.length-1||-1===e})(),onClick:()=>{const e=ut.findIndex(e=>Math.floor((e.getTime()-M.getTime())/864e5)===V);if(e>=0&&e<ut.length-1){const t=ut[e+1],a=Math.floor((t.getTime()-M.getTime())/864e5);O(a),Ne(t)}},children:i.jsx(p,{size:18})})}),i.jsx(Te,{title:"Refresh Available Slots",children:i.jsx("span",{children:i.jsx(c,{size:"small",disabled:H,onClick:()=>{L([]),_(!0),we(e=>e+1)},children:i.jsx(h,{size:16})})})})]})]}),i.jsx(m,{sx:{mb:2}}),te&&i.jsxs(s,{sx:{mb:2,p:2,backgroundColor:"#fef2f2",borderRadius:2,border:"1px solid #f87171"},children:[i.jsx(l,{variant:"body2",sx:{color:"#dc2626",fontWeight:600,mb:1},children:"ðŸš¨ High Priority Booking Rule Active"}),i.jsxs(l,{variant:"body2",sx:{color:"#dc2626"},children:["This scan is classified as an ",i.jsx("strong",{children:"OB High-Risk Scan"}),". Only appointments"," ",(null==(T=ce[te.requiredTimeframe])?void 0:T.toLowerCase())||"within the allowed timeframe"," are shown."]}),te.description&&i.jsx(l,{variant:"caption",sx:{color:"#7f1d1d",display:"block",mt:.5,fontStyle:"italic"},children:te.description})]}),ne&&se&&i.jsxs(s,{sx:{mb:2,p:2,backgroundColor:$?Fe($,.1):"#f0f9ff",borderRadius:2,border:`1px solid ${$||"#3b82f6"}`},children:[i.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:1,mb:1},children:[i.jsx(f,{size:16,color:$||"#1e40af"}),i.jsx(l,{variant:"body2",sx:{color:$||"#1e40af",fontWeight:600},children:"NT Scan Booking Rule Active"})]}),le&&i.jsxs(l,{variant:"body2",sx:{color:$||"#1e40af",mb:1},children:["Current gestational age: ",i.jsxs("strong",{children:[le," days"]})," (~",Math.floor(le/7)," weeks)"]}),"early"===se.patientCategory&&i.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:1},children:[i.jsx(y,{size:14,color:"#059669"}),i.jsxs(l,{variant:"body2",sx:{color:"#059669"},children:[i.jsx("strong",{children:"Early Booking Available:"})," You can book appointments up to ",se.maxAdvanceBookingDays," days in advance for your NT scan."]})]}),"urgent"===se.patientCategory&&i.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:1},children:[i.jsx(x,{size:14,color:"#dc2626"}),i.jsxs(l,{variant:"body2",sx:{color:"#dc2626"},children:[i.jsx("strong",{children:"Urgent Booking Required:"})," You are in the urgent gestational age window. Only appointments"," ",(null==(S=ce[se.requiredTimeframe])?void 0:S.toLowerCase())||"within the allowed timeframe"," are shown."]})]}),"normal"===se.patientCategory&&i.jsxs(l,{variant:"body2",sx:{color:$||"#1e40af"},children:[i.jsx("strong",{children:"Standard NT Scan Window:"})," Available dates are between ",se.minGestationalDays," -"," ",se.maxGestationalDays," days (",Math.floor(se.minGestationalDays/7),"-",Math.floor(se.maxGestationalDays/7)," weeks) gestational age."]}),ne.description&&i.jsx(l,{variant:"caption",sx:{color:$||"#1e3a8a",display:"block",mt:.5,fontStyle:"italic"},children:ne.description})]}),je&&i.jsxs(s,{sx:{mb:2,p:2,backgroundColor:"too_late"===je.patientStatus?"#fef2f2":"too_early"===je.patientStatus?"#fef3c7":"#f0fdf4",borderRadius:2,border:"too_late"===je.patientStatus?"1px solid #f87171":"too_early"===je.patientStatus?"1px solid #f59e0b":"1px solid #bbf7d0"},children:[i.jsx(l,{variant:"body2",sx:{color:"too_late"===je.patientStatus&&(null==(j=je.dateCriteria)?void 0:j.strictQualification)?"#dc2626":"too_late"!==je.patientStatus||(null==(I=je.dateCriteria)?void 0:I.strictQualification)?"too_early"===je.patientStatus?"#92400e":"#059669":"#f59e0b",fontWeight:600,mb:1},children:"too_late"===je.patientStatus&&(null==(C=je.dateCriteria)?void 0:C.strictQualification)?"Please Contact Clinic":"too_late"!==je.patientStatus||(null==(N=je.dateCriteria)?void 0:N.strictQualification)?"too_early"===je.patientStatus?"Early Gestational Age":"Gestational Age Requirements Met":"Contact Clinic Recommended"}),i.jsx(l,{variant:"body2",sx:{color:"too_late"===je.patientStatus&&(null==(k=je.dateCriteria)?void 0:k.strictQualification)?"#dc2626":"too_late"!==je.patientStatus||(null==(w=je.dateCriteria)?void 0:w.strictQualification)?"too_early"===je.patientStatus?"#92400e":"#059669":"#f59e0b",mb:1},children:je.message}),"too_late"===je.patientStatus&&(null==(D=je.dateCriteria)?void 0:D.strictQualification)&&i.jsx(l,{variant:"body2",sx:{color:"#7f1d1d",fontStyle:"italic"},children:"Please contact the clinic directly to discuss your options for this scan."}),"too_late"===je.patientStatus&&!(null==(q=je.dateCriteria)?void 0:q.strictQualification)&&i.jsx(l,{variant:"body2",children:"You may still book appointments, but contacting the clinic is recommended for guidance."}),"too_early"===je.patientStatus&&je.earliestValidDate&&i.jsxs(l,{variant:"caption",sx:{color:"#92400e",display:"block",mt:1,fontStyle:"italic"},children:["Earliest booking date: ",je.earliestValidDate.toLocaleDateString(),je.latestValidDate&&je.latestValidDate.getTime()!==je.earliestValidDate.getTime()&&` - Latest: ${je.latestValidDate.toLocaleDateString()}`]}),"within_range"===je.patientStatus&&je.latestValidDate&&i.jsxs(l,{variant:"caption",sx:{color:"#059669",display:"block",mt:1,fontStyle:"italic"},children:["Book by: ",je.latestValidDate.toLocaleDateString()," to stay within optimal range"]}),je.questionText&&i.jsxs(l,{variant:"caption",sx:{color:"#6b7280",display:"block",mt:1,fontStyle:"italic"},children:['Based on: "',je.questionText,'"']})]}),H?i.jsx(l,{sx:{color:"#6b7280",py:4},children:"Loading available slots..."}):(null==(A=t.values.fullName)?void 0:A.trim())&&t.values.dob&&(null==(R=t.values.phone)?void 0:R.trim())?0===Q.length?i.jsxs(s,{sx:{py:4,textAlign:"center"},children:[(()=>{const e=null!==Qe(J),t=Le(Y,We,J);if(1===ut.length&&Y>0&&e&&!t)return i.jsxs(i.Fragment,{children:[i.jsx(l,{sx:{color:"#f59e0b",mb:1,fontWeight:600},children:"No slots available"}),i.jsx(l,{variant:"body2",sx:{color:"#6b7280"},children:"Please select a different date, as no appointment slots are available on the chosen date."})]})})(),je&&"too_late"===je.patientStatus&&(null==(P=je.dateCriteria)?void 0:P.strictQualification)?i.jsxs(i.Fragment,{children:[i.jsx(l,{sx:{color:"#dc2626",mb:1,fontWeight:600},children:"Please Contact Clinic"}),i.jsx(l,{variant:"body2",sx:{color:"#6b7280"},children:"Your gestational age is beyond the recommended range for this scan."}),i.jsx(l,{variant:"body2",sx:{color:"#6b7280",mt:1},children:"Please contact the clinic directly to discuss your options."})]}):je&&!je.canBookSlots&&(null==(E=je.dateCriteria)?void 0:E.strictQualification)?i.jsxs(i.Fragment,{children:[i.jsx(l,{sx:{color:"#f59e0b",mb:1,fontWeight:600},children:"Booking not available"}),i.jsx(l,{variant:"body2",sx:{color:"#6b7280"},children:"Based on your gestational age, booking is not currently available for this scan."}),i.jsx(l,{variant:"body2",sx:{color:"#6b7280",mt:1},children:"Please check the gestational age requirements above."})]}):je&&"too_early"===je.patientStatus?i.jsxs(i.Fragment,{children:[i.jsx(l,{sx:{color:"#f59e0b",mb:1,fontWeight:600},children:"No slots available for this date"}),i.jsx(l,{variant:"body2",sx:{color:"#6b7280"},children:"The selected date is too early based on your gestational age."}),i.jsx(l,{variant:"body2",sx:{color:"#6b7280",mt:1},children:"Please select a later date within the valid booking window shown above."})]}):te?i.jsxs(i.Fragment,{children:[i.jsx(l,{sx:{color:"#dc2626",mb:1,fontWeight:600},children:"Please Contact Clinic"}),i.jsx(l,{variant:"body2",sx:{color:"#6b7280"},children:"No slots are available for this OB High-Risk scan on the selected date."}),i.jsx(l,{variant:"body2",sx:{color:"#6b7280",mt:1},children:"Please contact the clinic directly to schedule your appointment, as special arrangements may be needed for urgent cases."})]}):ne&&se&&"urgent"===se.patientCategory?i.jsxs(i.Fragment,{children:[i.jsx(l,{sx:{color:"#dc2626",mb:1,fontWeight:600},children:"Please Contact Clinic"}),i.jsx(l,{variant:"body2",sx:{color:"#6b7280"},children:"No slots are available for this urgent NT scan on the selected date."}),i.jsx(l,{variant:"body2",sx:{color:"#6b7280",mt:1},children:"Please contact the clinic directly to schedule your appointment, as urgent NT scans require special scheduling arrangements."})]}):(()=>{const e=new Date,t=Math.ceil((Re-e)/864e5)>7,a=G.some(e=>{const t=(null==e?void 0:e.bookingRules)||(null==e?void 0:e.BookingRules);return t&&Array.isArray(t)&&t.some(e=>e.ruleType===ue.OB_HIGH_RISK&&e.isEnabled)});return t&&a?i.jsxs(i.Fragment,{children:[i.jsx(l,{sx:{color:"#dc2626",mb:1,fontWeight:600},children:"Please Contact Clinic"}),i.jsx(l,{variant:"body2",sx:{color:"#6b7280"},children:"For appointments more than a week in advance, especially for OB High-Risk scans, please contact the clinic directly."}),i.jsx(l,{variant:"body2",sx:{color:"#6b7280",mt:1},children:"The clinic can better accommodate your specific scheduling needs and provide appropriate care coordination."})]}):i.jsxs(i.Fragment,{children:[i.jsx(l,{sx:{color:"#ef4444",mb:1,fontWeight:600},children:"No slots available for this date"}),i.jsx(l,{variant:"body2",sx:{color:"#6b7280"},children:"This could be due to:"}),i.jsx(l,{variant:"body2",sx:{color:"#6b7280"},children:"â€¢ No technicians available for selected scans"}),i.jsx(l,{variant:"body2",sx:{color:"#6b7280"},children:"â€¢ No available time slots for the selected date"}),i.jsx(l,{variant:"body2",sx:{color:"#6b7280"},children:"â€¢ Patient information validation issues"})]})})()]}):i.jsxs(s,{sx:{display:"flex",flexDirection:"column",gap:3},children:[et&&i.jsxs(s,{sx:{p:2,backgroundColor:"#fef2f2",borderRadius:2,border:"1px solid #f87171"},children:[i.jsx(l,{variant:"body2",sx:{color:"#dc2626",fontWeight:600},children:"Invalid Selection"}),i.jsx(l,{variant:"body2",sx:{color:"#dc2626"},children:et})]}),(()=>{const e=Q.reduce((e,t)=>{if(t.slots&&t.slots.length>0){const a=t.slots.map((e,a)=>({...e,technicianId:t.technicianId,technicianName:t.technicianName,originalIndex:a}));e.push(...a)}return e},[]);return e.sort((e,t)=>e.start.localeCompare(t.start)),e.length,i.jsx(s,{children:e.length>0?i.jsx(s,{sx:{display:"grid",gridTemplateColumns:{xs:"repeat(auto-fill,minmax(120px,1fr))",sm:"repeat(auto-fill,minmax(130px,1fr))"},gap:1.5},children:e.map((e,t)=>{const a=((e,t)=>st&&st.date===ye(Re)&&st.startTime===e.start&&st.endTime===e.end&&st.technicianId===t)(e,e.technicianId),n=(e=>{if(e.status&&"Available"!==e.status)return!1;const t={date:ye(Re),startTime:e.start,endTime:e.end};return!!xe(t,Y,We,it).isValid&&be(We,ye(Re),Y,J).isValid})(e,e.technicianId),r=!n;return i.jsxs(s,{role:"button",tabIndex:r?-1:0,onClick:r?void 0:()=>ot(e,e.technicianId,e.technicianName),onKeyDown:r?void 0:t=>"Enter"===t.key&&ot(e,e.technicianId,e.technicianName),title:r?"This time slot conflicts with sequential appointment requirements":void 0,sx:{p:1.5,borderRadius:2,border:"1px solid",cursor:r?"not-allowed":"pointer",userSelect:"none",background:r?"linear-gradient(180deg,#f3f4f6,#e5e7eb)":a?$||"linear-gradient(180deg,#2563eb,#1d4ed8)":"linear-gradient(180deg,#ffffff,#f9fafb)",color:r?"#9ca3af":a?"#fff":"#111827",borderColor:r?"#d1d5db":a?$||"#1d4ed8":"#e5e7eb",fontSize:"0.75rem",fontWeight:600,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:.25,transition:"all .25s cubic-bezier(.4,0,.2,1)",boxShadow:r?"none":a?`0 4px 14px -2px ${$?Fe($,.5):"rgba(37,99,235,0.5)"}`:"0 1px 3px rgba(0,0,0,0.08)",opacity:r?.5:1,"&:hover":r?{}:{borderColor:a?$||"#1d4ed8":$||"#2563eb",boxShadow:`0 6px 18px -2px ${$?Fe($,.35):"rgba(37,99,235,0.35)"}`,transform:"translateY(-2px)"},"&:active":r?{}:{transform:"translateY(0)",boxShadow:"0 2px 6px rgba(0,0,0,0.18)"}},children:[i.jsxs("span",{style:{fontWeight:700,whiteSpace:"nowrap",textAlign:"center"},children:[e.start," - ",e.end]}),r&&i.jsx("span",{style:{fontSize:"0.65rem",opacity:.7},children:"âŒ"})]},`${e.technicianId}-${e.originalIndex}`)})}):i.jsx(l,{variant:"body2",sx:{color:"#9ca3af",fontStyle:"italic"},children:"No slots available"})})})()]}):i.jsxs(s,{sx:{py:4,textAlign:"center"},children:[i.jsx(l,{sx:{color:"#f59e0b",mb:1,fontWeight:600},children:"Patient information required"}),i.jsx(l,{variant:"body2",sx:{color:"#6b7280"},children:"Please complete the patient information in the previous step to view available time slots."}),i.jsx(l,{variant:"body2",sx:{color:"#6b7280",mt:1},children:"Required: Full Name, Date of Birth, and Phone Number"})]}),t.touched.selectedSlot&&t.errors.selectedSlot||t.touched.selectedSlots&&t.errors.selectedSlots?i.jsx(l,{variant:"caption",color:"error",sx:{mt:1,display:"block"},children:t.errors.selectedSlot||t.errors.selectedSlots}):null,st&&i.jsxs(s,{sx:{mt:3,p:2,backgroundColor:$?Fe($,.1):"#f0f9ff",borderRadius:2,border:`1px solid ${$||"#3b82f6"}`},children:[i.jsxs(l,{variant:"body2",sx:{color:$||"#1e40af",fontWeight:600,mb:2},children:["Appointment ",Y+1," of ",We.length," selected. This slot will be reserved when you confirm all appointments."]}),i.jsxs(l,{variant:"body2",sx:{color:$||"#1e40af"},children:[i.jsx("b",{children:"Service"})," : ",st.serviceName]}),i.jsxs(l,{variant:"body2",sx:{color:$||"#1e40af"},children:[i.jsx("b",{children:"Scan(s)"})," : ",null==at?void 0:at.scans.map(e=>e.scanTypeName).join(", ")]}),i.jsxs(l,{variant:"body2",sx:{color:$||"#1e40af"},children:[i.jsx("b",{children:"Date & Time"})," : ",Me(st.date)," at ",st.startTime," -"," ",st.endTime]}),i.jsxs(l,{variant:"body2",sx:{color:$||"#1e40af"},children:[i.jsx("b",{children:"Duration"})," : ",st.totalDurationMinutes," minutes"]}),i.jsxs(l,{variant:"body2",sx:{color:$||"#1e40af"},children:[i.jsx("b",{children:"Technician"})," : ",st.technicianName]})]}),We.length>1&&i.jsxs(s,{sx:{mt:3,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[i.jsx(d,{variant:"outlined",onClick:ct,disabled:0===Y,sx:{textTransform:"none",borderRadius:"8px",px:3,py:1,visibility:0===Y?"hidden":"visible"},children:"â† Previous Appointment"}),i.jsxs(s,{sx:{textAlign:"center"},children:[i.jsxs(l,{variant:"body2",sx:{color:"#6b7280",mb:1},children:["Appointment ",Y+1," of ",We.length]}),i.jsx(l,{variant:"caption",sx:{color:"#9ca3af"},children:null==at?void 0:at.serviceName})]}),i.jsx(d,{variant:"contained",onClick:dt,disabled:!st||Y>=We.length-1,sx:{textTransform:"none",borderRadius:"8px",px:3,py:1,backgroundColor:st?$||"#3b82f6":"#9ca3af","&:hover":{backgroundColor:st?$||"#2563eb":"#9ca3af"},visibility:Y>=We.length-1?"hidden":"visible"},children:st?"Next Appointment â†’":"Select Slot First"})]}),We.length>1&&lt===We.length?i.jsxs(s,{sx:{mt:3,p:2,backgroundColor:"#f0fdf4",borderRadius:2,border:"1px solid #bbf7d0"},children:[i.jsxs(l,{variant:"body2",sx:{color:"#059669",fontWeight:600,mb:2},children:["All ",We.length,' appointments scheduled! Use the "Book All Appointments" button to confirm your bookings.']}),i.jsx(s,{sx:{ml:2},children:rt.map((e,t)=>i.jsxs(l,{variant:"caption",sx:{display:"block",color:"#059669",mb:.5},children:[t+1,". ",e.serviceName," - ",Me(e.date)," at ",e.startTime," (",e.totalDurationMinutes," min)"]},`summary-${e.serviceId}-${e.startTime}-${t}`))})]}):We.length>1?i.jsxs(l,{variant:"caption",sx:{mt:2,display:"block",color:"#6b7280"},children:["Scheduling appointment ",Y+1," of ",We.length,".",st?' Use "Next Appointment" to continue scheduling, or navigate between appointments using the buttons above.':" Select a time slot for this appointment to continue."]}):i.jsx(l,{variant:"caption",sx:{mt:2,display:"block",color:"#6b7280"},children:'Select your preferred slot. You will confirm the booking using the "Book Appointment" button.'})]}):i.jsxs(s,{children:[i.jsx(Z,{icon:r,title:"Date & Time",subtitle:"Choose a date and select an available time slot"}),Ze?i.jsxs(s,{sx:{p:3,backgroundColor:"#fef2f2",borderRadius:2,border:"1px solid #f87171"},children:[i.jsx(l,{variant:"body2",sx:{color:"#dc2626",fontWeight:600},children:"Appointment Splitting Error"}),i.jsx(l,{variant:"body2",sx:{color:"#dc2626"},children:Ze})]}):i.jsx(o,{})]})};Ue.propTypes={formikProps:b.object.isRequired,clinicId:b.oneOfType([b.string,b.number]),editState:b.shape({isEdit:b.bool,appointmentId:b.oneOfType([b.string,b.number]),appointmentData:b.object,loading:b.bool})};const Je=({coverageType:e=we,onCoverageTypeChange:t,healthCardId:n="",onHealthCardIdChange:r,healthCardProvince:o="",onHealthCardProvinceChange:d,provinces:c=[],isLoadingProvinces:u=!1,uciNumber:p="",onUciNumberChange:h,errors:m={},disabled:f=!1,sx:y={},showProvince:x=!0,showNoneOption:b=!0,isProvinceRequired:I=!1})=>{const C=a(),N=(null==C?void 0:C.isPublic)&&(null==C?void 0:C.primary)?C.primary:void 0,k=N?{color:N,"&.Mui-checked":{color:N}}:void 0,w={"& .MuiOutlinedInput-root":{borderRadius:"8px",backgroundColor:"#ffffff",height:40},...N?{"& .MuiOutlinedInput-root:not(.Mui-error):hover .MuiOutlinedInput-notchedOutline":{borderColor:N},"& .MuiOutlinedInput-root.Mui-focused:not(.Mui-error) .MuiOutlinedInput-notchedOutline":{borderColor:N}}:{}};return i.jsxs(s,{sx:{...y,border:"1px solid #e5e7eb",borderRadius:"8px",p:2},children:[i.jsx(l,{variant:"body1",sx:{color:"#374151",fontWeight:500},children:"Are you covered under?"}),i.jsxs(g,{value:e,onChange:e=>null==t?void 0:t(parseInt(e.target.value,10)),sx:{display:"flex",flexDirection:"row",gap:2},children:[i.jsx(v,{value:we,control:i.jsx(T,{disabled:f,sx:k}),label:"Health card",sx:{mb:.5}}),i.jsx(v,{value:De,control:i.jsx(T,{disabled:f,sx:k}),label:"IFHP",sx:{mb:.5}}),b&&i.jsx(v,{value:ke,control:i.jsx(T,{disabled:f,sx:k}),label:"None"})]}),e===we&&i.jsxs(s,{sx:{display:"flex",gap:3,flexDirection:{xs:"column",sm:"row"}},children:[i.jsxs(s,{sx:{flex:1},children:[i.jsx(l,{variant:"body2",sx:{mb:.5,color:"#374151",fontWeight:500},children:"Health Card ID"}),i.jsx(S,{fullWidth:!0,value:n,onChange:e=>null==r?void 0:r(e.target.value),placeholder:"Enter Health Card ID",error:!!m.healthCardId,helperText:m.healthCardId,disabled:f,sx:w})]}),x&&i.jsxs(s,{sx:{flex:1},children:[i.jsxs(l,{variant:"body2",sx:{mb:.5,color:"#374151",fontWeight:500},children:["Health Card Province ",I&&i.jsx("span",{style:{color:"#ef4444"},children:"*"})]}),i.jsx(S,{select:!0,fullWidth:!0,value:o,onChange:e=>null==d?void 0:d(e.target.value),placeholder:"Select Province",error:!!m.healthCardProvince,helperText:m.healthCardProvince,disabled:f||u,sx:w,children:u?i.jsx(j,{disabled:!0,children:"Loading provinces..."}):c.map(e=>i.jsx(j,{value:e.provinceId,children:e.provinceName},e.provinceId))})]})]}),e===De&&i.jsxs(s,{children:[i.jsx(l,{variant:"body2",sx:{mb:.5,color:"#374151",fontWeight:500},children:"UCI Number"}),i.jsx(S,{fullWidth:!0,value:p,onChange:e=>null==h?void 0:h(e.target.value),placeholder:"Enter UCI Number",error:!!m.uciNumber,helperText:m.uciNumber,disabled:f,sx:{...w,maxWidth:{xs:"100%",sm:400}}})]}),e===ke&&i.jsx(s,{sx:{p:2,borderRadius:"8px",backgroundColor:"#f9fafb",border:"1px solid #e5e7eb"},children:i.jsx(l,{variant:"body2",sx:{color:"#6b7280"},children:"This will be a paid service since you are not covered by any health benefits."})})]})};Je.propTypes={coverageType:b.oneOf([ke,we,De]),onCoverageTypeChange:b.func,healthCardId:b.string,onHealthCardIdChange:b.func,healthCardProvince:b.oneOfType([b.string,b.number]),onHealthCardProvinceChange:b.func,provinces:b.arrayOf(b.shape({provinceId:b.number.isRequired,provinceName:b.string.isRequired})),isLoadingProvinces:b.bool,uciNumber:b.string,onUciNumberChange:b.func,errors:b.shape({healthCardId:b.string,healthCardProvince:b.string,uciNumber:b.string}),disabled:b.bool,sx:b.object,showProvince:b.bool,showNoneOption:b.bool,isProvinceRequired:b.bool};const Ke=({title:e,description:t,icon:a,brandColor:n})=>{const r=n||"#2563eb",o=n?`${n}08`:"#f8fbff",d=n?`${n}33`:"#dbeafe",c=n?`${n}1a`:"#e6f7ff",u=n?`${n}4d`:"#bfdbfe",p=n||"#1656e0ff";return i.jsx(I,{icon:!1,sx:{mt:3,borderRadius:2,background:o,border:`1px solid ${d}`,display:"flex",alignItems:"flex-start",py:2,px:{xs:2,md:3}},children:i.jsxs(s,{sx:{display:"flex",gap:2,alignItems:"flex-start",width:"100%"},children:[a&&i.jsx(s,{sx:{width:30,height:30,borderRadius:"50%",background:c,border:`1px solid ${u}`,display:"flex",alignItems:"center",justifyContent:"center"},children:i.jsx(a,{size:15,style:{color:r}})}),i.jsxs(s,{sx:{flex:1},children:[i.jsx(l,{sx:{fontWeight:700,fontSize:{xs:".90rem",md:".95rem"},color:p,mb:.5},children:e}),i.jsx(l,{sx:{color:r,fontSize:{xs:".85rem",md:".80rem"},lineHeight:1.45},children:t})]})]})})};Ke.propTypes={title:b.node,description:b.node,icon:b.elementType,brandColor:b.string};const Ze=({formikProps:n,editState:r,clinicId:o,onSavePatientInfo:c,isSubmitting:u,isPublicBooking:p=!1})=>{const h=a(),m=(null==h?void 0:h.isPublic)&&(null==h?void 0:h.primary)?h.primary:null,f=(null==h?void 0:h.isPublic)&&(null==h?void 0:h.secondary)?h.secondary:null,y=null==r?void 0:r.isEdit,[x,b]=e.useState([]),[g,v]=e.useState(!0),[T,I]=e.useState(null),{provinces:R,isLoading:P}=je(1);e.useEffect(()=>{(async()=>{if(o)try{v(!0),I(null);const e=await t.get(`https://healthco.clinic/api/fhir/Appointment/GetPatientFormFields/${o}`);e.data&&e.data.fields&&b(e.data.fields)}catch(e){I("Failed to load form configuration, make sure clinic's calendar is set up."),b([{fieldName:"name",enabled:!0,required:!0},{fieldName:"email",enabled:!0,required:!1},{fieldName:"phone",enabled:!0,required:!0},{fieldName:"gender",enabled:!0,required:!1},{fieldName:"dateOfBirth",enabled:!0,required:!0},{fieldName:"healthCardNumber",enabled:!0,required:!1},{fieldName:"identifyAs",enabled:!0,required:!1}])}finally{v(!1)}else v(!1)})()},[o]),e.useEffect(()=>{if(!y&&(null===n.values.gender||void 0===n.values.gender||""===n.values.gender)){const e=x.find(e=>"gender"===e.fieldName);(null==e?void 0:e.enabled)&&n.setFieldValue("gender",X.MALE_ONLY)}},[x,y,n]);const E=e=>{const t=x.find(t=>t.fieldName===e);return{enabled:(null==t?void 0:t.enabled)??!0,required:(null==t?void 0:t.required)??!1}},F={name:{key:"fullName",label:"Full Name",placeholder:"Enter your full name",type:"text"},email:{key:"email",label:"Email Address",placeholder:"your.email@example.com",type:"email"},phone:{key:"phone",label:"Phone Number",placeholder:"+1 (555) 123-4567",type:"tel"},gender:{key:"gender",label:"Gender at Birth",placeholder:"Select gender",type:"select",options:[{value:X.MALE_ONLY,label:"Male"},{value:X.FEMALE_ONLY,label:"Female"},{value:X.OTHER,label:"Other"}]},identifyAs:{key:"identifyAs",label:"Identify As",placeholder:"Select identity",type:"select",options:[{value:ee.NOT_SPECIFIED,label:"Not Specified"},{value:ee.HE,label:"He / Him"},{value:ee.SHE,label:"She / Her"},{value:ee.THEM,label:"They / Them"},{value:ee.OTHER,label:"Other"}]},dateOfBirth:{key:"dob",label:"Date of Birth",placeholder:"",type:"date"},allergies:{key:"allergies",label:"Allergies",placeholder:"List any allergies",type:"textarea"},medicalNotes:{key:"medicalNotes",label:"Medical Notes",placeholder:"Additional medical information",type:"textarea"}},W=["name","email","phone","gender","identifyAs","dateOfBirth","allergies","medicalNotes"];return i.jsx(s,{sx:{pt:1,px:{xs:2,sm:3,md:0}},children:i.jsxs(C,{elevation:0,sx:{maxWidth:{xs:"100%",sm:760,md:1040},mx:"auto",overflow:"hidden"},children:[i.jsx(Z,{icon:N,title:"Patient Information",subtitle:y?"Update email address and requisition sheet":"Enter patient personal details"}),y&&i.jsx(s,{sx:{mb:2,p:2,bgcolor:"#f0f9ff",border:"1px solid #0ea5e9",borderRadius:2},children:i.jsxs(l,{variant:"body2",color:"#0c4a6e",children:[i.jsx(k,{style:{display:"inline",marginRight:"4px",verticalAlign:"middle"}}),"In edit mode, you can only update the requisition sheet. All other patient information fields are read-only to maintain data integrity."]})}),g&&i.jsxs(s,{sx:{display:"flex",justifyContent:"center",py:4},children:[i.jsx(w,{size:40}),i.jsx(l,{variant:"body2",sx:{ml:2,alignSelf:"center"},children:"Loading form configuration..."})]}),T&&i.jsx(s,{sx:{mb:2,p:2,bgcolor:"#fee2e2",border:"1px solid #ef4444",borderRadius:2},children:i.jsx(l,{variant:"body2",color:"#dc2626",children:T})}),!g&&i.jsxs(s,{sx:{border:"1px solid #e5e7eb",borderRadius:2,p:{xs:2,md:3},background:"linear-gradient(180deg,#ffffff,#f9fafb)",opacity:1},children:[i.jsxs(s,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",sm:"repeat(2, 1fr)",md:"repeat(2, 1fr)"},columnGap:{xs:1,sm:2,md:3},rowGap:{xs:1.5,sm:1.5,md:2}},children:[W.filter(e=>{const t=x.find(t=>t.fieldName===e);return(null==t?void 0:t.enabled)??!1}).map(e=>(e=>{var t;const a=E(e),r=F[e];if(!a.enabled||!r)return null;const l=r.key,o=n.touched[l]&&n.errors[l],d=y;return i.jsx(s,{children:i.jsx(D,{label:r.label,required:a.required,error:o,children:"select"===r.type?i.jsx(S,{select:!0,fullWidth:!0,size:"small",name:l,value:n.values[l]??"",onChange:n.handleChange,onBlur:n.handleBlur,placeholder:r.placeholder,disabled:d||"healthCardProvince"===l&&P,children:"healthCardProvince"===l&&P?i.jsx(j,{disabled:!0,children:"Loading provinces..."}):null==(t=r.options)?void 0:t.map(e=>i.jsx(j,{value:e.value,children:e.label},e.value))}):"textarea"===r.type?i.jsx(S,{fullWidth:!0,size:"small",name:l,value:n.values[l]||"",onChange:n.handleChange,onBlur:n.handleBlur,placeholder:r.placeholder,disabled:d,multiline:!0,rows:3}):"date"===r.type?i.jsx(te,{name:l,value:n.values[l]||"",onChange:e=>n.setFieldValue(l,e.target.value),onBlur:n.handleBlur,disabled:d,placeholder:r.placeholder||"YYYY-MM-DD"}):"healthCardNumber"===l?i.jsx(S,{fullWidth:!0,size:"small",name:l,value:n.values[l]||"",onChange:e=>{if(!d){let t=e.target.value.toUpperCase();t=t.replace(/[^A-Z0-9]/g,""),t.length<=12&&n.setFieldValue(l,t)}},onBlur:n.handleBlur,placeholder:r.placeholder,disabled:d,inputProps:{maxLength:12,pattern:"[0-9]{10}[A-Z]{2}"}}):i.jsx(S,{fullWidth:!0,size:"small",name:l,type:r.type,value:n.values[l]||"",onChange:n.handleChange,onBlur:n.handleBlur,placeholder:r.placeholder,disabled:d})})},l)})(e)),i.jsx(s,{sx:{gridColumn:{xs:"1 / -1",sm:"span 1",md:"span 1"}},children:i.jsx(D,{label:"Requisition Sheet",required:p,error:n.touched.requisitionSheet&&!!n.errors.requisitionSheet,children:i.jsxs(q,{direction:"row",spacing:2,alignItems:"center",children:[i.jsxs(d,{variant:"outlined",component:"label",size:"small",color:"inherit",sx:{border:"1px solid",borderColor:m||"primary.main",color:m||"primary.main","&:hover":{borderColor:m||"primary.dark",color:m||"primary.dark",backgroundColor:m?`${m}14`:"rgba(0, 0, 0, 0.04)"}},children:["Upload",i.jsx("input",{hidden:!0,type:"file",name:"requisitionSheet",accept:".pdf,.jpg,.jpeg,.png",onChange:e=>{const t=e.currentTarget.files&&e.currentTarget.files[0];if(t){const e=104857600;["application/pdf","image/jpeg","image/png"].includes(t.type)?t.size>e?(n.setFieldError("requisitionSheet","File is too large. Maximum size is 100 MB."),n.setFieldValue("requisitionSheet",null)):(n.setFieldValue("requisitionSheet",t),n.setFieldError("requisitionSheet",void 0)):(n.setFieldError("requisitionSheet","Only PDF, JPG and PNG files are allowed."),n.setFieldValue("requisitionSheet",null)),n.setFieldTouched("requisitionSheet",!0,!1)}}})]}),i.jsxs(q,{children:[i.jsx(l,{variant:"body2",children:n.values.requisitionSheet?i.jsxs(i.Fragment,{children:[n.values.requisitionSheet.name,n.values.requisitionSheet.isExistingDocument&&i.jsx(l,{component:"span",variant:"caption",color:"success.main",sx:{ml:1},children:"(Current document)"})]}):"No file selected"}),i.jsx(A,{error:n.touched.requisitionSheet&&!!n.errors.requisitionSheet,children:n.touched.requisitionSheet&&n.errors.requisitionSheet?n.errors.requisitionSheet:"Accepted: PDF, JPG, PNG â€” max 100 MB"})]}),n.values.requisitionSheet&&i.jsx(d,{variant:"outlined",size:"small",color:"inherit",sx:{border:"1px solid",borderColor:f||"error.main",color:f||"error.main","&:hover":{borderColor:f||"error.dark",color:f||"error.dark",backgroundColor:f?`${f}14`:"rgba(255, 0, 0, 0.04)"}},onClick:()=>{n.setFieldValue("requisitionSheet",null),n.setFieldTouched("requisitionSheet",!1,!1),n.setFieldError("requisitionSheet",void 0)},children:"Clear"})]})})}),E("healthCardNumber").enabled&&i.jsx(s,{sx:{gridColumn:"1 / -1"},children:i.jsx(Je,{coverageType:n.values.coverageType??we,onCoverageTypeChange:e=>{n.setFieldValue("coverageType",e),e===we?n.setFieldValue("uciNumber",""):e===De?(n.setFieldValue("healthCardNumber",""),n.setFieldValue("healthCardProvince","")):e===ke&&(n.setFieldValue("healthCardNumber",""),n.setFieldValue("healthCardProvince",""),n.setFieldValue("uciNumber",""))},healthCardId:n.values.healthCardNumber||"",onHealthCardIdChange:e=>{let t=e.toUpperCase().replace(/[^A-Z0-9]/g,"");t.length<=12&&n.setFieldValue("healthCardNumber",t)},healthCardProvince:n.values.healthCardProvince||"",onHealthCardProvinceChange:e=>n.setFieldValue("healthCardProvince",e),provinces:R||[],isLoadingProvinces:P,uciNumber:n.values.uciNumber||"",onUciNumberChange:e=>n.setFieldValue("uciNumber",e),errors:{healthCardId:n.touched.healthCardNumber&&n.errors.healthCardNumber,healthCardProvince:n.touched.healthCardProvince&&n.errors.healthCardProvince,uciNumber:n.touched.uciNumber&&n.errors.uciNumber},disabled:y,showProvince:E("healthCardProvince").enabled,showNoneOption:!E("healthCardNumber").required,isProvinceRequired:E("healthCardProvince").required})})]}),!y&&i.jsxs(s,{sx:{mt:3,p:2,bgcolor:m?Fe(m,.1):"#f0f9ff",border:`1px solid ${m||"#0ea5e9"}`,borderRadius:2},children:[i.jsx(Se,{checked:n.values.communicationConsent||!1,onChange:e=>{n.setFieldValue("communicationConsent",e.target.checked),n.setFieldTouched("communicationConsent",!0,!1)},checkedColor:m||void 0,label:i.jsx(l,{variant:"body2",sx:{color:m||"#0c4a6e"},children:"I consent to the use of my email address and phone number for appointment-related communication, including confirmations, reminders, and updates."})}),n.touched.communicationConsent&&n.errors.communicationConsent&&i.jsx(A,{error:!0,sx:{ml:4},children:n.errors.communicationConsent})]}),y&&c&&i.jsx(s,{sx:{mt:3,display:"flex",justifyContent:"center"},children:i.jsx(d,{variant:"outlined",onClick:c,disabled:u,sx:{textTransform:"none",borderRadius:"8px",px:4,py:1.5,borderColor:"#3b82f6",color:"#3b82f6","&:hover":{backgroundColor:"rgba(59,130,246,0.1)",borderColor:"#2563eb"},"&.Mui-disabled":{borderColor:"#9ca3af",color:"#9ca3af"}},children:u?i.jsxs(i.Fragment,{children:[i.jsx(w,{size:16,sx:{mr:1}}),"Saving..."]}):"Save Patient Information"})}),i.jsx(Ke,{title:"Your Information is Secure",description:"All personal and medical information is encrypted and stored securely. We comply with healthcare privacy regulations to protect your data.",icon:k,brandColor:m})]})]})})};Ze.propTypes={formikProps:b.object.isRequired,editState:b.shape({isEdit:b.bool,appointmentId:b.oneOfType([b.string,b.number]),appointmentData:b.object,loading:b.bool}),clinicId:b.oneOfType([b.string,b.number]),onSavePatientInfo:b.func,isSubmitting:b.bool,isPublicBooking:b.bool};const Xe=e=>{var t;return(null==(t=null==e?void 0:e.detailedScanType)?void 0:t.bookingRules)?e.detailedScanType.bookingRules.find(e=>e.ruleType===ue.NT_SCAN&&e.isEnabled):null},et=e=>e&&e.isValid?`${e.weeks} weeks${e.remainingDays>0?` ${e.remainingDays} days`:""}`:"Invalid",tt=({scanType:t,onConfirm:a,onCancel:n})=>{const[r,o]=e.useState(""),[c,u]=e.useState(""),p=Xe(t),h=((null==p?void 0:p.earlyGestationalDaysStart)||(null==p||p.minGestationalDays),(null==p?void 0:p.maxGestationalDays)||98),m=(e=>{if(!e)return null;const t=new Date,a=new Date(e),n=Math.floor((a.getTime()-t.getTime())/864e5),i=280-n;return{days:i,weeks:Math.floor(i/7),remainingDays:i%7,daysUntilDue:n,isValid:i>0&&i<300}})(r),f=new Date,y=new Date(f.getTime()-15552e6),x=new Date(f.getTime()+24192e6);return i.jsx(R,{sx:{mt:2,border:"2px solid #3b82f6",borderRadius:3,boxShadow:"0 8px 32px rgba(59, 130, 246, 0.15)",backgroundColor:"#fefbff"},children:i.jsxs(P,{sx:{p:3},children:[i.jsx(s,{sx:{display:"flex",alignItems:"center",gap:2,mb:2},children:i.jsxs(s,{children:[i.jsx(l,{variant:"h6",sx:{color:"#1e40af",fontWeight:600},children:"NT Scan Information Required"}),i.jsx(l,{variant:"body2",sx:{color:"#64748b"},children:(null==t?void 0:t.name)||"NT Scan"})]})}),i.jsx(I,{severity:"info",sx:{mb:3},children:i.jsx(l,{variant:"body2",children:"Please enter your due date so we can determine the best timing for your appointment."})}),i.jsxs(s,{sx:{mb:3},children:[i.jsx(l,{variant:"subtitle2",sx:{mb:1,fontWeight:600},children:"Expected Due Date"}),i.jsx(S,{type:"date",fullWidth:!0,value:r,onChange:e=>{const t=e.target.value;o(t),u("")},InputProps:{startAdornment:i.jsx(s,{sx:{mr:1,display:"flex",alignItems:"center"},children:i.jsx(E,{size:18,color:"#6b7280"})})},inputProps:{min:ye(y).split("T")[0],max:ye(x).split("T")[0]},sx:{"& .MuiOutlinedInput-root":{borderRadius:"8px",backgroundColor:"#ffffff"}},error:!!c,helperText:c})]}),m&&m.isValid&&i.jsxs(s,{sx:{p:2,borderRadius:2,backgroundColor:m.days>h?"#fef2f2":m.days>=h-7?"#fffbeb":"#f0f9ff",border:m.days>h?"1px solid #fecaca":m.days>=h-7?"1px solid #fed7aa":"1px solid #bae6fd",mb:3},children:[i.jsx(l,{variant:"subtitle2",sx:{fontWeight:600,color:m.days>h?"#dc2626":m.days>=h-7?"#d97706":"#0c4a6e",mb:1},children:"Current Gestational Age"}),i.jsx(l,{variant:"body1",sx:{color:m.days>h?"#dc2626":m.days>=h-7?"#d97706":"#0369a1",fontWeight:500},children:et(m)}),i.jsx(l,{variant:"caption",sx:{color:m.days>h?"#dc2626":m.days>=h-7?"#d97706":"#0284c7",display:"block",mt:.5},children:m.days>h?`This exceeds the maximum gestational age (${h} days / ${Math.floor(h/7)} weeks) for NT scans`:m.days>=h-7?`You are approaching the maximum gestational age limit (${h} days / ${Math.floor(h/7)} weeks) for NT scans`:`Based on your due date, you are currently at ${m.days} days of pregnancy`})]}),i.jsxs(s,{sx:{display:"flex",gap:2,justifyContent:"flex-end"},children:[i.jsx(d,{variant:"outlined",onClick:n,sx:{borderRadius:"8px",textTransform:"none",fontWeight:500},children:"Cancel"}),i.jsx(d,{variant:"contained",onClick:()=>{if(!r)return void u("Please enter your due date");if(!m||!m.isValid)return void u("Please enter a valid due date");const e=Xe(t);if(e){const t=e.earlyGestationalDaysStart||e.minGestationalDays||77,a=e.maxGestationalDays||98;if(m.days<t||m.days>a)return void u(`NT scans can only be performed between ${t}-${a} days of pregnancy (${Math.floor(t/7)}-${Math.floor(a/7)} weeks). Your current gestational age is ${et(m)}.`);if(m.days>a)return void u(`NT scans must be completed before ${a+1} days. Your current gestational age is ${et(m)}, which exceeds the maximum limit.`)}else if(m.days<35||m.days>140)return void u("Due date seems incorrect. NT scans are typically done between 77-98 days (11-14 weeks) of pregnancy.");a({dueDate:r,gestationalAge:m.days,gestationalDays:m.days,gestationalDaysRemainder:m.remainingDays})},disabled:!r||!m||!m.isValid,sx:{borderRadius:"8px",textTransform:"none",fontWeight:600,backgroundColor:"#3b82f6","&:hover":{backgroundColor:"#2563eb"}},children:"Confirm Due Date"})]})]})})};function at(e){return F({attr:{viewBox:"0 0 512 512"},child:[{tag:"path",attr:{d:"m289.94 256 95-95A24 24 0 0 0 351 127l-95 95-95-95a24 24 0 0 0-34 34l95 95-95 95a24 24 0 1 0 34 34l95-95 95 95a24 24 0 0 0 34-34z"},child:[]}]})(e)}tt.propTypes={scanType:b.shape({scanTypeId:b.number.isRequired,name:b.string.isRequired,detailedScanType:b.shape({bookingRules:b.arrayOf(b.shape({ruleType:b.number.isRequired,isEnabled:b.bool.isRequired,minGestationalDays:b.number,maxGestationalDays:b.number}))})}).isRequired,onConfirm:b.func.isRequired,onCancel:b.func.isRequired};const nt=({scanType:t,onQualified:r,onDisqualified:o,onClose:u})=>{const[p,h]=e.useState({}),[m,f]=e.useState(!1),[y,x]=e.useState([]),[b,j]=e.useState(!0),I=a(),C=(null==I?void 0:I.isPublic)&&(null==I?void 0:I.primary)?I.primary:null,N=(null==I?void 0:I.isPublic)&&(null==I?void 0:I.secondary)?I.secondary:null;e.useEffect(()=>{h({})},[t.scanTypeId]),e.useEffect(()=>{(async()=>{try{j(!0);const e=await fetch(`https://healthco.clinic/api/api/scantypes/${t.scanTypeId}`);if(e.ok){const t=await e.json(),a=t.value||t,n=(Array.isArray(a.questions)?a.questions:[]).map(e=>({...e,scanTypeQuestionId:e.scanTypeQuestionId??e.id,options:Array.isArray(e.options)?e.options.map(e=>({...e,scanTypeQuestionOptionId:e.scanTypeQuestionOptionId??e.id??e.scanTypeQuestionOptionId})):[]}));x(n),0===n.length&&r([])}else x([]),r([])}catch(e){x([]),r([])}finally{j(!1)}})()},[t.scanTypeId,r]);const k=(e,t)=>{h(a=>({...a,[e]:t}))},w=e=>{if(null==e||""===e)return NaN;if("number"==typeof e)return e;if("string"==typeof e){const t=new Date(e);if(!isNaN(t.getTime())){const e=new Date;let a=280-(t.getTime()-e.getTime())/864e5;if(!isNaN(a))return a=Math.floor(a),a<0&&(a=0),a>350&&(a=350),a}const a=parseInt(e);return isNaN(a)?NaN:a}return NaN};return b?i.jsx(R,{sx:{mt:2,border:`2px solid ${C?Fe(C,.25):"#e3f2fd"}`,borderRadius:3},children:i.jsx(P,{children:i.jsx(l,{children:"Loading questions..."})})}):0===y.length?null:i.jsx(W,{in:!0,timeout:300,children:i.jsx(R,{sx:{mt:2,border:`2px solid ${C?Fe(C,.25):"#e3f2fd"}`,backgroundColor:C?Fe(C,.06):"#f8faff",borderRadius:3},children:i.jsxs(P,{children:[i.jsxs(s,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[i.jsxs(l,{variant:"h6",sx:{color:C||"#1976d2",fontWeight:600},children:["Pre-qualifying Questions for ",t.name]}),i.jsx(c,{onClick:u,size:"small",sx:{color:C||"inherit"},children:i.jsx(at,{})})]}),i.jsx(l,{variant:"body2",sx:{mb:3,color:"#666"},children:"Please answer the following questions to determine your eligibility for this scan."}),i.jsx(s,{sx:{display:"flex",flexDirection:"column",gap:3},children:y.map((e,t)=>{var a,n,r,o,d;const c=e.scanTypeQuestionId??e.id,u=p[c];return i.jsxs(s,{sx:{p:2,borderRadius:3,backgroundColor:"white",border:"1px solid #e0e0e0"},children:[i.jsxs(l,{sx:{mb:2,fontWeight:500,color:"#333"},children:[t+1,". ",e.questionText]}),1===e.type&&i.jsx($,{component:"fieldset",children:i.jsx(g,{value:u??"",onChange:e=>k(c,e.target.value),children:null==(a=e.options)?void 0:a.map((e,t)=>i.jsx(v,{value:e.optionText,control:i.jsx(T,{size:"small",sx:{"&.Mui-checked":{color:C||void 0}}}),label:e.optionText,sx:{"& .MuiTypography-root":{fontSize:"0.875rem"}}},t))})}),2===e.type&&i.jsx(S,{fullWidth:!0,variant:"outlined",size:"small",value:u??"",onChange:e=>k(c,e.target.value),placeholder:"Enter your answer..."}),3===e.type&&i.jsx($,{component:"fieldset",children:i.jsx(g,{value:u??"",onChange:e=>k(c,e.target.value),children:null==(n=e.options)?void 0:n.map((e,t)=>i.jsx(v,{value:e.optionText,control:i.jsx(T,{size:"small",sx:{"&.Mui-checked":{color:C||void 0}}}),label:e.optionText,sx:{"& .MuiTypography-root":{fontSize:"0.875rem"}}},t))})}),4===e.type&&i.jsx($,{component:"fieldset",children:i.jsx(B,{children:null==(r=e.options)?void 0:r.map((e,t)=>{const a=Array.isArray(u)?u:[],n=a.includes(e.optionText);return i.jsx(v,{control:i.jsx(ae,{size:"small",checked:n,onChange:t=>{const n=t.target.checked?[...a,e.optionText]:a.filter(t=>t!==e.optionText);k(c,n)},sx:{"&.Mui-checked":{color:C||void 0}}}),label:e.optionText,sx:{"& .MuiTypography-root":{fontSize:"0.875rem"}}},t)})})}),5===e.type&&i.jsxs(s,{children:[i.jsx(S,{type:"date",size:"small",value:u??"",onChange:e=>k(c,e.target.value),sx:{maxWidth:300},slotProps:{htmlInput:{min:ye(new Date).split("T")[0]}}}),i.jsxs(l,{variant:"caption",sx:{display:"block",mt:1,color:"#666",fontStyle:"italic"},children:["Enter the estimated due date (delivery date). We will calculate your current gestational age in days from this.",(null==(d=null==(o=e.options)?void 0:o[0])?void 0:d.strictQualification)&&i.jsxs("span",{style:{color:"#d97706",fontWeight:500},children:[" ","(Your eligibility will be determined based on this date)"]})]}),(()=>{const e=w(u);return isNaN(e)?null:i.jsxs(l,{variant:"body2",sx:{mt:1,color:"#333",fontWeight:500},children:["Estimated gestational age: ",e," day",1===e?"":"s"," (~",Math.floor(e/7)," weeks)"]})})()]})]},c)})}),i.jsxs(s,{sx:{mt:3,display:"flex",gap:2,justifyContent:"flex-end"},children:[i.jsx(d,{onClick:u,disabled:m,sx:{textTransform:"none",color:N||"#6b7280",borderRadius:"8px",px:2,py:1,"&:hover":{backgroundColor:N?Fe(N,.1):"rgba(59, 130, 246, 0.1)",color:N||"#2563eb"}},children:"Cancel"}),i.jsx(d,{variant:"contained",onClick:()=>{f(!0);if(y.filter(e=>{const t=e.scanTypeQuestionId??e.id,a=p[t];return!a&&0!==a&&!1!==a}).length>0)return n.error("Please answer all questions before proceeding."),void f(!1);const e=(()=>{var e,t,a,n;let i=!0;for(const s of y){const r=s.scanTypeQuestionId??s.id,l=p[r];if(!l&&0!==l&&!1!==l){i=!1;break}if(1===s.type){const t=null==(e=s.options)?void 0:e.find(e=>{var t;return(null==(t=e.optionText)?void 0:t.toLowerCase())===String(l).toLowerCase()});if(t&&2===t.outcome){i=!1;break}}else if(3===s.type){const e=null==(t=s.options)?void 0:t.find(e=>e.optionText===l);if(e&&2===e.outcome){i=!1;break}}else if(4===s.type){const e=Array.isArray(l)?l:[];for(const t of e){const e=null==(a=s.options)?void 0:a.find(e=>e.optionText===t);if(e&&2===e.outcome){i=!1;break}}if(!i)break}else if(5===s.type){const e=w(l),t=null==(n=s.options)?void 0:n[0];if(isNaN(e)&&(null==t?void 0:t.strictQualification)){i=!1;break}if(t&&t.strictQualification){const a=t.conditionType,n=t.minDays,s=t.maxDays;if(1===a){if(e<n||e>s){i=!1;break}}else if(2===a){if(e>=s){i=!1;break}}else if(3===a&&e<=n){i=!1;break}}}}return i})();setTimeout(()=>{if(e){n.success("You are qualified for this scan!");const e=y.map(e=>{const a=e.scanTypeQuestionId??e.id,n=p[a];return{scanTypeId:t.scanTypeId,scanTypeQuestionId:a,response:String(n||"")}});r(e)}else n.error("You are not qualified for this scan."),o();f(!1)},500)},disabled:m,sx:{minWidth:120,textTransform:"none",borderRadius:"8px",px:2,py:1,...C?{backgroundColor:C,"&:hover":{backgroundColor:C}}:{}},children:m?"Checking...":"Submit Answers"})]})]})})})};nt.propTypes={scanType:b.shape({scanTypeId:b.number.isRequired,name:b.string.isRequired}).isRequired,onQualified:b.func.isRequired,onDisqualified:b.func.isRequired,onClose:b.func.isRequired};const it=({service:e,checkedScanTypes:t,onToggleScanType:a,selectedScanForQuestions:n,disabledScanTypes:r,ntScanQualificationPending:o,brandColors:d})=>{var c;const u=(null==d?void 0:d.primary)||"#2563eb",p=(null==d?void 0:d.primary)||"#3b82f6";return i.jsxs(C,{variant:"outlined",sx:{padding:"20px",borderRadius:"12px",border:"1.5px solid #e5e7eb",boxShadow:"0 2px 8px 0 rgba(0,0,0,0.04)",backgroundColor:"#fff",width:"100%",maxWidth:"100%",minWidth:0,overflow:"hidden",display:"flex",flexDirection:"column",transition:"box-shadow 0.35s cubic-bezier(.4,0,.2,1), border-color 0.35s cubic-bezier(.4,0,.2,1), transform 0.35s cubic-bezier(.4,0,.2,1)",cursor:"pointer","&:hover":{boxShadow:"0 16px 48px 0 rgba(60,72,88,0.30)",borderColor:u,transform:"translateY(-2px)"},"&:active":{boxShadow:"0 4px 12px 0 rgba(60,72,88,0.12)",borderColor:p}},children:[i.jsx(s,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:2},children:i.jsxs(s,{children:[i.jsx(l,{sx:{fontWeight:700,wordBreak:"break-word",overflowWrap:"anywhere"},children:e.serviceName}),e.description&&i.jsx(Ie,{title:e.description,children:i.jsx(l,{variant:"caption",sx:{color:"#6b7280",display:"block",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:300},children:e.description})})]})}),i.jsx(m,{sx:{mb:1}}),i.jsx(Ce,{maxHeight:200,sx:{display:"flex",flexDirection:"column",gap:1,minWidth:0},children:(null==(c=e.scanTypes)?void 0:c.length)>0?e.scanTypes.map(c=>{var u;const p=t.includes(c.scanTypeId),h=r.includes(c.scanTypeId)||t.length>=4&&!p,m=(null==n?void 0:n.scanTypeId)===c.scanTypeId,f=(null==(u=null==o?void 0:o.scanType)?void 0:u.scanTypeId)===c.scanTypeId;return i.jsxs(s,{sx:{display:"grid",gridTemplateColumns:"1fr auto",alignItems:"center",columnGap:1,minWidth:0},children:[i.jsx(Se,{checked:p,disabled:h,onChange:()=>a(e,c),checkedColor:null==d?void 0:d.primary,label:i.jsxs(l,{sx:{fontWeight:600,mr:2,color:h?"#9ca3af":m?`${(null==d?void 0:d.secondary)||"#3b82f6"}`:f?"#059669":"inherit",fontStyle:m||f?"italic":"normal",whiteSpace:"normal",wordBreak:"break-word",overflowWrap:"anywhere"},children:[c.name,m&&" (answer questions below...)",f&&" (qualified - provide due date below...)"]}),marginTop:3}),i.jsx(s,{sx:{ml:1,whiteSpace:"nowrap",justifySelf:"end"},children:i.jsxs(Ne,{color:"#666",backgroundColor:"#f5f5f5",px:.5,py:.25,children:[c.durationMinutes,"m"]})})]},c.scanTypeId)}):i.jsx(l,{variant:"body2",sx:{color:"#9ca3af"},children:"No scan types for this service."})})]})};it.propTypes={service:b.object.isRequired,checkedScanTypes:b.array.isRequired,onToggleScanType:b.func.isRequired,selectedScanForQuestions:b.object,disabledScanTypes:b.array.isRequired,ntScanQualificationPending:b.object,brandColors:b.object};const st=({formikProps:n,clinicId:r,editState:o})=>{const{services:d,loading:c,error:u}=(a=>{const[n,i]=e.useState([]),[s,r]=e.useState(!0),[l,o]=e.useState(null);return e.useEffect(()=>{let e=!1;return r(!0),o(null),a?((async()=>{try{const n=await t.get(`https://healthco.clinic/api/fhir/Calendar/availableServices/${a}`);if(e)return;const s=Array.isArray(n.data)?n.data:[];if(0===s.length)return void i([]);const r=s.filter(e=>e.isEnabled);if(0===r.length)return void i([]);const l=await t.get(`https://healthco.clinic/api/api/services/clinic/${a}`);if(e)return;const o=Array.isArray(l.data)?l.data:[],d=r.map(e=>{const t=o.find(t=>t.serviceId===e.serviceId),a=(e.scanTypes||[]).map(e=>{var a;const n=null==(a=null==t?void 0:t.scanTypes)?void 0:a.find(t=>t.scanTypeId===e.scanTypeId);return{scanTypeId:e.scanTypeId,name:e.scanTypeName,durationMinutes:(null==n?void 0:n.durationMinutes)||30,hasPrequalifyingQuestions:!!n&&Array.isArray(n.questions)&&n.questions.length>0}});return{serviceId:e.serviceId,serviceName:e.serviceName,description:(null==t?void 0:t.description)||"",scanTypes:a}}).filter(e=>e.scanTypes&&e.scanTypes.length>0);i(d)}catch(n){e||(o(n),i([]))}finally{e||r(!1)}})(),()=>{e=!0}):(i([]),r(!1),()=>{e=!0})},[a]),{services:n,loading:s,error:l}})(r),[p,h]=e.useState(null),[m,f]=e.useState([]),[x,b]=e.useState(null),[g,v]=e.useState(null),T=a(),S=(null==T?void 0:T.isPublic)?{primary:T.primary,secondary:T.secondary}:null;e.useEffect(()=>{void 0===n.values.selectedScanTypeIds&&n.setFieldValue("selectedScanTypeIds",[]),void 0===n.values.scanResponses&&n.setFieldValue("scanResponses",[]),void 0===n.values.selectedScansWithServices&&n.setFieldValue("selectedScansWithServices",[]),void 0===n.values.detailedScanTypes&&n.setFieldValue("detailedScanTypes",[]),void 0===n.values.ntScanData&&n.setFieldValue("ntScanData",null)},[n]);const j=n.values.selectedScanTypeIds||[],I=e.useMemo(()=>Array.isArray(d)?d:[],[d]);e.useEffect(()=>{var e;if(I.length>0&&(null==(e=n.values.selectedScansWithServices)?void 0:e.length)>0){const e=n.values.selectedScansWithServices.map(e=>{if(!e.serviceName||"Unknown Service"===e.serviceName){const t=I.find(t=>{var a;return null==(a=t.scanTypes)?void 0:a.some(t=>t.scanTypeId===e.scanTypeId)});if(t)return{...e,serviceName:t.serviceName,serviceId:t.serviceId}}return e});e.some((e,t)=>{var a;return e.serviceName!==(null==(a=n.values.selectedScansWithServices[t])?void 0:a.serviceName)})&&n.setFieldValue("selectedScansWithServices",e)}},[I,n.values.selectedScansWithServices,n]);const C=(e,t)=>{var a;const i=new Set(j),s=i.has(t.scanTypeId);if(s||!(i.size>=4)){if(s){i.delete(t.scanTypeId),n.setFieldValue("selectedScanTypeIds",Array.from(i));const e=(n.values.selectedScansWithServices||[]).filter(e=>e.scanTypeId!==t.scanTypeId);n.setFieldValue("selectedScansWithServices",e);const s=(n.values.scanResponses||[]).filter(e=>e.scanTypeId!==t.scanTypeId);n.setFieldValue("scanResponses",s);const r=(n.values.detailedScanTypes||[]).filter(e=>e.scanTypeId!==t.scanTypeId);n.setFieldValue("detailedScanTypes",r);const l=n.values.ntScanData;l&&l.scanTypeId===t.scanTypeId&&n.setFieldValue("ntScanData",null),(null==p?void 0:p.scanTypeId)===t.scanTypeId&&(h(null),f([])),(null==x?void 0:x.scanTypeId)===t.scanTypeId&&b(null),(null==(a=null==g?void 0:g.scanType)?void 0:a.scanTypeId)===t.scanTypeId&&v(null)}else{h(t);const e=I.flatMap(e=>e.scanTypes||[]).filter(e=>e.scanTypeId!==t.scanTypeId).map(e=>e.scanTypeId);f(e)}n.errors.selectedScanTypeIds&&n.setFieldError("selectedScanTypeIds",void 0)}},N=async(e=[])=>{if(p)try{const a=await(async e=>{try{const a=await t.get(`https://healthco.clinic/api/api/scantypes/${e}`);return a.data.isError?null:a.data.value}catch(u){return null}})(p.scanTypeId);if(a){const t=a.bookingRules&&a.bookingRules.length>0;t&&a.bookingRules.some(e=>e.ruleType===ue.OB_HIGH_RISK&&e.isEnabled);if(t&&a.bookingRules.some(e=>e.ruleType===ue.NT_SCAN&&e.isEnabled))return v({scanType:p,detailedScanType:a,scanResponses:e}),b({...p,detailedScanType:a,scanResponses:e}),void h(null);const i=[...(n.values.detailedScanTypes||[]).filter(e=>e.scanTypeId!==p.scanTypeId),a];n.setFieldValue("detailedScanTypes",i)}else;const i=new Set(j);i.add(p.scanTypeId),n.setFieldValue("selectedScanTypeIds",Array.from(i));const s=I.find(e=>{var t;return null==(t=e.scanTypes)?void 0:t.some(e=>e.scanTypeId===p.scanTypeId)}),r=[...(n.values.selectedScansWithServices||[]).filter(e=>e.scanTypeId!==p.scanTypeId),{scanTypeId:p.scanTypeId,serviceId:null==s?void 0:s.serviceId,serviceName:null==s?void 0:s.serviceName,scanTypeName:p.name}];n.setFieldValue("selectedScansWithServices",r);const l=n.values.scanResponses||[],o=[...l.filter(e=>e.scanTypeId!==p.scanTypeId),...e];n.setFieldValue("scanResponses",o),h(null),f([])}catch(a){const t=new Set(j);t.add(p.scanTypeId),n.setFieldValue("selectedScanTypeIds",Array.from(t));const i=I.find(e=>{var t;return null==(t=e.scanTypes)?void 0:t.some(e=>e.scanTypeId===p.scanTypeId)}),s=[...(n.values.selectedScansWithServices||[]).filter(e=>e.scanTypeId!==p.scanTypeId),{scanTypeId:p.scanTypeId,serviceId:null==i?void 0:i.serviceId,serviceName:null==i?void 0:i.serviceName,scanTypeName:p.name}];n.setFieldValue("selectedScansWithServices",s);const r=[...(n.values.scanResponses||[]).filter(e=>e.scanTypeId!==p.scanTypeId),...e];n.setFieldValue("scanResponses",r),h(null),f([])}},k=()=>{p&&(h(null),f([]))},D=()=>{h(null),f([]),v(null)},q=e=>{if(x)try{n.setFieldValue("ntScanData",{scanTypeId:x.scanTypeId,dueDate:e.dueDate,gestationalAge:e.gestationalAge,gestationalDays:e.gestationalDays,gestationalDaysRemainder:e.gestationalDaysRemainder});const t=x,a=x.scanResponses||[],i=x.detailedScanType,s=new Set(j);s.add(t.scanTypeId),n.setFieldValue("selectedScanTypeIds",Array.from(s));const r=I.find(e=>{var a;return null==(a=e.scanTypes)?void 0:a.some(e=>e.scanTypeId===t.scanTypeId)}),l=[...(n.values.selectedScansWithServices||[]).filter(e=>e.scanTypeId!==t.scanTypeId),{scanTypeId:t.scanTypeId,serviceId:null==r?void 0:r.serviceId,serviceName:null==r?void 0:r.serviceName,scanTypeName:t.name}];if(n.setFieldValue("selectedScansWithServices",l),i){const e=[...(n.values.detailedScanTypes||[]).filter(e=>e.scanTypeId!==t.scanTypeId),i];n.setFieldValue("detailedScanTypes",e)}if(a.length>0){const e=n.values.scanResponses||[],i=[...e.filter(e=>e.scanTypeId!==t.scanTypeId),{scanTypeId:t.scanTypeId,responses:a}];n.setFieldValue("scanResponses",i)}b(null),v(null),f([])}catch(t){}},A=()=>{b(null),v(null),f([])};return i.jsxs(s,{children:[i.jsx(Z,{icon:M,title:"Scan Selection",subtitle:"Choose the services and specific scan types for this appointment"}),i.jsxs(s,{sx:{mb:2,p:2,backgroundColor:j.length>=4?"#fef3c7":(null==S?void 0:S.primary)?Fe(S.primary,.1):"#f0f9ff",borderRadius:2,border:`1px solid ${j.length>=4?"#f59e0b":(null==S?void 0:S.primary)||"#3b82f6"}`},children:[i.jsxs(l,{variant:"body2",sx:{fontWeight:600,color:j.length>=4?"#92400e":(null==S?void 0:S.primary)||"#1e40af"},children:[j.length," / 4 scans selected",j.length>=4&&" (Maximum reached)"]}),j.length>=4&&i.jsx(l,{variant:"caption",sx:{color:"#92400e",display:"block",mt:.5},children:"You have reached the maximum of 4 scans per appointment. Deselect a scan to choose a different one."})]}),n.values.selectedScansWithServices&&n.values.selectedScansWithServices.length>0&&i.jsxs(s,{sx:{mb:2,p:2,backgroundColor:"#f8fafc",borderRadius:2},children:[i.jsxs(l,{variant:"subtitle2",sx:{fontWeight:600,mb:1},children:["Selected Scans (",n.values.selectedScansWithServices.length,"):"]}),(()=>{const e=n.values.selectedScansWithServices.reduce((e,t)=>{let a=t.serviceName;if(!a||"Unknown Service"===a){const e=I.find(e=>{var a;return null==(a=e.scanTypes)?void 0:a.some(e=>e.scanTypeId===t.scanTypeId)});a=(null==e?void 0:e.serviceName)||"Unknown Service"}return e[a]||(e[a]=[]),e[a].push(t.scanTypeName),e},{}),t=Object.keys(e),a=n.values.detailedScanTypes||[],r=a.filter(e=>{var t;return null==(t=e.bookingRules)?void 0:t.some(e=>e.ruleType===ue.OB_HIGH_RISK&&e.isEnabled)}),o=a.filter(e=>{var t;return null==(t=e.bookingRules)?void 0:t.some(e=>e.ruleType===ue.NT_SCAN&&e.isEnabled)});return i.jsxs(s,{children:[t.map((t,a)=>i.jsxs(l,{variant:"body2",sx:{color:"#6b7280",mb:.5},children:[i.jsxs("strong",{children:[t,":"]})," ",e[t].join(", ")]},t)),(t.length,r.length,o.length,null)]})})()]}),c?i.jsx(s,{sx:{display:"flex",justifyContent:"center",py:6},children:i.jsx(w,{})}):u?i.jsx(l,{color:"error",children:(null==u?void 0:u.message)||"Failed to load services"}):0===I.length?i.jsx(l,{sx:{color:"#6b7280",py:6},children:"No services available for this calendar"}):i.jsx(s,{sx:{mt:2,display:"grid",gridTemplateColumns:"1fr",gap:{xs:2,md:2}},children:I.map(e=>{var t,a;return i.jsxs(s,{sx:{minWidth:0},children:[i.jsx(it,{service:e,checkedScanTypes:j,onToggleScanType:C,selectedScanForQuestions:p,disabledScanTypes:m,ntScanQualificationPending:g,brandColors:S}),p&&(null==(t=e.scanTypes)?void 0:t.some(e=>e.scanTypeId===p.scanTypeId))&&i.jsx(nt,{scanType:p,onQualified:N,onDisqualified:k,onClose:D}),x&&(null==(a=e.scanTypes)?void 0:a.some(e=>e.scanTypeId===x.scanTypeId))&&i.jsxs(s,{children:[g&&i.jsxs(s,{sx:{mt:2,p:2,backgroundColor:(null==S?void 0:S.primary)?Fe(S.primary,.1):"#f0f9ff",borderRadius:2,border:`1px solid ${(null==S?void 0:S.primary)||"#3b82f6"}`},children:[i.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[i.jsx(y,{size:16,color:(null==S?void 0:S.primary)||"#1e40af"}),i.jsx(l,{variant:"body2",sx:{color:(null==S?void 0:S.primary)||"#1e40af",fontWeight:600},children:"Prequalifying questions completed successfully!"})]}),i.jsx(l,{variant:"body2",sx:{color:(null==S?void 0:S.primary)||"#1e40af",mt:.5},children:"Now we need your due date for NT scan timing requirements."})]}),i.jsx(tt,{scanType:x,onConfirm:q,onCancel:A})]})]},e.serviceId)})}),n.touched.selectedScanTypeIds&&n.errors.selectedScanTypeIds&&i.jsx(l,{variant:"caption",color:"error",sx:{mt:1,display:"block"},children:n.errors.selectedScanTypeIds})]})};st.propTypes={formikProps:b.object.isRequired,clinicId:b.oneOfType([b.string,b.number]),editState:b.shape({isEdit:b.bool,appointmentId:b.oneOfType([b.string,b.number]),appointmentData:b.object,loading:b.bool})};const rt=e.forwardRef(({open:a,onClose:l,onSubmit:o,clinicId:c,editState:u,isPublicBooking:p=!1,brandColors:h},m)=>{const{getSessionId:f}=Ae(),y=[{id:"personal",title:"Patient Information",subtitle:"Tell us about yourself",icon:N},{id:"scans",title:"Scan Selection",subtitle:"Select specific scans",icon:M},{id:"slots",title:"Date & Time",subtitle:"Pick your appointment time",icon:r}],x=(null==u||u.isEdit,0),[b,g]=e.useState(x),[v,T]=e.useState(!1),[S,j]=e.useState([]),[I,C]=e.useState(null),[k,w]=e.useState(!1);e.useEffect(()=>{(async()=>{if(c)try{const e=await t.get(`https://healthco.clinic/api/fhir/Appointment/GetPatientFormFields/${c}`);if(e.data&&e.data.fields){const t=e.data.fields;j(t),q(e=>{if(null==u?void 0:u.isEdit)return e;const a=t.find(e=>"healthCardNumber"===e.fieldName);return{...e,coverageType:(null==a?void 0:a.enabled)?we:ke}})}}catch(e){const t=[{fieldName:"name",enabled:!0,required:!0},{fieldName:"email",enabled:!0,required:!1},{fieldName:"phone",enabled:!0,required:!0},{fieldName:"gender",enabled:!0,required:!1},{fieldName:"dateOfBirth",enabled:!0,required:!0},{fieldName:"healthCardNumber",enabled:!0,required:!1},{fieldName:"identifyAs",enabled:!0,required:!1}];j(t),q(e=>{if(null==u?void 0:u.isEdit)return e;const a=t.find(e=>"healthCardNumber"===e.fieldName);return{...e,coverageType:(null==a?void 0:a.enabled)?we:ke}})}})()},[c]);const[D,q]=e.useState({fullName:"",phone:"",email:"",gender:null,identifyAs:ee.NOT_SPECIFIED,dob:"",coverageType:ke,healthCardNumber:"",healthCardProvince:"",uciNumber:"",allergies:"",medicalNotes:"",requisitionSheet:null,communicationConsent:!1,selectedScanTypeIds:[],selectedSlot:null,selectedSlots:[],scanResponses:[],selectedScansWithServices:[],totalResolvedAppointments:0}),A=e=>{var t,a,n;if(!e)return;const i=e.dateOfBirth?ye(new Date(e.dateOfBirth)).split("T")[0]:"",s=(null==(t=e.documents)?void 0:t.find(e=>{var t;return"Requisition Sheet"===e.description||(null==(t=e.fileName)?void 0:t.toLowerCase().includes("requisition"))}))||null,r=s?{name:s.fileName,type:s.fileType,size:s.base64Data?(()=>{try{return atob(s.base64Data).length}catch(e){return 0}})():0,base64Data:s.base64Data,patientDocumentId:s.patientDocumentId,isExistingDocument:!0}:null,l=(null==(a=e.scans)?void 0:a.map(e=>e.scanTypeId))||[],o=(null==(n=e.scans)?void 0:n.map(e=>({scanTypeId:e.scanTypeId,scanTypeName:e.scanTypeName,serviceId:e.serviceId,serviceName:e.serviceName||"Unknown Service",durationMinutes:e.durationMinutes||30})))||[];let d=we;e.uciNumber?d=De:e.healthCardNumber||e.uciNumber||(d=ke),q(t=>({...t,fullName:e.fullName||e.patientName||"",phone:e.phone||"",email:e.email||"",gender:e.gender??null,identifyAs:e.identifiedAs??t.identifyAs??ee.NOT_SPECIFIED,dob:i,coverageType:d,healthCardNumber:e.healthCardNumber||"",healthCardProvince:e.healthCardProvince||"",uciNumber:e.uciNumber||"",allergies:e.allergies||"",medicalNotes:e.medicalNotes||"",requisitionSheet:r,selectedScanTypeIds:t.selectedScanTypeIds.length>0?t.selectedScanTypeIds:l,scanResponses:t.scanResponses.length>0?t.scanResponses:e.scanResponses||[],selectedScansWithServices:t.selectedScansWithServices.length>0?t.selectedScansWithServices:o}))},R=()=>{const e=(null==u||u.isEdit,0);g(e),T(!1),C(null),w(!1);const t={fullName:"",phone:"",email:"",gender:null,identifyAs:ee.NOT_SPECIFIED,dob:"",coverageType:ke,healthCardNumber:"",healthCardProvince:"",uciNumber:"",allergies:"",medicalNotes:"",requisitionSheet:null,communicationConsent:!1,selectedScanTypeIds:[],selectedSlot:null,selectedSlots:[],scanResponses:[],selectedScansWithServices:[],totalResolvedAppointments:0};q(t),(null==u?void 0:u.isEdit)&&(null==u?void 0:u.appointmentData)&&A(u.appointmentData)};e.useEffect(()=>{a||R()},[a]),e.useEffect(()=>{(null==u?void 0:u.isEdit)&&(null==u?void 0:u.appointmentData)&&a&&A(u.appointmentData)},[u,a]),e.useImperativeHandle(m,()=>({resetForm:R}));const P=V();O(P.breakpoints.down("sm"));const E=()=>{var e;return"personal"===(null==(e=y[b])?void 0:e.id)?(()=>{const e={};return e.requisitionSheet=p?z().nullable().required("Please upload a requisition sheet"):z().nullable(),(null==u?void 0:u.isEdit)||(e.communicationConsent=Q().oneOf([!0],"You must consent to communication to proceed").required("You must consent to communication to proceed")),(null==u?void 0:u.isEdit)||S.forEach(t=>{if(t.enabled)switch(t.fieldName){case"name":e.fullName=t.required?Y().trim().required("Name is required"):Y().trim().nullable();break;case"email":e.email=t.required?K({requiredMessage:"Email is required",invalidMessage:"Invalid email"}):K({requiredMessage:"Email is required",invalidMessage:"Invalid email"}).nullable();break;case"phone":e.phone=t.required?J({requiredMessage:"Phone is required"}).trim():J({requiredMessage:"Phone is required"}).trim().nullable();break;case"gender":e.gender=t.required?U().required("Gender is required"):U().nullable();break;case"identifyAs":e.identifyAs=t.required?U().required("Identify As is required"):U().nullable();break;case"dateOfBirth":e.dob=t.required?se():re();break;case"healthCardNumber":e.healthCardNumber=Y().when("coverageType",{is:e=>e===we,then:e=>ie({required:!0,requiredMessage:"Health card number is required",formatMessage:"Health card must be this format: 1234567890AB"}),otherwise:e=>e.nullable()}),e.uciNumber=Y().when("coverageType",{is:e=>e===De,then:e=>e.required("UCI number is required"),otherwise:e=>e.nullable()});break;case"healthCardProvince":const a=S.find(e=>"healthCardProvince"===e.fieldName);(null==a?void 0:a.enabled)&&(e.healthCardProvince=Y().when("coverageType",{is:e=>e===we,then:e=>a.required?e.required("Health card province is required"):e.nullable(),otherwise:e=>e.nullable()}));break;case"allergies":e.allergies=t.required?Y().trim().required("Allergies information is required"):Y().trim().nullable();break;case"medicalNotes":e.medicalNotes=t.required?Y().trim().required("Medical notes are required"):Y().trim().nullable()}}),L(e)})():null},F=()=>{b>0&&g(e=>e-1)},W=e=>{switch(y[b].id){case"personal":return i.jsx(Ze,{formikProps:e,editState:u,clinicId:c,onSavePatientInfo:(null==u?void 0:u.isEdit)?()=>(async e=>{var t;if(v)return;const a=E();if(a)try{await a.validate(e.values,{abortEarly:!1})}catch(n){const a={},i={};return null==(t=n.inner)||t.forEach(e=>{e.path&&(a[e.path]=e.message,i[e.path]=!0)}),e.setErrors(a),void e.setTouched({...e.touched,...i})}T(!0);try{const t={...D,...e.values};o&&await o(t,"patientInfoOnly")&&(l(),R())}finally{T(!1)}})(e):null,isSubmitting:v,isPublicBooking:p});case"scans":return i.jsx(st,{formikProps:e,clinicId:c,editState:u});case"slots":return i.jsx(Ue,{formikProps:e,clinicId:c,editState:u});default:return null}},$=e=>{const t=null==u?void 0:u.isEdit,a=b===y.length-1,r=e.values.selectedSlots||[],c=e.values.totalResolvedAppointments||0,m=c>0&&r.filter(Boolean).length===c;let f="Next",x=v||k;a&&(c>1?m?(f=t?"Save Changes":"Book All Appointments",x=v):(f=t?"Save Changes":"Select All Slots First",x=!0):(f=t?"Save Changes":"Book Appointment",x=v||!r[0]));const S=p&&(null==h?void 0:h.primary)?h.primary:void 0,j=p&&(null==h?void 0:h.primaryHover)?h.primaryHover:void 0;return i.jsxs(s,{sx:{display:"flex",justifyContent:"space-between",width:"100%",mt:3},children:[i.jsx(d,{onClick:0===b?l:F,sx:{textTransform:"none",color:p&&(null==h?void 0:h.secondary)?h.secondary:"#6b7280",borderRadius:"8px",px:3,py:1.5,"&:hover":{backgroundColor:p&&(null==h?void 0:h.secondary)?`${h.secondary}1a`:"rgba(59,130,246,0.1)",color:p&&(null==h?void 0:h.secondary)?h.secondary:"#2563eb"}},children:0===b?"Cancel":"Previous"}),i.jsx(d,{variant:"contained",disabled:x,onClick:()=>{b===y.length-1?(async e=>{if(!v){T(!0);try{const t={...D,...e.values};o&&await o(t)&&(l(),R())}finally{T(!1)}}})(e):(async e=>{if("personal"===y[b].id&&!(null==u?void 0:u.isEdit)){const t=(e.values.healthCardNumber||"").trim(),i=(e.values.fullName||"").trim(),s=(e.values.phone||"").trim(),r=e.values.dob;if(t.length>=10){w(!0);try{const a=await le({healthCardNumber:t,fullName:i,phone:s,dob:r,email:e.values.email,gender:e.values.gender});if(!a.isValid)return C(a.message),n.error(a.message),void w(!1);C(null)}catch(a){return n.error("Failed to validate patient information. Please try again."),void w(!1)}finally{w(!1)}}}if("scans"===y[b].id&&!(e.values.selectedScanTypeIds||[]).length)return e.setTouched({...e.touched,selectedScanTypeIds:!0}),void e.setErrors({...e.errors,selectedScanTypeIds:"Select at least one scan"});const t=E();t?t.validate(e.values,{abortEarly:!1}).then(()=>{q(t=>({...t,...e.values})),b<y.length-1&&g(e=>e+1)}).catch(t=>{var a;const n={},i={};null==(a=t.inner)||a.forEach(e=>{e.path&&(n[e.path]=e.message,i[e.path]=!0)}),e.setErrors(n),e.setTouched({...e.touched,...i})}):(q(t=>({...t,...e.values})),b<y.length-1&&g(e=>e+1))})(e)},sx:{textTransform:"none",borderRadius:"8px",px:3,py:1.5,backgroundColor:x?"#9ca3af":S||"#3b82f6","&:hover":{backgroundColor:x?"#9ca3af":j||"#2563eb"},"&.Mui-disabled":{backgroundColor:"#9ca3af",color:"#ffffff"}},children:v?t?"Saving...":"Booking...":f})]})},B=e=>i.jsxs(G.Provider,{value:p&&h?{primary:h.primary,secondary:h.secondary,isPublic:!0}:{isPublic:!1},children:[p&&(null==h?void 0:h.logoBase64)&&i.jsx(s,{sx:{display:"flex",justifyContent:"center",alignItems:"center",mb:1,mt:1},children:i.jsx(s,{sx:{border:"1px solid #e5e7eb",borderRadius:"8px",pt:1,px:1},children:i.jsx(s,{component:"img",src:`${h.logoBase64}`,alt:"Clinic Logo",sx:{maxWidth:"200px",maxHeight:"150px",width:"auto",height:"auto",objectFit:"contain"},onError:e=>{e.target.style.display="none"}})})}),i.jsx(ne,{steps:y,currentStep:b,disabledSteps:[],colors:p&&h?{primary:h.primary,secondary:h.secondary}:void 0}),i.jsx(s,{children:W(e)}),$(e)]});return p?i.jsx(s,{sx:{width:"100%",maxWidth:"820px",backgroundColor:"white",borderRadius:"12px",boxShadow:"0 25px 50px -12px rgba(0, 0, 0, 0.25)",p:3},children:i.jsx(H,{initialValues:D,validationSchema:E(),enableReinitialize:!0,onSubmit:()=>{},children:e=>B(e)})}):i.jsx(_,{open:a,onClose:async()=>{await(async()=>{if(!(null==u?void 0:u.isEdit))try{const e=f();e&&c&&await oe.releaseSessionSlots({sessionId:e,clinicId:parseInt(c),releasedBy:0})}catch(e){}})(),l(),R()},title:(null==u?void 0:u.isEdit)?"Edit Appointment":"Book Appointment",maxWidth:"md",showActions:!1,customWidth:"820px",children:i.jsx(H,{initialValues:D,validationSchema:E(),enableReinitialize:!0,onSubmit:()=>{},children:e=>B(e)})})});rt.displayName="BookAppointmentForm",rt.propTypes={open:b.bool.isRequired,onClose:b.func.isRequired,onSubmit:b.func,clinicId:b.oneOfType([b.string,b.number]),isPublicBooking:b.bool,brandColors:b.shape({primary:b.string,primaryHover:b.string,secondary:b.string,secondaryHover:b.string,logoBase64:b.string}),editState:b.shape({isEdit:b.bool,appointmentId:b.oneOfType([b.string,b.number]),appointmentData:b.object,loading:b.bool})};export{rt as B,qe as C,We as u};
