import{y as e,m as t}from"./index-DyR0ftVW.js";import{b as n}from"./ViewCalendarModal-BHjHQ6rY.js";import{splitAppointments as i,formatDateISO as a}from"./appointmentLogic-ihgp36Gl.js";const s=e=>new Promise((t,n)=>{const i=new FileReader;i.onload=()=>t(i.result.split(",")[1]),i.onerror=n,i.readAsDataURL(e)});async function r({bookingData:r,updateType:o="full",clinicId:l,editState:c}){var d;if((null==c?void 0:c.isEdit)&&"patientInfoOnly"===o)return async function({bookingData:i,updateType:r="full",clinicId:o,editState:l}){var c,d,p,u,h,m,f,g,I;try{if(!(null==l?void 0:l.appointmentId))return e.error("No appointment ID for edit"),!1;const u=l.appointmentId,h=l.appointmentData||{};let m=[];if(i.requisitionSheet)if(i.requisitionSheet.isExistingDocument)m.push({patientDocumentId:i.requisitionSheet.patientDocumentId,fileName:i.requisitionSheet.name,fileType:i.requisitionSheet.type,base64Data:i.requisitionSheet.base64Data,description:"Requisition Sheet",storagePath:i.requisitionSheet.storagePath||""});else{const e=await s(i.requisitionSheet);m.push({patientDocumentId:0,fileName:i.requisitionSheet.name,fileType:i.requisitionSheet.type,base64Data:e,description:"Requisition Sheet",storagePath:""})}const f=(i.scanResponses||[]).map(e=>({scanTypeId:e.scanTypeId,scanTypeQuestionId:e.scanTypeQuestionId,response:e.response}));let g;if("patientInfoOnly"===r){const e=(null==(d=null==(c=h.scans)?void 0:c[0])?void 0:d.serviceId)||0;g={appointmentId:u,fullName:i.fullName,gender:i.gender,identifiedAs:h.identifiedAs||0,email:i.email,phone:i.phone,dateOfBirth:i.dob?a(i.dob):h.dateOfBirth,coverageType:i.coverageType??h.coverageType??1,healthCardNumber:i.healthCardNumber,healthCardProvinceId:i.healthCardProvince?parseInt(i.healthCardProvince):h.healthCardProvinceId,uciNumber:i.uciNumber||null,allergies:i.allergies,medicalNotes:i.medicalNotes,clinicId:parseInt(o),technicianId:h.technicianId,appointmentDate:h.appointmentDate?a(h.appointmentDate):null,startTime:h.startTime,endTime:h.endTime,serviceScanSelections:(null==(p=h.scans)?void 0:p.map(t=>({serviceId:e,scanTypeId:t.scanTypeId})))||[],scanResponses:h.scanResponses||[],documents:m,reasonForVisit:h.reasonForVisit||"",notes:h.notes||""}}else{if(!i.selectedSlots||0===i.selectedSlots.length)return e.error("Please select an appointment slot"),!1;const t=i.selectedSlots[0];g={appointmentId:u,fullName:i.fullName,gender:i.gender,identifiedAs:h.identifiedAs||0,email:i.email,phone:i.phone,dateOfBirth:i.dob?a(i.dob):h.dateOfBirth,coverageType:i.coverageType??h.coverageType??1,healthCardNumber:i.healthCardNumber,healthCardProvinceId:i.healthCardProvince?parseInt(i.healthCardProvince):h.healthCardProvinceId,uciNumber:i.uciNumber||null,allergies:i.allergies,medicalNotes:i.medicalNotes,clinicId:parseInt(o),technicianId:t.technicianId,appointmentDate:a(t.date),startTime:t.startTime,endTime:t.endTime,serviceScanSelections:(i.selectedScanTypeIds||[]).map(e=>({serviceId:t.serviceId,scanTypeId:e})),scanResponses:f,documents:m,reasonForVisit:h.reasonForVisit||"",notes:h.notes||""};const s=e=>{if(!e)return null;const t=new Date(e);return isNaN(t)?null:`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`},r=e=>e?String(e).slice(0,5):null,l=s(h.appointmentDate),c=s(t.date),d=r(h.startTime)!==r(t.startTime),p=r(h.endTime)!==r(t.endTime);(l!==c||d||p)&&(g.status=n.RESCHEDULED)}return await t.put(`https://healthco.clinic/api/fhir/Appointment/${u}`,g),e.success("patientInfoOnly"===r?"Patient information updated successfully!":"Appointment updated successfully!"),!0}catch(y){if(null==(h=null==(u=y.response)?void 0:u.data)?void 0:h.errors){const t=Object.values(y.response.data.errors).flat();e.error(`Failed to update: ${t.join(", ")}`)}else(null==(f=null==(m=y.response)?void 0:m.data)?void 0:f.message)?e.error(`Failed to update: ${y.response.data.message}`):(null==(I=null==(g=y.response)?void 0:g.data)?void 0:I.title)?e.error(`Failed to update: ${y.response.data.title}`):e.error("Failed to update appointment. Please try again.");return!1}}({bookingData:r,updateType:o,clinicId:l,editState:c});try{if(!l)return e.error("No clinic selected"),!1;if(!r.selectedScanTypeIds||0===r.selectedScanTypeIds.length)return e.error("No scan types selected"),!1;if(!r.selectedScansWithServices||0===r.selectedScansWithServices.length)return e.error("No scans with service information found"),!1;let o=r.resolvedAppointments||[];if(0===o.length)try{o=await i(r.selectedScansWithServices,l)}catch(p){return e.error("Failed to process appointment structure. Please try again."),!1}if(0===o.length)return e.error("No appointments found. Please go back to the Date & Time step."),!1;const d=(r.selectedSlots||[]).filter(Boolean);if(0===d.length&&!r.selectedSlot)return e.error("Please select a time slot for each appointment"),!1;if(o.length>1&&d.length<o.length&&!r.selectedSlot)return e.error(`You need ${o.length} appointments. Please select a time slot for each appointment.`),!1;const u=[];for(let e=0;e<o.length;e++){const i=o[e];try{const o=d;let p=null;if(o.length>0&&(p=o.find(t=>t&&t.appointmentIndex===e)||null,!p&&i.serviceId&&(p=o.find(e=>e&&e.serviceId===i.serviceId)||null),!p&&o[e]&&(p=o[e])),!p&&r.selectedSlot&&(p=r.selectedSlot),!p)throw new Error("No time slot found for appointment");let h=null;r.healthCardProvince&&(h="number"==typeof r.healthCardProvince||"string"!=typeof r.healthCardProvince||isNaN(r.healthCardProvince)?r.healthCardProvince:parseInt(r.healthCardProvince,10));let m=[];i.scans&&i.scans.length>0?m=i.scans.map(e=>({serviceId:e.serviceId,scanTypeId:e.scanTypeId})):i.scanTypeIds&&i.serviceId&&(m=i.scanTypeIds.map(e=>({serviceId:i.serviceId,scanTypeId:e})));const f=(r.scanResponses||[]).filter(e=>{var t;return((null==(t=i.scans)?void 0:t.map(e=>e.scanTypeId))||i.scanTypeIds||[]).includes(e.scanTypeId)}),g={fullName:r.fullName,gender:r.gender,identifiedAs:r.identifyAs??0,email:r.email||null,phone:r.phone,dateOfBirth:a(r.dob),coverageType:r.coverageType??1,healthCardNumber:r.healthCardNumber||null,healthCardProvinceId:h,uciNumber:r.uciNumber||null,allergies:r.allergies||null,medicalNotes:r.medicalNotes||null,clinicId:l,technicianId:p.technicianId,appointmentDate:a(p.date),startTime:p.startTime,endTime:p.endTime,serviceScanSelections:m,scanResponses:f,documents:[],reasonForVisit:"",notes:m.length>1?`Multiple scans: ${m.length}`:""};if(r.requisitionSheet)if(r.requisitionSheet.isExistingDocument)g.documents.push({patientDocumentId:r.requisitionSheet.patientDocumentId,fileName:r.requisitionSheet.name,fileType:r.requisitionSheet.type,base64Data:r.requisitionSheet.base64Data,description:"Requisition Sheet",storagePath:r.requisitionSheet.storagePath||""});else{const e=await s(r.requisitionSheet);g.documents.push({patientDocumentId:0,fileName:r.requisitionSheet.name,fileType:r.requisitionSheet.type,base64Data:e,description:"Requisition Sheet"})}let I;if((null==c?void 0:c.isEdit)&&0===e){g.appointmentId=c.appointmentId;const e=c.appointmentData||{},i=e=>{if(!e)return null;const t=new Date(e);return isNaN(t)?null:`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`},a=e=>e?String(e).slice(0,5):null,s=i(e.appointmentDate),r=i(p.date),o=a(e.startTime)!==a(p.startTime),l=a(e.endTime)!==a(p.endTime);(s!==r||o||l)&&(g.status=n.RESCHEDULED),I=await t.put(`https://healthco.clinic/api/fhir/Appointment/${c.appointmentId}`,g,{headers:{"Content-Type":"application/json",Accept:"application/json"}})}else I=await t.post("https://healthco.clinic/api/fhir/Appointment",g,{headers:{"Content-Type":"application/json",Accept:"application/json"}});u.push(I)}catch(p){u.push({error:p,status:"error"})}}if(u.every(e=>!e.error&&(200===e.status||201===e.status))){const t=u.length;return(null==c?void 0:c.isEdit)?e.success("Appointment updated successfully!"):e.success(1===t?"Appointment booked successfully!":`Booked ${t} appointments successfully!`),!0}return e.warning("Some appointments may not have been created/updated successfully"),!1}catch(p){let t="An unexpected error occurred. Please try again later.";if(null==(d=p.response)?void 0:d.data){const e=p.response.data;e.detail?t=e.detail:e.title?t=e.title:e.errors&&Array.isArray(e.errors)&&e.errors.length>0?t=e.errors[0]:"string"==typeof e&&(t=e)}else t=p.request?"Network error. Please check your connection and try again.":p.message||t;return e.error(t),!1}}export{r as s};
