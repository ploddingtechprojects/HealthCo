name: Auto Deploy HealthCo

# Trigger deployment on push to main branch
on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      # 1️⃣ Checkout the repo
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2️⃣ Deploy Frontend
      - name: Deploy Frontend
        run: |
          echo "Deploying frontend..."
          cd frontend
          # Remove old frontend files
          sudo rm -rf /var/www/html/*
          # Install unrar if not installed
          sudo apt-get update && sudo apt-get install -y unrar
          # Extract dist.rar to NGINX folder
          sudo unrar x dist.rar /var/www/html/
          # Reload NGINX to serve new frontend
          sudo systemctl reload nginx

      # 3️⃣ Deploy Backend
      - name: Deploy Backend
        run: |
          echo "Deploying backend..."
          cd backend
          # If backend has package.json, install dependencies
          if [ -f package.json ]; then
            npm install
            pm2 stop healthco-backend || true
            pm2 start server.js --name healthco-backend
          else
            # If backend is single JS file
            pm2 stop healthco-backend || true
            pm2 start BookAppointmentPublish08122026.js --name healthco-backend
          fi

      # 4️⃣ Health Check
      - name: Health Check
        run: |
          echo "Checking application health..."
          curl -f http://localhost || exit 1
