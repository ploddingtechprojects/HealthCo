const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/appointmentLogic-ihgp36Gl.js","assets/index-DyR0ftVW.js","assets/index-Bs-55i82.css"])))=>i.map(i=>d[i]);
import{j as e,D as t,h as a,p as n,T as i,i as o,B as r,P as s,r as l,a3 as d,y as c,S as p,ak as u,aD as m,al as h,aI as f,m as g,ab as v}from"./index-DyR0ftVW.js";import{C as S}from"./Cancel-C2DgCmhH.js";import{g as y,a as C,b,V as I,C as T,D}from"./DocumentPreviewDialog-Ck4145Mc.js";import{l as N,g as w,a as A,A as j,b as x,c as O,d as P,e as F,V as R,f as E,h as q}from"./ViewCalendarModal-BHjHQ6rY.js";import{R as B}from"./WarningOutlined-Pm6jC2mV.js";import{D as k}from"./DialogActions-BmwBtQrJ.js";import{M}from"./ManagementHeader-ym6m9w7H.js";import{u as $}from"./useClinicSync-pPWROp7F.js";import{g as L}from"./technician-CQyKWYBS.js";import{f as U}from"./displayDate-BRGhvOnj.js";import{fetchAndSetClinicTimezone as V,formatDateISO as z,getCurrentClinicTime as W}from"./appointmentLogic-ihgp36Gl.js";import{B as Y}from"./BookAppointmentForm-BgtXT8oZ.js";import{T as _}from"./Tooltip-Cof9Jr1h.js";import"./InputAdornment-BBfdgTpM.js";import"./Autocomplete-7SfYvhTE.js";import"./DateOfBirthField-8J2568o0.js";import"./ListItem-BPokTJtf.js";import"./AntdIcon-2OxomVw-.js";import"./calendarService-uG1S5kl9.js";import"./bookingRules-DFQhlYAe.js";import"./calendarRulesService-tdjIi356.js";import"./CommonCheckbox-aJ2wZ0C8.js";import"./useProvinces-BxWqgMCH.js";import"./TruncateTooltip-BVddiBa5.js";const H=({open:s,onClose:l,onConfirm:d,title:c="Confirm Action",message:p="Are you sure you want to proceed?",loading:u=!1,confirmButtonText:m="Confirm",confirmButtonColor:h="primary",showWarningIcon:f=!0})=>{const g=()=>{l()};return e.jsxs(t,{open:s,onClose:u?void 0:g,maxWidth:"sm",fullWidth:!0,PaperProps:{sx:{borderRadius:2}},children:[e.jsx(a,{children:e.jsxs(n,{display:"flex",alignItems:"center",gap:1,children:[f&&e.jsx(B,{style:{color:"#ff6b6b",fontSize:"20px"}}),e.jsx(i,{variant:"h6",component:"div",children:c})]})}),e.jsx(o,{children:e.jsx(i,{variant:"body1",color:"text.secondary",children:p})}),e.jsxs(k,{sx:{px:3,pb:3},children:[e.jsx(r,{onClick:g,color:"inherit",disabled:u,children:"Cancel"}),e.jsx(r,{onClick:()=>{d()},color:h,variant:"contained",disabled:u,children:u?"Processing...":m})]})]})};H.propTypes={open:s.bool.isRequired,onClose:s.func.isRequired,onConfirm:s.func.isRequired,title:s.string,message:s.string,loading:s.bool,confirmButtonText:s.string,confirmButtonColor:s.oneOf(["primary","secondary","error","warning","info","success"]),showWarningIcon:s.bool};const G="appointmentList_columnVisibility",J={patientName:!0,dob:!0,email:!0,phone:!0,gender:!0,healthCard:!0,technicianName:!0,service:!0,serviceCode:!0,scan:!0,date:!0,time:!0,createdDate:!0,createdTime:!0,lastVisit:!0,status:!0,actions:!0},Q=()=>{const{selectedClinicId:t,clinicList:a,loadingClinics:i,clinicError:o}=$(),s=l.useMemo(()=>y().filter(e=>["contains"].includes(e.value)),[]),B=l.useMemo(()=>C().filter(e=>["is","after","before","onOrAfter","onOrBefore"].includes(e.value)),[]),k=l.useMemo(()=>b().filter(e=>["is"].includes(e.value)),[]),Q=l.useMemo(()=>[{label:"is",value:"is",getApplyFilterFn:e=>e.value?t=>!!t&&t===e.value:null,InputComponent:({item:t,applyValue:a})=>e.jsx("input",{type:"time",value:t.value||"",onChange:e=>a({...t,value:e.target.value}),style:{width:"100%",padding:"8px",border:"1px solid #ccc",borderRadius:"4px"}})},{label:"after",value:"after",getApplyFilterFn:e=>e.value?t=>!!t&&t>e.value:null,InputComponent:({item:t,applyValue:a})=>e.jsx("input",{type:"time",value:t.value||"",onChange:e=>a({...t,value:e.target.value}),style:{width:"100%",padding:"8px",border:"1px solid #ccc",borderRadius:"4px"}})},{label:"before",value:"before",getApplyFilterFn:e=>e.value?t=>!!t&&t<e.value:null,InputComponent:({item:t,applyValue:a})=>e.jsx("input",{type:"time",value:t.value||"",onChange:e=>a({...t,value:e.target.value}),style:{width:"100%",padding:"8px",border:"1px solid #ccc",borderRadius:"4px"}})}],[]),[K,X]=l.useState([]),[Z,ee]=l.useState(!1),[te,ae]=l.useState(!1),[ne,ie]=l.useState(!1),[oe,re]=l.useState({page:0,pageSize:50}),[se,le]=l.useState([{field:"date",sort:"desc"}]),[de,ce]=l.useState(0),[pe,ue]=l.useState(""),[me,he]=l.useState({items:[]}),[fe,ge]=l.useState("today"),[ve,Se]=l.useState(()=>{const e=localStorage.getItem(G);try{return e?JSON.parse(e):J}catch(t){return J}});l.useEffect(()=>{localStorage.setItem(G,JSON.stringify(ve))},[ve]);const[ye,Ce]=l.useState(!1),[be,Ie]=l.useState([]),[Te,De]=l.useState(null),[Ne,we]=l.useState(null),[Ae,je]=l.useState({isEdit:!1,appointmentId:null,appointmentData:null,loading:!1}),[xe,Oe]=l.useState({open:!1,appointmentId:null,patientName:"",appointmentDate:"",appointmentTime:"",loading:!1}),[Pe,Fe]=l.useState({open:!1,patientDocumentId:null,patientName:""}),[Re,Ee]=l.useState({open:!1,appointmentData:null,loading:!1}),qe=P(je,ie,Ne,W),Be=async(e,t=oe.page,a=oe.pageSize,n=se,i=pe,o=me,r="today"===fe)=>{var s,l;if(e){ee(!0),ae(!1);try{let d=(null==(s=n[0])?void 0:s.field)||"appointmentDate";"date"===d&&(d="appointmentDate"),"time"===d&&(d="startTime"),"createdDate"!==d&&"createdTime"!==d||(d="createdOn"),"email"===d&&(d="patientEmail"),"phone"===d&&(d="patientPhone"),"technicianName"===d&&(d="technicianName"),"patientName"===d&&(d="patientName"),"status"===d&&(d="status"),"dob"===d&&(d="dateOfBirth"),"healthCard"===d&&(d="healthCardNumber"),"serviceCode"===d&&(d="serviceCode");const c={};if(o&&o.items){const e=new Map;for(const t of o.items)(null==t?void 0:t.field)&&null!=(null==t?void 0:t.value)&&""!==(null==t?void 0:t.value)&&e.set(t.field,t);e.forEach((e,t)=>{const a=e.value;switch(t){case"patientName":c.filterPatientName=String(a);break;case"email":c.filterPatientEmail=String(a);break;case"phone":c.filterPatientPhone=String(a);break;case"gender":{const e=Number(a);Number.isNaN(e)||(c.filterPatientGender=e);break}case"technicianName":c.filterTechnicianName=String(a);break;case"service":c.filterServiceName=String(a);break;case"scan":c.filterScanTypeName=String(a);break;case"status":{const e=Number(a);Number.isNaN(e)||(c.filterStatus=e);break}case"date":if("isAfter"===e.operator||"after"===e.operator||"onOrAfter"===e.operator)c.filterAppointmentDateFrom=new Date(a).toISOString();else if("isBefore"===e.operator||"before"===e.operator||"onOrBefore"===e.operator)c.filterAppointmentDateTo=new Date(a).toISOString();else{const e=new Date(a),t=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),0,0,0)),n=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),23,59,59));c.filterAppointmentDateFrom=t.toISOString(),c.filterAppointmentDateTo=n.toISOString()}break;case"createdDate":if("isAfter"===e.operator||"after"===e.operator||"onOrAfter"===e.operator)c.filterCreatedOnFrom=new Date(a).toISOString();else if("isBefore"===e.operator||"before"===e.operator||"onOrBefore"===e.operator)c.filterCreatedOnTo=new Date(a).toISOString();else{const e=new Date(a),t=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),0,0,0)),n=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),23,59,59));c.filterCreatedOnFrom=t.toISOString(),c.filterCreatedOnTo=n.toISOString()}break;case"dob":if("isAfter"===e.operator||"after"===e.operator||"onOrAfter"===e.operator)c.filterDateOfBirthFrom=new Date(a).toISOString();else if("isBefore"===e.operator||"before"===e.operator||"onOrBefore"===e.operator)c.filterDateOfBirthTo=new Date(a).toISOString();else{const e=new Date(a),t=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),0,0,0)),n=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),23,59,59));c.filterDateOfBirthFrom=t.toISOString(),c.filterDateOfBirthTo=n.toISOString()}break;case"healthCard":c.filterHealthCardNumber=String(a);break;case"serviceCode":c.filterServiceCode=String(a);break;case"time":try{const t=String(a);if(t&&t.includes(":")){const[a,n]=t.split(":"),i=`${a.padStart(2,"0")}:${n.padStart(2,"0")}:00`;"after"===e.operator?c.filterStartTimeFrom=i:"before"===e.operator?c.filterStartTimeTo=i:"is"===e.operator&&(c.filterStartTimeFrom=i,c.filterStartTimeTo=i)}}catch(n){}}})}const p=(await g.get("https://healthco.clinic/api/fhir/Appointment",{params:{clinicId:e,page:t+1,pageSize:a,sortBy:d,sortOrder:(null==(l=n[0])?void 0:l.sort)||"desc",search:i,defaultToToday:r,...c}})).data;let u=[],m=0;if(Array.isArray(p))u=p,m=p.length;else if(p.data||p.Data){u=p.data||p.Data||[];const e=p.pagination||p.Pagination||{};m=e.totalRecords||e.TotalRecords||e.totalCount||e.TotalCount||0}else if(p.value){const e=p.value;if(Array.isArray(e))u=e,m=e.length;else{u=e.data||e.Data||[];const t=e.pagination||e.Pagination||{};m=t.totalRecords||t.TotalRecords||t.totalCount||t.TotalCount||0}}0===m&&u.length>0&&(m=u.length),ce(m);const h=u.map((e,t)=>{var a,n,i,o;const r=be.find(t=>(t.technicianId||t.id)===(e.technicianId||e.practitionerId));return{patientName:e.fullName||e.patientName||"N/A",dob:U(e.dateOfBirth),email:e.email||"N/A",phone:e.phone||"N/A",gender:e.gender||"N/A",genderDisplay:e.genderDisplay||"N/A",healthCard:e.healthCardNumber||"N/A",technicianName:e.technicianName||"N/A",specialisation:(null==r?void 0:r.specialization)||"N/A",service:(null==(a=e.scans)?void 0:a.length)>0?[...new Set(e.scans.map(e=>e.serviceName))].join(", "):e.serviceName||e.service||"N/A",serviceCode:(null==(n=e.scans)?void 0:n.length)>0?[...new Set(e.scans.map(e=>e.serviceCode).filter(Boolean))].join(", ")||"N/A":e.serviceCode||"N/A",scan:(null==(i=e.scans)?void 0:i.length)>0?e.scans.map(e=>e.scanTypeName).join(", "):"N/A",scansList:e.scans||[],startTime:e.startTime||e.start||null,endTime:e.endTime||e.end||null,time:(()=>{const t=e.startTime||e.start,a=e.endTime||e.end,n=e=>{if(!e)return null;try{return new Date(`1970-01-01T${e}`).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}catch(t){return null}},i=n(t),o=n(a);return i&&o?`${i} - ${o}`:i||(o||"N/A")})(),date:U(e.appointmentDate),createdDate:U(e.createdOn),createdTime:e.createdOn?new Date(e.createdOn).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"N/A",lastVisit:U(e.lastVisit),appointmentId:e.appointmentId||e.id,status:e.status||"Scheduled",cancellationReason:e.cancellationReason||"",documents:e.documents||[],requisitionSheet:(null==(o=e.documents)?void 0:o.find(e=>{var t;return"Requisition Sheet"===e.description||(null==(t=e.fileName)?void 0:t.toLowerCase().includes("requisition"))}))||null}});X(h)}catch(d){c.error("Failed to load appointments. Please try again."),X([])}finally{ee(!1),ae(!0)}}};l.useEffect(()=>{if(t){(async()=>{ee(!0),ae(!1),await V(t),await(async e=>{if(!e)return;const{clinicDetails:t,rescheduleRule:a}=await q(e);De(t),we(a)})(t),await(async e=>{if(e)try{const t=await L(e),a=Array.isArray(t.data)?t.data:[];Ie(a)}catch(t){Ie([])}})(t),Be(t)})()}},[t]),l.useEffect(()=>{t&&be.length>0&&Be(t)},[be]),l.useEffect(()=>{t&&te&&Be(t)},[fe]);const ke=e=>new Promise((t,a)=>{const n=new FileReader;n.readAsDataURL(e),n.onload=()=>{const e=n.result||"",a="string"==typeof e?e.indexOf(","):-1;t(-1!==a?e.substring(a+1):e)},n.onerror=e=>a(e)}),Me=e=>E(e,Ne,W()),$e=l.useMemo(()=>[{field:"patientName",headerName:"Patient Name",width:150,sortable:!0,filterable:!0,filterOperators:s},{field:"dob",headerName:"Date of birth",width:150,sortable:!0,filterable:!0,type:"date",filterOperators:B,valueFormatter:e=>U(e)},{field:"email",headerName:"Email",width:150,sortable:!0,filterable:!0,filterOperators:s},{field:"phone",headerName:"Phone no.",width:140,sortable:!0,filterable:!0,filterOperators:s},{field:"gender",headerName:"Gender",width:100,sortable:!0,filterable:!0,type:"singleSelect",filterOperators:k,valueOptions:[{value:1,label:"Male"},{value:2,label:"Female"},{value:3,label:"Other"}],valueGetter:e=>e,renderCell:e=>e.row.genderDisplay||"N/A"},{field:"healthCard",headerName:"Health card ID",width:160,sortable:!0,filterable:!0,filterOperators:s},{field:"technicianName",headerName:"Technician Name",width:140,sortable:!0,filterable:!0,filterOperators:s},{field:"service",headerName:"Services",width:160,sortable:!0,filterable:!0,filterOperators:s},{field:"serviceCode",headerName:"Service Codes",width:160,sortable:!0,filterable:!0,filterOperators:s},{field:"scan",headerName:"Scans",width:160,sortable:!0,filterable:!0,filterOperators:s},{field:"date",headerName:"Appointment Date",width:150,sortable:!0,filterable:!0,type:"date",filterOperators:B,valueFormatter:e=>U(e)},{field:"time",headerName:"Appointment Time",width:150,sortable:!0,filterable:!0,filterOperators:Q,valueGetter:(e,t)=>t.startTime},{field:"createdDate",headerName:"Created Date",width:130,sortable:!0,filterable:!0,type:"date",filterOperators:B,valueFormatter:e=>U(e)},{field:"createdTime",headerName:"Created Time",width:130,sortable:!0,filterable:!1},{field:"lastVisit",headerName:"Last visit",width:120,sortable:!1,filterable:!1},{field:"status",headerName:"Status",width:170,sortable:!0,filterable:!0,type:"singleSelect",filterOperators:k,valueOptions:[{value:0,label:"Booked"},{value:1,label:"Confirmed"},{value:2,label:"In Progress"},{value:3,label:"Completed"},{value:4,label:"Cancelled"},{value:5,label:"Rescheduled"},{value:6,label:"No Show"}],renderCell:t=>{var a;const n=t.row,i="number"==typeof n.status?n.status:N(n.status);if(i===x.CANCELLED||i===x.COMPLETED){const t=w(i),o=A(t),r="number"==typeof n.status?(null==(a=j)?void 0:a[n.status])||"—":n.status||"—",s=i===x.CANCELLED&&n.cancellationReason?n.cancellationReason:"";return e.jsx(_,{title:s,children:e.jsx(d,{label:r,size:"small",variant:"filled",sx:{bgcolor:t,color:o,fontWeight:600}})})}return e.jsx("span",{onMouseDown:e=>e.stopPropagation(),onKeyDown:e=>e.stopPropagation(),children:e.jsx(O,{appointmentId:n.appointmentId,currentStatus:n.status,onStatusChanged:(e,t)=>{X(e=>e.map(e=>e.appointmentId===n.appointmentId?{...e,status:t,cancellationReason:void 0}:e));try{c.success(`Status updated to ${t}`)}catch(a){}}})})}},{field:"actions",headerName:"Actions",width:150,sortable:!1,filterable:!1,renderCell:t=>{const a=t.row;return e.jsxs(p,{direction:"row",spacing:1,justifyContent:"center",children:[e.jsx(_,{title:a.requisitionSheet?"Preview Requisition Sheet":"No requisition sheet available",children:e.jsx("span",{children:e.jsx(u,{color:"info",size:"small","aria-label":`preview-${a.appointmentId}`,onClick:e=>{e.stopPropagation(),(async e=>{e.requisitionSheet?Fe({open:!0,patientDocumentId:e.requisitionSheet.patientDocumentId,patientName:e.patientName}):c.warning("No requisition sheet available for this appointment")})(a)},disabled:!a.requisitionSheet,children:e.jsx(I,{fontSize:"small"})})})}),e.jsx(_,{title:(()=>{const e=String(a.status||"").toLowerCase();return"cancelled"===e?"Already cancelled":"completed"===e?"Cannot cancel completed appointment":Me(a).allowed?"Cancel":Me(a).reason})(),children:e.jsx("span",{children:e.jsx(u,{color:"error",size:"small","aria-label":`cancel-${a.appointmentId}`,onClick:e=>{e.stopPropagation(),(e=>{if("completed"===String(e.status||"").toLowerCase())return void c.error("Cannot cancel a completed appointment");const t=Me(e);t.allowed?Oe({open:!0,appointmentId:e.appointmentId,patientName:e.patientName,appointmentDate:e.date,appointmentTime:e.time,loading:!1}):c.error(t.reason)})(a)},disabled:(()=>{const e=String(a.status||"").toLowerCase();return"cancelled"===e||"completed"===e||!Me(a).allowed})(),children:e.jsx(S,{fontSize:"small"})})})}),e.jsx(_,{title:(()=>{const e=String(a.status||"").toLowerCase();return"cancelled"===e?"Cannot edit cancelled appointment":"completed"===e?"Cannot edit completed appointment":Me(a).allowed?"Edit":Me(a).reason})(),children:e.jsx("span",{children:e.jsx(u,{color:"primary",size:"small","aria-label":`edit-${a.appointmentId}`,onClick:e=>{e.stopPropagation(),qe(a.appointmentId,a)},disabled:(()=>{const e=String(a.status||"").toLowerCase();return"cancelled"===e||"completed"===e||!Me(a).allowed})(),children:e.jsx(m,{fontSize:"small"})})})})]})}}],[be]);return e.jsxs(n,{children:[e.jsx(M,{icon:h.BookAppointment,title:"Appointment List",description:"Manage appointments and manually book appointments",clinics:a,selectedClinicId:t,addButtonLabel:"Add Booking",onAdd:()=>{je({isEdit:!1,appointmentId:null,appointmentData:null,loading:!1}),ie(!0)},addButtonDisabled:!t,loadingClinics:i,clinicError:o,extraActions:e.jsx(r,{variant:"outlined",onClick:()=>{Ce(!0)},startIcon:e.jsx(f,{}),sx:{width:"auto",borderRadius:2,padding:"8px 16px",textTransform:"none",fontWeight:600},children:"View Calendar"})}),e.jsx(T,{rows:K,columns:$e,getRowId:e=>e.appointmentId,loading:Z,filterModel:me,onFilterModelChange:e=>{he(e),Be(t,void 0,void 0,void 0,void 0,e)},paginationModel:oe,onPaginationModelChange:e=>{re(e),Be(t,e.page,e.pageSize)},rowCount:de,pageSizeOptions:[10,25,50,100],sortModel:se,onSortModelChange:e=>{le(e),Be(t,void 0,void 0,e)},columnVisibilityModel:ve,onColumnVisibilityModelChange:e=>Se(e),searchInput:pe,onSearchInputChange:e=>ue(e.target.value),onSearchSubmit:()=>{re(e=>({...e,page:0})),Be(t,0,void 0,void 0,pe)},onClearSearch:()=>{ue(""),re(e=>({...e,page:0})),Be(t,0,void 0,void 0,"")},onResetAll:()=>{ue(""),re({page:0,pageSize:50}),le([{field:"date",sort:"desc"}]),Be(t,0,50,[{field:"date",sort:"desc"}],"")},searchPlaceholder:"Search patients, services, technicians...",showDateFilter:!0,dateFilterValue:fe,onDateFilterChange:e=>ge(e.target.value),onRowClick:e=>(async e=>{var t;Ee({open:!0,appointmentData:null,loading:!0});try{const a=await g.get(`https://healthco.clinic/api/fhir/Appointment/${e.appointmentId}`),n=(null==(t=a.data)?void 0:t.value)||a.data;Ee({open:!0,appointmentData:n,loading:!1})}catch(a){c.error("Failed to fetch appointment details. Please try again."),Ee({open:!1,appointmentData:null,loading:!1})}})(e.row)}),e.jsx(Y,{open:ne,onClose:()=>{ie(!1),je({isEdit:!1,appointmentId:null,appointmentData:null,loading:!1})},onSubmit:async(e,a="full")=>{var n,i,o,r,s,l;try{if(Ae.isEdit&&"patientInfoOnly"===a)return await(async(e,a="full")=>{var n,i,o,r,s,l,d,p,u;try{if(!Ae.appointmentId)return c.error("No appointment ID for edit"),!1;const r=Ae.appointmentId,s=Ae.appointmentData;let l=[];if(e.requisitionSheet)if(e.requisitionSheet.isExistingDocument)l.push({patientDocumentId:e.requisitionSheet.patientDocumentId,fileName:e.requisitionSheet.name,fileType:e.requisitionSheet.type,base64Data:e.requisitionSheet.base64Data,description:"Requisition Sheet",storagePath:e.requisitionSheet.storagePath||""});else{const t=await ke(e.requisitionSheet);l.push({patientDocumentId:0,fileName:e.requisitionSheet.name,fileType:e.requisitionSheet.type,base64Data:t,description:"Requisition Sheet",storagePath:""})}const d=(e.scanResponses||[]).map(e=>({scanTypeId:e.scanTypeId,scanTypeQuestionId:e.scanTypeQuestionId,response:e.response}));let p;if("patientInfoOnly"===a){const a=(null==(i=null==(n=s.scans)?void 0:n[0])?void 0:i.serviceId)||0;p={appointmentId:r,fullName:e.fullName,gender:e.gender,identifiedAs:s.identifiedAs||0,email:e.email,phone:e.phone,dateOfBirth:e.dob?z(e.dob):s.dateOfBirth,coverageType:e.coverageType??s.coverageType??1,healthCardNumber:e.healthCardNumber,healthCardProvinceId:e.healthCardProvince?parseInt(e.healthCardProvince):s.healthCardProvinceId,uciNumber:e.uciNumber||null,allergies:e.allergies,medicalNotes:e.medicalNotes,clinicId:parseInt(t),technicianId:s.technicianId,appointmentDate:s.appointmentDate?z(s.appointmentDate):null,startTime:s.startTime,endTime:s.endTime,serviceScanSelections:(null==(o=s.scans)?void 0:o.map(e=>({serviceId:a,scanTypeId:e.scanTypeId})))||[],scanResponses:s.scanResponses||[],documents:l,reasonForVisit:s.reasonForVisit||"",notes:s.notes||""}}else{if(!e.selectedSlots||0===e.selectedSlots.length)return c.error("Please select an appointment slot"),!1;const a=e.selectedSlots[0];p={appointmentId:r,fullName:e.fullName,gender:e.gender,identifiedAs:s.identifiedAs||0,email:e.email,phone:e.phone,dateOfBirth:e.dob?z(e.dob):s.dateOfBirth,coverageType:e.coverageType??s.coverageType??1,healthCardNumber:e.healthCardNumber,healthCardProvinceId:e.healthCardProvince?parseInt(e.healthCardProvince):s.healthCardProvinceId,uciNumber:e.uciNumber||null,allergies:e.allergies,medicalNotes:e.medicalNotes,clinicId:parseInt(t),technicianId:a.technicianId,appointmentDate:z(a.date),startTime:a.startTime,endTime:a.endTime,serviceScanSelections:(e.selectedScanTypeIds||[]).map(e=>({serviceId:a.serviceId,scanTypeId:e})),scanResponses:d,documents:l,reasonForVisit:s.reasonForVisit||"",notes:s.notes||""};try{const e=e=>{if(!e)return null;const t=new Date(e);return isNaN(t)?null:`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`},t=e=>e?String(e).slice(0,5):null,n=e(s.appointmentDate),i=e(a.date),o=t(s.startTime)!==t(a.startTime),r=t(s.endTime)!==t(a.endTime);(n!==i||o||r)&&(p.status=x.RESCHEDULED)}catch(m){}}return await g.put(`https://healthco.clinic/api/fhir/Appointment/${r}`,p),"patientInfoOnly"===a?c.success("Patient information updated successfully!"):c.success("Appointment updated successfully!"),await Be(t),!0}catch(h){if(null==(s=null==(r=h.response)?void 0:r.data)?void 0:s.errors){const e=Object.values(h.response.data.errors).flat();c.error(`Failed to update: ${e.join(", ")}`)}else(null==(d=null==(l=h.response)?void 0:l.data)?void 0:d.message)?c.error(`Failed to update: ${h.response.data.message}`):(null==(u=null==(p=h.response)?void 0:p.data)?void 0:u.title)?c.error(`Failed to update: ${h.response.data.title}`):c.error("Failed to update appointment. Please try again.");return!1}})(e,a);if(!t)return c.error("No clinic selected"),!1;if(!e.selectedScanTypeIds||0===e.selectedScanTypeIds.length)return c.error("No scan types selected"),!1;if(!e.selectedScansWithServices||0===e.selectedScansWithServices.length)return c.error("No scans with service information found"),!1;let l=e.resolvedAppointments||[];if(0===l.length)try{const{splitAppointments:a}=await v(async()=>{const{splitAppointments:e}=await import("./appointmentLogic-ihgp36Gl.js");return{splitAppointments:e}},__vite__mapDeps([0,1,2]));l=await a(e.selectedScansWithServices,t)}catch(d){return c.error("Failed to process appointment structure. Please try again."),!1}if(0===l.length)return c.error("No appointments found. Please go back to the Date & Time step."),!1;let u=[];if(e.requisitionSheet)if(e.requisitionSheet.isExistingDocument)u.push({patientDocumentId:e.requisitionSheet.patientDocumentId,fileName:e.requisitionSheet.name,fileType:e.requisitionSheet.type,base64Data:e.requisitionSheet.base64Data,description:"Requisition Sheet",storagePath:e.requisitionSheet.storagePath||""});else try{const t=await ke(e.requisitionSheet);u=[{patientDocumentId:0,fileName:e.requisitionSheet.name,fileType:e.requisitionSheet.type,base64Data:t,description:"Requisition Sheet"}]}catch(p){return c.error("Failed to process requisition sheet. Please try again or choose a different file."),!1}const m=(e.selectedSlots||[]).filter(Boolean);if(0===m.length&&!e.selectedSlot)return c.error("Please select a time slot for each appointment"),!1;if(l.length>1&&m.length<l.length&&!e.selectedSlot)return c.error(`You need ${l.length} appointments. Please select a time slot for each appointment.`),!1;let h=-1,f=0;if(Ae.isEdit&&Ae.appointmentData){const e=(null==(n=Ae.appointmentData.scans)?void 0:n.map(e=>e.scanTypeId))||[];let t=-1;for(let a=0;a<l.length;a++){const n=l[a],o=((null==(i=n.scans)?void 0:i.map(e=>e.scanTypeId))||n.scanTypeIds||[]).filter(t=>e.includes(t)).length;o>f&&(f=o,t=a)}h=f>0?t:0}const S=[];for(let a=0;a<l.length;a++){const n=l[a];try{const i=m;let l=null;if(i.length>0&&(l=i.find(e=>e&&e.appointmentIndex===a),!l&&n.serviceId&&(l=i.find(e=>e&&e.serviceId===n.serviceId)),!l&&i[a]&&(l=i[a])),!l&&e.selectedSlot&&(l=e.selectedSlot),!l){const e=(null==(o=n.scans)?void 0:o.length)>0?`appointment with ${n.scans.length} scans`:`appointment ${a+1}`;throw c.error(`No time slot found for ${e}. Please ensure all appointments have selected time slots.`),new Error(`No time slot found for ${e}. Please ensure all appointments have selected time slots.`)}let d=null;e.healthCardProvince&&(d="number"==typeof e.healthCardProvince||"string"!=typeof e.healthCardProvince||isNaN(e.healthCardProvince)?e.healthCardProvince:parseInt(e.healthCardProvince,10));let v=[];n.scans&&n.scans.length>0?v=n.scans.map(e=>({serviceId:e.serviceId,scanTypeId:e.scanTypeId})):n.scanTypeIds&&n.serviceId&&(v=n.scanTypeIds.map(e=>({serviceId:n.serviceId,scanTypeId:e})));const y=(null==(r=e.scanResponses)?void 0:r.filter(e=>{var t;return((null==(t=n.scans)?void 0:t.map(e=>e.scanTypeId))||n.scanTypeIds||[]).includes(e.scanTypeId)}))||[],C=v.length,b=[...new Set(v.map(t=>{var a;return null==(a=e.selectedScansWithServices.find(e=>e.serviceId===t.serviceId))?void 0:a.serviceName}).filter(Boolean))],I={fullName:e.fullName,gender:e.gender,identifiedAs:e.identifyAs??0,email:e.email||null,phone:e.phone,dateOfBirth:z(e.dob),coverageType:e.coverageType??1,healthCardNumber:e.healthCardNumber||null,healthCardProvinceId:d,uciNumber:e.uciNumber||null,allergies:e.allergies||null,medicalNotes:e.medicalNotes||null,clinicId:t,technicianId:l.technicianId,appointmentDate:z(l.date),startTime:l.startTime,endTime:l.endTime,serviceScanSelections:v,scanResponses:y,documents:u,reasonForVisit:"",notes:C>1?`Multiple scans: ${C} scans from ${b.join(", ")}`:""};let T;if(Ae.isEdit&&a===h){const e=Ae.appointmentId,t=Ae.appointmentData;I.appointmentId=e;const a=(null==(s=t.scans)?void 0:s.map(e=>e.scanTypeId))||[],n=v.map(e=>e.scanTypeId),i=a.length!==n.length||!a.every(e=>n.includes(e));try{const e=e=>{if(!e)return null;const t=new Date(e);if(isNaN(t))return null;return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`},a=e=>e?String(e).slice(0,5):null,n=e(t.appointmentDate),o=e(l.date),r=a(t.startTime)!==a(l.startTime),s=a(t.endTime)!==a(l.endTime);n!==o||r||s?I.status=x.RESCHEDULED:i&&0===h&&0===f&&(I.status=x.BOOKED)}catch(p){}T=await g.put(`https://healthco.clinic/api/fhir/Appointment/${e}`,I,{headers:{"Content-Type":"application/json",Accept:"application/json"}})}else T=await g.post("https://healthco.clinic/api/fhir/Appointment",I,{headers:{"Content-Type":"application/json",Accept:"application/json"}});S.push(T)}catch(d){S.push({error:d,status:"error"})}}if(S.every(e=>!e.error&&(200===e.status||201===e.status))){const e=S.length;return Ae.isEdit?c.success("Appointment updated successfully!"):c.success(1===e?"Appointment booked successfully!":`Booked ${e} appointments successfully!`),Be(t),!0}return c.warning("Some appointments may not have been created/updated successfully"),!1}catch(d){let e="An unexpected error occurred. Please try again later.";if(null==(l=d.response)?void 0:l.data){const t=d.response.data;t.detail?e=t.detail:t.title?e=t.title:t.errors&&Array.isArray(t.errors)&&t.errors.length>0?e=t.errors[0]:"string"==typeof t&&(e=t)}else e=d.request?"Network error. Please check your connection and try again.":d.message||e;return c.error(e),!1}},clinicId:t,editState:Ae}),e.jsx(H,{open:xe.open,onClose:()=>{xe.loading||Oe({open:!1,appointmentId:null,patientName:"",appointmentDate:"",appointmentTime:"",loading:!1})},onConfirm:async()=>{var e;if(xe.appointmentId){Oe(e=>({...e,loading:!0}));try{200===(await g.put(`https://healthco.clinic/api/fhir/Appointment/${xe.appointmentId}/status`,{appointmentId:xe.appointmentId,newStatus:x.CANCELLED,remarks:"Cancelled by clinic admin"},{headers:{"Content-Type":"application/json",Accept:"application/json"}})).status&&(c.success("Appointment cancelled successfully!"),t&&Be(t),Oe({open:!1,appointmentId:null,patientName:"",appointmentDate:"",appointmentTime:"",loading:!1}))}catch(a){let t="Failed to cancel appointment. Please try again.";if(null==(e=a.response)?void 0:e.data){const e=a.response.data;e.detail?t=e.detail:e.title?t=e.title:e.errors&&Array.isArray(e.errors)&&e.errors.length>0?t=e.errors[0]:"string"==typeof e&&(t=e)}c.error(t),Oe(e=>({...e,loading:!1}))}}},title:"Cancel Appointment",message:`Are you sure you want to cancel the appointment for ${xe.patientName} scheduled on ${xe.appointmentDate} at ${xe.appointmentTime}? This action cannot be undone.`,loading:xe.loading,confirmButtonText:"Cancel Appointment",confirmButtonColor:"error"}),e.jsx(D,{open:Pe.open,onClose:()=>{Fe({open:!1,patientDocumentId:null,patientName:""})},patientDocumentId:Pe.patientDocumentId,patientName:Pe.patientName,title:"Requisition Sheet"}),e.jsx(F,{open:Re.open,onClose:()=>{Ee({open:!1,appointmentData:null,loading:!1})},selectedAppointment:Re.appointmentData,appointmentDetailsLoading:Re.loading,onEdit:qe,canModifyAppointment:Me,onStatusUpdated:async()=>{try{t&&await Be(t)}catch(e){}}}),e.jsx(R,{open:ye,onClose:()=>Ce(!1),clinicId:t,onEdit:qe,canModifyAppointment:Me})]})};export{Q as default};
