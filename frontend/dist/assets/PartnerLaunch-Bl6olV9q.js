const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/appointmentLogic-ihgp36Gl.js","assets/index-DyR0ftVW.js","assets/index-Bs-55i82.css"])))=>i.map(i=>d[i]);
import{n as e,r as t,y as n,j as r,p as i,C as o,T as s,cE as a,ab as l,m as c}from"./index-DyR0ftVW.js";import{u as d,B as p}from"./BookAppointmentForm-BgtXT8oZ.js";import{fetchAndSetClinicTimezone as u,formatDateISO as m}from"./appointmentLogic-ihgp36Gl.js";import"./DateOfBirthField-8J2568o0.js";import"./InputAdornment-BBfdgTpM.js";import"./DialogActions-BmwBtQrJ.js";import"./ListItem-BPokTJtf.js";import"./calendarService-uG1S5kl9.js";import"./bookingRules-DFQhlYAe.js";import"./calendarRulesService-tdjIi356.js";import"./Tooltip-Cof9Jr1h.js";import"./CommonCheckbox-aJ2wZ0C8.js";import"./useProvinces-BxWqgMCH.js";import"./TruncateTooltip-BVddiBa5.js";(()=>{const e=performance.now()})();const h=()=>{const[h]=e(),[f,g]=t.useState(!0),[y,v]=t.useState(!1),[x,b]=t.useState(null),[I,j]=t.useState(!1),S=t.useRef(!1),{branding:k,colors:T,loading:C}=d(x,!0);t.useEffect(()=>{},[]),t.useEffect(()=>{x&&u(x)},[x]),t.useEffect(()=>{},[C,T,k,x]),t.useEffect(()=>{j(!!x&&!(C||!T||!k))},[x,C,T,k]),t.useEffect(()=>{const e=h.get("client_id"),t=h.get("clinic_id"),r=h.get("expires"),i=h.get("sig");if(!(e&&t&&r&&i))return n.error("Invalid booking link. Missing required parameters."),g(!1),void v(!1);const o=parseInt(r,10);if(isNaN(o))return n.error("Invalid booking link. Expiration time is malformed."),g(!1),void v(!1);if(Math.floor(Date.now()/1e3)>o)return n.error("This booking link has expired. Please request a new one."),g(!1),void v(!1);b(parseInt(t,10)),v(!0),g(!1)},[h]);return f?r.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"100vh",backgroundColor:"#f8fafc",gap:2},children:[r.jsx(o,{size:48}),r.jsx(s,{variant:"body1",color:"text.secondary",children:"Validating booking link..."})]}):y?I?r.jsxs(i,{sx:{minHeight:"100vh",backgroundColor:(null==T?void 0:T.primary)?`${T.primary}0d`:"#f8fafc",display:"flex",flexDirection:"column"},children:[r.jsx(i,{sx:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",py:4},children:r.jsx(p,{open:!0,onClose:()=>{S.current||n.info("Please complete your booking or close the browser tab.")},onSubmit:async(e,t="full")=>{var r,i,o,s;try{if(!x)return n.error("Invalid booking link - missing clinic information"),!1;if(!e.selectedScanTypeIds||0===e.selectedScanTypeIds.length)return n.error("No scan types selected"),!1;if(!e.selectedScansWithServices||0===e.selectedScansWithServices.length)return n.error("No scans with service information found"),!1;let t=e.resolvedAppointments||[];if(0===t.length)try{const{splitAppointments:n}=await l(async()=>{const{splitAppointments:e}=await import("./appointmentLogic-ihgp36Gl.js");return{splitAppointments:e}},__vite__mapDeps([0,1,2]));t=await n(e.selectedScansWithServices,x)}catch(a){return n.error("Failed to process appointment structure. Please try again."),!1}if(0===t.length)return n.error("No appointments found. Please go back to the Date & Time step."),!1;let o=[];if(e.requisitionSheet)try{const t=await(s=e.requisitionSheet,new Promise((e,t)=>{const n=new FileReader;n.readAsDataURL(s),n.onload=()=>{const t=n.result||"",r="string"==typeof t?t.indexOf(","):-1;e(-1!==r?t.substring(r+1):t)},n.onerror=e=>t(e)}));o=[{fileName:e.requisitionSheet.name,fileType:e.requisitionSheet.type,base64Data:t,description:"Requisition Sheet"}]}catch(d){return n.error("Failed to process requisition sheet. Please try again or choose a different file."),!1}const p=(e.selectedSlots||[]).filter(Boolean);if(0===p.length&&!e.selectedSlot)return n.error("Please select a time slot for each appointment"),!1;if(t.length>1&&p.length<t.length&&!e.selectedSlot)return n.error(`You need ${t.length} appointments. Please select a time slot for each appointment.`),!1;const u=[];for(let s=0;s<t.length;s++){const l=t[s];try{const t=p;let a=null;if(t.length>0&&(a=t.find(e=>e&&e.appointmentIndex===s),!a&&l.serviceId&&(a=t.find(e=>e&&e.serviceId===l.serviceId)),!a&&t[s]&&(a=t[s])),!a&&e.selectedSlot&&(a=e.selectedSlot),!a){const e=(null==(r=l.scans)?void 0:r.length)>0?`appointment with ${l.scans.length} scans`:`appointment ${s+1}`;throw n.error(`No time slot found for ${e}. Please ensure all appointments have selected time slots.`),new Error(`No time slot found for ${e}`)}let d=null;e.healthCardProvince&&(d="number"==typeof e.healthCardProvince||"string"!=typeof e.healthCardProvince||isNaN(e.healthCardProvince)?e.healthCardProvince:parseInt(e.healthCardProvince,10));let h=[];l.scans&&l.scans.length>0?h=l.scans.map(e=>({serviceId:e.serviceId,scanTypeId:e.scanTypeId})):l.scanTypeIds&&l.serviceId&&(h=l.scanTypeIds.map(e=>({serviceId:l.serviceId,scanTypeId:e})));const f=(null==(i=e.scanResponses)?void 0:i.filter(e=>{var t;return((null==(t=l.scans)?void 0:t.map(e=>e.scanTypeId))||l.scanTypeIds||[]).includes(e.scanTypeId)}))||[],g=h.length,y=[...new Set(h.map(t=>{var n;return null==(n=e.selectedScansWithServices.find(e=>e.serviceId===t.serviceId))?void 0:n.serviceName}).filter(Boolean))],v={fullName:e.fullName,gender:e.gender,identifiedAs:e.identifyAs??0,email:e.email||null,phone:e.phone,dateOfBirth:m(e.dob),coverageType:e.coverageType??1,healthCardNumber:e.healthCardNumber||null,healthCardProvinceId:d,uciNumber:e.uciNumber||null,allergies:e.allergies||null,medicalNotes:e.medicalNotes||null,clinicId:x,technicianId:a.technicianId,appointmentDate:m(a.date),startTime:a.startTime,endTime:a.endTime,serviceScanSelections:h,scanResponses:f,documents:o,reasonForVisit:"",notes:g>1?`Multiple scans: ${g} scans from ${y.join(", ")}`:""},b=await c.post("https://healthco.clinic/api/fhir/Appointment",v,{headers:{"Content-Type":"application/json",Accept:"application/json"}});u.push(b)}catch(a){u.push({error:a,status:"error"})}}if(u.every(e=>!e.error&&(200===e.status||201===e.status))){const e=u.length;return S.current=!0,n.success(1===e?"Appointment booked successfully!":`Booked ${e} appointments successfully!`),!0}return n.warning("Some appointments may not have been created successfully"),!1}catch(a){let e="An unexpected error occurred. Please try again later.";if(null==(o=a.response)?void 0:o.data){const t=a.response.data;t.detail?e=t.detail:t.title?e=t.title:t.errors&&Array.isArray(t.errors)&&t.errors.length>0?e=t.errors[0]:"string"==typeof t&&(e=t)}else e=a.request?"Network error. Please check your connection and try again.":a.message||e;return n.error(e),!1}},clinicId:x,editState:{isEdit:!1},isPublicBooking:!0,brandColors:{primary:null==T?void 0:T.primary,primaryHover:null==T?void 0:T.primaryHover,secondary:null==T?void 0:T.secondary,secondaryHover:null==T?void 0:T.secondaryHover,logoBase64:null==k?void 0:k.logoBase64}})}),r.jsx(i,{sx:{py:2,backgroundColor:"white",borderTop:"1px solid #e5e7eb",textAlign:"center",mt:"auto"},children:r.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[r.jsx(s,{variant:"body2",sx:{color:"#6b7280",fontWeight:500,fontSize:"0.875rem"},children:"Powered By"}),r.jsx(i,{component:"img",src:a,alt:"HealthCo Logo",sx:{maxWidth:"150px",height:"auto",objectFit:"contain"}})]})})]}):r.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"100vh",backgroundColor:"#f8fafc",gap:2},children:[r.jsx(o,{size:48}),r.jsx(s,{variant:"body1",color:"text.secondary",children:"Preparing your booking page..."})]}):r.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"100vh",backgroundColor:"#f8fafc",gap:2,padding:3},children:[r.jsx(s,{variant:"h5",color:"error",gutterBottom:!0,children:"Invalid Booking Link"}),r.jsx(s,{variant:"body1",color:"text.secondary",textAlign:"center",maxWidth:"sm",children:"The booking link you are trying to access is invalid or has expired. Please contact the clinic for a new booking link."})]})};export{h as default};
