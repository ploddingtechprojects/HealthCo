import{ab as e}from"./index-DyR0ftVW.js";let n=null;const t=e=>{n=e},s=()=>n,i=async e=>{try{const n=await fetch(`https://healthco.clinic/api/fhir/Organization/${e}`),s=await n.json();void 0!==s.utcOffsetMinutes&&t(s.utcOffsetMinutes)}catch(n){}},a=()=>{const e=new Date;if(null===n)return e;const t=e.getTime()+6e4*e.getTimezoneOffset();return new Date(t+6e4*n)},r=e=>{if("string"==typeof e&&/^\d{4}-\d{2}-\d{2}$/.test(e)){const[n,t,s]=e.split("-").map(Number);return new Date(Date.UTC(n,t-1,s,12,0,0,0)).toISOString()}const n="string"==typeof e?new Date(e):e,t=n.getFullYear(),s=n.getMonth(),i=n.getDate();return new Date(Date.UTC(t,s,i,12,0,0,0)).toISOString()},c=e=>{if(!e||!Array.isArray(e))return[];const n=e.reduce((e,n)=>{const t=`${n.serviceId}-${n.serviceName}`;return e[t]||(e[t]={serviceId:n.serviceId,serviceName:n.serviceName,scanTypeIds:[],scans:[]}),e[t].scanTypeIds.push(n.scanTypeId),e[t].scans.push(n),e},{});return Object.values(n)},o=e=>{if(!e||!e.scans||0===e.scans.length)return e;const n=[...new Set(e.scans.map(e=>e.serviceName))];let t;return t=1===n.length?n[0]:`Mixed Services (${n.join(", ")})`,{...e,serviceName:t,serviceId:e.scans[0].serviceId}},l=e=>{if(!e||!Array.isArray(e))return[];if(0===e.length)return[];const n=[...new Set(e.map(e=>e.serviceName))],t=1===n.length?n[0]:`Mixed Services (${n.join(", ")})`;return[{serviceId:e[0].serviceId,serviceName:t,scanTypeIds:e.map(e=>e.scanTypeId),scans:e,splitReason:"no-service-splitting"}]},d=(e,n)=>{const t=e.filter(e=>"SAS"===e.ruleCode&&e.isEnabled);if(0===t.length)return!1;const s=[...new Set(n.map(e=>e.serviceId))];if(s.length<=1)return!1;for(const a of t)try{const e=JSON.parse(a.configJson||"{}");if(!e.enabled)continue;const n=[];Object.keys(e).forEach(t=>{t.startsWith("service")&&"number"==typeof e[t]&&n.push(e[t])});if(s.filter(e=>n.includes(e)).length>=2)return!0}catch(i){}return!1},p=(e,n)=>{if(!e||0===e.length)return e;if(!n||!n.enabled&&!n.Enabled)return e;const t=n.enabled||n.Enabled;let s=[];if(n.primary||n.Primary){s=[{primary:n.primary||n.Primary,secondary:n.secondary||n.Secondary||[],minWait:n.minWait||n.MinWait||0}]}else s=n.rules||n.Rules||[];if(!t||!s.length)return e;const i=e.map((e,n)=>({...e,appointmentId:e.appointmentId||`apt-${n}`,requiresAfter:e.requiresAfter||[],minWaitMinutes:e.minWaitMinutes||0,schedulingOrder:e.schedulingOrder||0}));for(const a of s){const e=a.primary||a.Primary,n=a.secondary||a.Secondary||[],t=a.minWait||a.MinWait||0,s=i.filter(n=>n.scanTypeIds.includes(e)),r=i.filter(e=>n.some(n=>e.scanTypeIds.includes(n)));for(const i of s)for(const e of r)i.appointmentId!==e.appointmentId&&(i.requiresAfter.includes(e.appointmentId)||i.requiresAfter.push(e.appointmentId),i.minWaitMinutes=Math.max(i.minWaitMinutes,t),e.schedulingOrder=Math.min(e.schedulingOrder,0),i.schedulingOrder=Math.max(i.schedulingOrder,1))}return i},u=(e,n)=>{var t,s;if(!e||0===e.length)return e;if(!n||0===n.length)return e;const i=n.reduce((e,n)=>(e[n.scanTypeId]=n,e),{}),a=[];for(const r of e){const e=[],n=[];for(const t of r.scanTypeIds||[]){const s=i[t];if(!s){n.push(t);continue}const a=(null==s?void 0:s.bookingRules)||(null==s?void 0:s.BookingRules)||[],r=a.some(e=>1===e.ruleType&&e.isEnabled),c=a.some(e=>2===e.ruleType&&e.isEnabled);r||c?e.push({scanTypeId:t,scanType:s,ruleType:r?"OB_HIGH_RISK":"NT_SCAN"}):n.push(t)}if(0!==e.length)if(1!==e.length||0!==n.length){for(let n=0;n<e.length;n++){const s=e[n];let i={...r,scanTypeIds:[s.scanTypeId],scans:(null==(t=r.scans)?void 0:t.filter(e=>e.scanTypeId===s.scanTypeId))||[],appointmentId:`${r.appointmentId||"apt"}-${s.ruleType.toLowerCase()}-${n}`,splitReason:`booking-rule-${s.ruleType.toLowerCase()}`,bookingRuleType:s.ruleType,requiresSpecialHandling:!0};i=o(i),a.push(i)}if(n.length>0){let e={...r,scanTypeIds:n,scans:(null==(s=r.scans)?void 0:s.filter(e=>n.includes(e.scanTypeId)))||[],appointmentId:`${r.appointmentId||"apt"}-regular`,splitReason:"booking-rule-regular"};e=o(e),a.push(e)}}else a.push(r);else a.push(r)}return a},f=(e,n)=>{if(!n||0===n.length)return e;let t=[...e];for(const s of n){const e=s.subServiceIds||[];if(!e||2!==e.length)continue;const[n,i]=e,a=t.findIndex(e=>e.scanTypeIds.includes(n)&&e.scanTypeIds.includes(i));if(-1!==a){const e=t[a],s=[n],i=e.scanTypeIds.filter(e=>e!==n);let r={...e,scanTypeIds:s,scans:e.scans.filter(e=>s.includes(e.scanTypeId)),appointmentId:`${e.appointmentId||"apt"}-psb-exc-a-${Date.now()}-${Math.floor(1e3*Math.random())}`,splitReason:"psb-exception",isPSBException:!0};r=o(r);let c={...e,scanTypeIds:i,scans:e.scans.filter(e=>i.includes(e.scanTypeId)),appointmentId:`${e.appointmentId||"apt"}-psb-exc-b-${Date.now()}-${Math.floor(1e3*Math.random())}`,splitReason:"psb-exception",isPSBException:!0};c=o(c),t.splice(a,1,r,c)}}return t},m=(e,n)=>{if(!n||0===n.length)return e;let t=[...e];for(const s of n){const e=s.combinations||[{firstScanId:s.leftScanId,secondScanId:s.rightScanId}];for(const n of e){if(!n.firstScanId||!n.secondScanId)continue;const e=t.find(e=>e.scanTypeIds.includes(n.firstScanId)),s=t.find(e=>e.scanTypeIds.includes(n.secondScanId)),i=t.findIndex(e=>e.scanTypeIds.includes(n.firstScanId)&&e.scanTypeIds.includes(n.secondScanId));if(-1!==i){const e=t[i],s=[n.firstScanId],a=e.scanTypeIds.filter(e=>e!==n.firstScanId);let r={...e,scanTypeIds:s,scans:e.scans.filter(e=>s.includes(e.scanTypeId)),appointmentId:`${e.appointmentId||"apt"}-sdcc-a-${Date.now()}-${Math.floor(1e3*Math.random())}`,splitReason:"separate-day-combination"};r=o(r);let c={...e,scanTypeIds:a,scans:e.scans.filter(e=>a.includes(e.scanTypeId)),appointmentId:`${e.appointmentId||"apt"}-sdcc-b-${Date.now()}-${Math.floor(1e3*Math.random())}`,splitReason:"separate-day-combination"};c=o(c),t.splice(i,1,r,c)}else e&&s&&e!==s&&(t=t.map(e=>e.scanTypeIds.includes(n.firstScanId)||e.scanTypeIds.includes(n.secondScanId)?{...e,splitReason:"separate-day-combination"}:e))}}return t},h=e=>{var n;const t=[],s=[...e],i=new Set;for(;s.length>0;){let e=!1;for(let a=s.length-1;a>=0;a--){const r=s[a];((null==(n=r.requiresAfter)?void 0:n.every(e=>i.has(e)))??!0)&&(t.push(r),i.add(r.appointmentId),s.splice(a,1),e=!0)}if(!e&&s.length>0){t.push(...s);break}}return t},y=(e,n,t,s)=>{const i=t[n];if(!(null==i?void 0:i.requiresAfter)||0===i.requiresAfter.length)return{isValid:!0};const a=(e,n)=>{const t="string"==typeof e?e.split("T")[0]:e,s=new Date(t);if(isNaN(s.getTime()))return new Date("invalid");const[i,a]=(n||"00:00").split(":").map(e=>parseInt(e,10));return s.setHours(i||0,a||0,0,0),s},r=a(e.date,e.startTime);for(const c of i.requiresAfter){const e=t.find(e=>e.appointmentId===c);if(!e)continue;const n=s.find(e=>{var n;return e&&void 0!==e.appointmentIndex&&(null==(n=t[e.appointmentIndex])?void 0:n.appointmentId)===c});if(!n)return{isValid:!1,error:`You must schedule the ${e.serviceName} appointment first.`};const o=a(n.date,n.endTime),l=i.minWaitMinutes||0;if(r<new Date(o.getTime()+60*l*1e3)){const n=Math.floor(l/60),t=l%60;return{isValid:!1,error:`This appointment must be scheduled at least ${n>0?`${n}h ${t}m`:`${t}m`} after the ${e.serviceName} appointment.`}}}return{isValid:!0}},I=(e,n)=>(null==e?void 0:e.requiresAfter)&&0!==e.requiresAfter.length?e.requiresAfter.map(t=>{const s=n.find(e=>e.appointmentId===t),i=e.minWaitMinutes||0,a=Math.floor(i/60),r=i%60,c=a>0?`${a}h ${r}m`:`${r}m`;return{serviceName:(null==s?void 0:s.serviceName)||"Previous appointment",waitTime:c,description:`Must be scheduled at least ${c} after ${(null==s?void 0:s.serviceName)||"previous appointment"}`}}):[],g=async(n,t)=>{try{const{fetchCalendarRules:i}=await e(async()=>{const{fetchCalendarRules:e}=await import("./calendarRulesService-tdjIi356.js");return{fetchCalendarRules:e}},[]),a=await i(t),r=d(a,n);let y;y=r?c(n):l(n);const I=[...new Set(n.map(e=>e.scanTypeId))];let g=[];try{const e=I.map(async e=>{try{const n=await fetch(`https://healthco.clinic/api/api/scantypes/${e}`);if(n.ok){const e=await n.json();return e.value||e}}catch(n){}return null});g=(await Promise.all(e)).filter(e=>null!==e)}catch(s){}y=u(y,g);const T=a.filter(e=>"PSB"===e.ruleCode&&e.isEnabled),S=[];for(const e of T)try{const n=e.configJson||e.config||"{}",t=JSON.parse(n);!0===t.isException&&!1!==t.enabled&&S.push(t)}catch(s){}S.length>0&&(y=f(y,S));const v=a.filter(e=>"SSO"===e.ruleCode&&e.isEnabled);let b=null;if(v.length>0){const e=[];for(const n of v)try{const t=n.configJson||n.config||"{}",s=JSON.parse(t);if(!(!1!==(void 0!==s.enabled?s.enabled:s.Enabled)))continue;const i=Array.isArray(s.rules)?s.rules:Array.isArray(s.Rules)?s.Rules:null;if(i&&i.length>0)for(const n of i){const t=n.primary??n.Primary,s=n.secondary??n.Secondary??[],i=n.minWait??n.MinWait??0;t&&Array.isArray(s)&&s.length>0&&e.push({primary:t,secondary:s,minWait:i})}else{const n=s.primary??s.Primary,t=s.secondary??s.Secondary??[],i=s.minWait??s.MinWait??0;n&&Array.isArray(t)&&t.length>0&&e.push({primary:n,secondary:t,minWait:i})}}catch(s){}e.length>0&&(b={enabled:!0,rules:e},y=p(y,b))}const $=a.filter(e=>"SDCC"===e.ruleCode&&e.isEnabled).map(e=>{const n=JSON.parse(e.configJson||"{}");return{...n,enabled:!1!==n.enabled}});return y=m(y,$),b&&(y=y.map((e,n)=>({...e,appointmentId:e.appointmentId||`apt-${n}`,requiresAfter:[],minWaitMinutes:0,schedulingOrder:0})),y=p(y,b)),y=h(y),y=y.map(e=>o(e)),y.forEach((e,n)=>{e.appointmentIndex=n,e.totalAppointments=y.length,e.isMultiAppointment=y.length>1}),y}catch(s){try{const{fetchCalendarRules:s}=await e(async()=>{const{fetchCalendarRules:e}=await import("./calendarRulesService-tdjIi356.js");return{fetchCalendarRules:e}},[]),i=await s(t);return d(i,n)?c(n):l(n)}catch(i){return l(n)}}},T=(e,n)=>{const t=[];e.forEach((e,n)=>{e.scanTypeIds&&0!==e.scanTypeIds.length||t.push(`Appointment ${n+1} has no scans assigned`)});return e.some(e=>e.requiresAfter&&e.requiresAfter.includes(e.appointmentIndex))&&t.push("Circular dependency detected in appointment scheduling order"),{isValid:0===t.length,errors:t,warnings:[],appointmentCount:e.length}},S=(e,n,t,s)=>{if(!e||!n||void 0===t||!s)return{isValid:!0};const i=s.rules||s||[],a=e[t];if(!a||!a.scanTypeIds)return{isValid:!0};const r=new Date(n),c=i.filter(e=>"SDCC"===e.ruleCode&&e.isEnabled);if(!c||0===c.length)return{isValid:!0};const o=[];for(const d of c)try{const e=JSON.parse(d.configJson||"{}");e.enabled&&o.push(e)}catch(l){}if(0===o.length)return{isValid:!0};for(let d=0;d<e.length;d++){if(d===t)continue;const n=e[d];if(!n||!n.selectedSlot||!n.scanTypeIds)continue;const s=new Date(n.selectedSlot.date);if(r.toDateString()===s.toDateString())for(const e of o){const t=e.leftScanId,s=e.rightScanId;if(!t||!s)continue;const i=a.scanTypeIds.includes(t),r=a.scanTypeIds.includes(s),c=n.scanTypeIds.includes(t),o=n.scanTypeIds.includes(s);if(i&&o||r&&c){const e=[];return i&&e.push(`Scan ${t}`),r&&e.push(`Scan ${s}`),{isValid:!1,error:`${e.join(" and ")} must be scheduled on separate days due to clinic policy. Please select a different date.`,violatingScans:[t,s],conflictingAppointmentIndex:d}}}}return{isValid:!0}};export{u as applyBookingRuleSplitting,f as applyPSBExceptionSplitting,m as applySeparateDayRules,p as applySequentialRequirements,i as fetchAndSetClinicTimezone,r as formatDateISO,I as getAppointmentDependencies,s as getClinicTimezoneOffset,a as getCurrentClinicTime,c as groupScansByService,l as groupScansIntoSingleAppointment,o as recalculateServiceName,t as setClinicTimezone,d as shouldSplitByServices,h as sortAppointmentsByDependencies,g as splitAppointments,T as validateAppointmentSplitting,S as validateSeparateDaySelection,y as validateSequentialSlotSelection};
