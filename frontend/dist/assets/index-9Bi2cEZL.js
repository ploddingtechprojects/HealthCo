import{c as e,a8 as a,f as s,g as r,av as i,_ as t,r as l,m as n,j as o,p as d,F as m,ac as u,aw as c,ax as x,y as p,P as h,T as b,ay as g,az as f,aA as j,af as N,ag as w,ah as v,ai as y,a3 as S,aB as A,aC as C,aj as E,ak as q,aD as F,V as I,X as L,al as G,am as P}from"./index-DyR0ftVW.js";import{M as T}from"./ManagementHeader-ym6m9w7H.js";const M=e().shape({firstName:s().min(2,"First name must be at least 2 characters").max(50,"First name must be at most 50 characters").required("First name is required"),lastName:s().min(2,"Last name must be at least 2 characters").max(50,"Last name must be at most 50 characters").required("Last name is required"),mobile:a({required:!0,requiredMessage:"Mobile number is required",invalidMessage:"Please enter a valid Canadian mobile number"})}),V=e().shape({userName:i({requiredMessage:"Username is required",invalidMessage:"Username can only contain letters and numbers"}),email:r({requiredMessage:"Email is required",invalidMessage:"Invalid email address"}),mobile:a({required:!0,requiredMessage:"Mobile number is required",invalidMessage:"Please enter a valid Canadian mobile number"}),firstName:s().min(2,"First name must be at least 2 characters").max(50,"First name must be at most 50 characters").required("First name is required"),lastName:s().min(2,"Last name must be at least 2 characters").max(50,"Last name must be at most 50 characters").required("Last name is required"),password:s().required("Password is required"),confirmPassword:s().oneOf([t("password"),null],"Passwords must match").required("Confirm password is required")}),B="https://healthco.clinic/api",z=()=>{const[e,a]=l.useState(!1),[s,r]=l.useState(null);return{updateGlobalAdmin:async(e,s)=>{var i,t,l,o;a(!0),r(null);try{const r=localStorage.getItem("token"),i={userId:e,firstName:s.firstName,lastName:s.lastName,phoneNumber:s.mobile||null,userState:void 0!==s.userState?s.userState:null},t=await n.put(`${B}/api/account/global-admins/${e}`,i,{headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`}});return a(!1),t.data}catch(d){const e=(null==(t=null==(i=d.response)?void 0:i.data)?void 0:t.message)||(null==(o=null==(l=d.response)?void 0:l.data)?void 0:o.title)||d.message||"Failed to update global admin";throw r(e),a(!1),new Error(e)}},isLoading:e,error:s}},W=l.forwardRef(({adminToEdit:e,isEditing:a,onAdminAdded:s,onFormStateChange:r},i)=>{const{createGlobalAdmin:t,isLoading:h}=(()=>{const[e,a]=l.useState(!1),[s,r]=l.useState(null);return{createGlobalAdmin:async e=>{var s,i,t,l,o,d;a(!0),r(null);try{const s=localStorage.getItem("token"),r={userName:e.userName,email:e.email,mobile:e.mobile||"",phoneNumber:e.mobile||"",firstName:e.firstName,lastName:e.lastName,password:e.password,base64Password:btoa(e.password),roleName:1,userState:0,userType:1},i=await n.post(`${B}/api/account/create`,r,{headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`}});return a(!1),i.data}catch(m){const e=(null==(i=null==(s=m.response)?void 0:s.data)?void 0:i.message)||(null==(l=null==(t=m.response)?void 0:t.data)?void 0:l.detail)||(null==(d=null==(o=m.response)?void 0:o.data)?void 0:d.title)||m.message||"Failed to create global admin";throw r(e),a(!1),new Error(e)}},isLoading:e,error:s}})(),{updateGlobalAdmin:b,isLoading:g}=z(),f=h||g,j=l.useRef(),[N,w]=l.useState(!1),[v,y]=l.useState(!1),S=a&&e?(A=e)?{userName:A.userName||"",email:A.email||"",mobile:A.phoneNumber||"",firstName:A.firstName||"",lastName:A.lastName||""}:{userName:"",email:"",mobile:"",firstName:"",lastName:""}:{userName:"",email:"",mobile:"",firstName:"",lastName:"",password:"",confirmPassword:""};var A;const C=a?M:V;return l.useImperativeHandle(i,()=>({submitForm:()=>{j.current&&j.current.submitForm()},resetForm:()=>{j.current&&j.current.resetForm()}})),o.jsx(d,{sx:{maxWidth:700,mx:"auto",width:"100%"},children:o.jsx(m,{innerRef:j,initialValues:S,validationSchema:C,onSubmit:async(r,{resetForm:i,setSubmitting:l})=>{try{if(a&&e){const a={firstName:r.firstName,lastName:r.lastName,mobile:r.mobile};await b(e.userId,a);p.success("Global admin updated successfully!")}else{const{confirmPassword:e,...a}=r;await t(a);p.success("Global admin created successfully!")}i(),s&&s()}catch(n){p.error(n.message||`Failed to ${a?"update":"create"} global admin`)}finally{l(!1)}},validateOnChange:!0,validateOnBlur:!0,enableReinitialize:!0,children:({values:e,errors:s,touched:i,handleChange:t,handleBlur:n,isSubmitting:m,isValid:p,dirty:h,setFieldValue:b})=>(l.useEffect(()=>{r&&r({isValid:p,isDirty:h,isSubmitting:m||f,isLoading:f,submitLabel:a?"Update Global Admin":"Create Global Admin"})},[p,h,m,f]),o.jsx("form",{noValidate:!0,children:o.jsxs(d,{sx:{display:"flex",flexDirection:"column",gap:2},children:[o.jsxs(d,{sx:{display:"flex",flexDirection:"row",flexWrap:"wrap",gap:2},children:[o.jsx(u,{label:"Username",name:"userName",placeholder:"Enter username",value:e.userName,onChange:t,onBlur:n,error:i.userName&&s.userName?s.userName:"",required:!0,disabled:a||m||f,sx:{flex:"1 1 200px",minWidth:{xs:"100%",sm:200}}}),o.jsx(u,{label:"Email",name:"email",type:"email",placeholder:"Enter email address",value:e.email,onChange:t,onBlur:n,error:i.email&&s.email?s.email:"",required:!0,disabled:a||m||f,sx:{flex:"1 1 200px",minWidth:{xs:"100%",sm:200}}}),o.jsx(u,{label:"Mobile",name:"mobile",placeholder:"Enter mobile number",value:e.mobile,onChange:t,onBlur:n,error:i.mobile&&s.mobile?s.mobile:"",required:!0,disabled:m||f,sx:{flex:"1 1 200px",minWidth:{xs:"100%",sm:200}}})]}),o.jsxs(d,{sx:{display:"flex",flexDirection:"row",flexWrap:"wrap",gap:2},children:[o.jsx(u,{label:"First Name",name:"firstName",placeholder:"Enter first name",value:e.firstName,onChange:t,onBlur:n,error:i.firstName&&s.firstName?s.firstName:"",required:!0,disabled:m||f,sx:{flex:"1 1 200px",minWidth:{xs:"100%",sm:200}}}),o.jsx(u,{label:"Last Name",name:"lastName",placeholder:"Enter last name",value:e.lastName,onChange:t,onBlur:n,error:i.lastName&&s.lastName?s.lastName:"",required:!0,disabled:m||f,sx:{flex:"1 1 200px",minWidth:{xs:"100%",sm:200}}})]}),!a&&o.jsxs(d,{sx:{display:"flex",flexDirection:"row",flexWrap:"wrap",gap:2},children:[o.jsxs(d,{sx:{flex:"1 1 200px",minWidth:{xs:"100%",sm:200},position:"relative"},children:[o.jsx(u,{label:"Password",name:"password",type:N?"text":"password",placeholder:"Enter password",value:e.password,onChange:t,onBlur:n,error:i.password&&s.password?s.password:"",required:!0,disabled:m||f,sx:{width:"100%","& input":{paddingRight:"40px"}}}),o.jsx(d,{onClick:()=>w(!N),sx:{position:"absolute",right:"12px",top:"35px",cursor:"pointer",display:"flex",alignItems:"center",color:"text.secondary","&:hover":{color:"primary.main"}},children:N?o.jsx(c,{size:20}):o.jsx(x,{size:20})})]}),o.jsxs(d,{sx:{flex:"1 1 200px",minWidth:{xs:"100%",sm:200},position:"relative"},children:[o.jsx(u,{label:"Confirm Password",name:"confirmPassword",type:v?"text":"password",placeholder:"Confirm password",value:e.confirmPassword,onChange:t,onBlur:n,error:i.confirmPassword&&s.confirmPassword?s.confirmPassword:"",required:!0,disabled:m||f,sx:{width:"100%","& input":{paddingRight:"40px"}}}),o.jsx(d,{onClick:()=>y(!v),sx:{position:"absolute",right:"12px",top:"35px",cursor:"pointer",display:"flex",alignItems:"center",color:"text.secondary","&:hover":{color:"primary.main"}},children:v?o.jsx(c,{size:20}):o.jsx(x,{size:20})})]})]})]})}))})})});W.displayName="GlobalAdminForm",W.propTypes={adminToEdit:h.object,isEditing:h.bool,onAdminAdded:h.func,onFormStateChange:h.func};const k=({refreshTrigger:e,onEdit:a})=>{const{globalAdmins:s,fetchGlobalAdmins:r,isLoading:i,error:t}=(()=>{const[e,a]=l.useState([]),[s,r]=l.useState(!1),[i,t]=l.useState(null);return{globalAdmins:e,fetchGlobalAdmins:async()=>{var e,s,i,l,o,d;r(!0),t(null);try{const e=localStorage.getItem("token"),s=await n.get(`${B}/api/account/users/filter?roleName=GlobalAdmin`,{headers:{Authorization:`Bearer ${e}`}});a(s.data),r(!1)}catch(m){const a=(null==(s=null==(e=m.response)?void 0:e.data)?void 0:s.detail)||(null==(l=null==(i=m.response)?void 0:i.data)?void 0:l.title)||(null==(d=null==(o=m.response)?void 0:o.data)?void 0:d.message)||m.message||"Failed to fetch global admins";t(a),r(!1)}},isLoading:s,error:i}})(),{updateGlobalAdmin:m}=z(),[u,c]=l.useState(null),x=localStorage.getItem("userId");l.useEffect(()=>{r()},[e]);if(i)return o.jsx(d,{sx:{p:3,textAlign:"center"},children:o.jsx(b,{children:"Loading global admins..."})});if(t){const e=t.includes("permission")||t.includes("Permission");return o.jsxs(d,{sx:{p:3,textAlign:"center"},children:[o.jsx(b,{color:"error",sx:{mb:1},children:e?"Access Denied":"Error"}),o.jsx(b,{color:"text.secondary",variant:"body2",children:t}),e&&o.jsx(b,{color:"text.secondary",variant:"body2",sx:{mt:2},children:'Only users with "users.view" permission can access this page. Please contact your administrator.'})]})}return s&&0!==s.length?o.jsx(g,{component:f,children:o.jsxs(j,{children:[o.jsx(N,{children:o.jsxs(w,{children:[o.jsx(v,{children:"Username"}),o.jsx(v,{children:"Full Name"}),o.jsx(v,{children:"Email"}),o.jsx(v,{children:"Phone Number"}),o.jsx(v,{children:"Status"}),o.jsx(v,{align:"center",children:"Active"}),o.jsx(v,{align:"center",children:"Actions"})]})}),o.jsx(y,{children:s.map(e=>{const s=String(e.userId||"")===x;return o.jsxs(w,{hover:!0,onClick:()=>a&&a(e),sx:{cursor:"pointer"},children:[o.jsx(v,{children:e.userName}),o.jsx(v,{children:e.fullName||"-"}),o.jsx(v,{children:e.email}),o.jsx(v,{children:e.phoneNumber||"-"}),o.jsx(v,{children:o.jsx(S,{label:A[e.userState]||e.userStateName||"Unknown",color:e.userState===C.ACTIVE?"success":"default",size:"small"})}),o.jsx(v,{align:"center",children:o.jsx(E,{size:"small",checked:e.userState===C.ACTIVE,onChange:()=>(async e=>{try{c(e.userId);const a=e.userState===C.ACTIVE?C.INACTIVE:C.ACTIVE,s={firstName:e.firstName||"Admin",lastName:e.lastName||"",mobile:e.phoneNumber||"",userState:a};await m(e.userId,s),p.success(`Global admin ${a===C.ACTIVE?"activated":"deactivated"} successfully!`),r()}catch(a){p.error(a.message||"Failed to update global admin status")}finally{c(null)}})(e),onClick:e=>e.stopPropagation(),disabled:s||u===e.userId})}),o.jsx(v,{align:"center",children:o.jsx(q,{size:"small",color:"primary",onClick:s=>{s.stopPropagation(),a&&a(e)},children:o.jsx(F,{fontSize:"small"})})})]},e.userId)})})]})}):o.jsx(d,{sx:{p:3,textAlign:"center"},children:o.jsx(b,{color:"text.secondary",children:"No global admins found."})})};k.propTypes={refreshTrigger:h.number,onEdit:h.func};const D=()=>{const[e,a]=l.useState(0),[s,r]=l.useState(!1),[i,t]=l.useState(null),[n,m]=l.useState(!1),[u,c]=l.useState({isValid:!1,isDirty:!1,isSubmitting:!1,isLoading:!1,submitLabel:"Create Global Admin"}),x=l.useRef(),p=I(),h=L(p.breakpoints.down("sm"));return o.jsxs(d,{children:[o.jsx(T,{icon:G.GlobalAdmins,title:"Global Admin Management",description:"Manage global administrators who have full access to the system",addButtonLabel:"Create Global Admin",onAdd:()=>{t(null),m(!1),r(!0)},hideClinicDropdown:!0}),o.jsx(d,{sx:{mt:3},children:o.jsx(k,{refreshTrigger:e,onEdit:e=>{t(e),m(!0),r(!0)}})}),o.jsx(P,{open:s,onClose:()=>{r(!1),t(null),m(!1),c({isValid:!1,isDirty:!1,isSubmitting:!1,isLoading:!1,submitLabel:"Create Global Admin"})},onSubmit:()=>{x.current&&x.current.submitForm()},title:n?"Edit Global Admin":"Create Global Admin",submitLabel:u.submitLabel,isSubmitDisabled:!u.isValid||!u.isDirty||u.isSubmitting,isSubmitting:u.isSubmitting,maxWidth:"sm",...h?{}:{customWidth:"700px"},showActions:!0,children:o.jsx(W,{ref:x,adminToEdit:i,isEditing:n,onAdminAdded:()=>{a(e=>e+1),r(!1)},onFormStateChange:e=>{c(e)}})})]})};export{D as default};
